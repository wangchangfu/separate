// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.10/js/esri/copyright.txt for details.
//>>built
define("esri/PopupManager","./geometry/Extent ./geometry/ScreenPoint ./kernel ./layerUtils ./tasks/query dijit/registry dojo/_base/array dojo/_base/declare dojo/_base/Deferred dojo/_base/lang dojo/has dojo/on dojo/promise/all dojo/Stateful require".split(" "),function(E,x,F,D,G,H,e,r,u,v,I,J,K,L,M){var y;r=r(L,{declaredClass:"esri.PopupManager",enabled:!1,map:null,_mapClickHandle:null,_featureLayersCache:{},constructor:function(a){this._mapClickHandler=v.hitch(this,this._mapClickHandler)},setMap:function(a){if(this.map)if(a!==
this.map)this.unsetMap();else return;this.map=a;this._setupClickHandler()},unsetMap:function(){this.map&&(this.map=null);this._mapClickHandle&&(this._mapClickHandle.remove(),this._mapClickHandle=null)},getMapLayer:function(a){var b;if(a&&(b=a.getLayer()))if(a=b.id,this._featureLayersCache[a]){var c=a.lastIndexOf("_");-1<c&&(a=a.substring(0,c),b=this.map.getLayer(a))}return b},_enabledSetter:function(a){this.enabled=a;this._setupClickHandler()},_setupClickHandler:function(){this._mapClickHandle&&(this._mapClickHandle.remove(),
this._mapClickHandle=null);this.enabled&&this.map&&(this._mapClickHandle=this.map.on("click",this._mapClickHandler))},_mapClickHandler:function(a){var b=this.map.infoWindow,c=a.graphic;b&&this.map.loaded&&(b.clearFeatures&&b.setFeatures?this._showPopup(a):c&&c.getInfoTemplate()&&this._showInfoWindow(c,a.mapPoint))},_showPopup:function(a){var b=this.map,c=b.infoWindow,f=this,g=[],s=[b.graphics].concat(e.map(b.graphicsLayerIds,b.getLayer,b));e.forEach(s,function(a){a&&(a.loaded&&a.infoTemplate&&!a.suspended)&&
g.push(a)});var n=[];e.forEach(b.layerIds,function(a){(a=b.getLayer(a))&&(a.loaded&&!a.suspended)&&("esri.layers.ArcGISImageServiceLayer"===a.declaredClass&&a.infoTemplate?g.push(a):("esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass||"esri.layers.ArcGISTiledMapServiceLayer"===a.declaredClass)&&a.infoTemplates&&n.push(a))});this._getSubLayerFeatureLayers(n).then(function(l){g=g.concat(l);l=null;a.graphic&&a.graphic.getInfoTemplate()&&(l=a.graphic);if(g.length||l){var k=f._calculateClickTolerance(g),
s=a.screenPoint,d=b.toMap(new x(s.x-k,s.y+k)),k=b.toMap(new x(s.x+k,s.y-k)),t=new E(d.x,d.y,k.x,k.y,b.spatialReference),m=new G,p=!!l,n=!0,d=e.map(g,function(c){var d;m.timeExtent=c.useMapTime?b.timeExtent:null;if("esri.layers.ArcGISImageServiceLayer"===c.declaredClass)m.geometry=a.mapPoint,n=!1,d=c.queryVisibleRasters(m,{rasterAttributeTableFieldPrefix:"Raster.",returnDomainValues:!0}),d.addCallback(function(){var a=c.getVisibleRasters();p=p||0<a.length;return a});else if(f._featureLayersCache[c.id]||
"function"===typeof c.queryFeatures&&2!==c.mode)m.geometry=t,d=c.queryFeatures(m),d.addCallback(function(a){a=a.features;p=p||0<a.length;return a});else{d=new u;var g=e.filter(c.graphics,function(a){return a&&t.intersects(a.geometry)});p=p||0<g.length;d.resolve(g)}return d});l&&(k=new u,k.resolve([l]),d.unshift(k));!e.some(d,function(a){return!a.isFulfilled()})&&!p?(c.hide(),c.clearFeatures()):(c.setFeatures(d),c.show(a.mapPoint,{closestFirst:n}))}})},_getSubLayerFeatureLayers:function(a,b){var c=
b||new u,f=[],g=a.length,s=Math.floor(this.map.extent.getWidth()/this.map.width),n=this.map.getScale(),l=!1,k=this,r=0;a:for(;r<g;r++){var d=a[r],t=d.dynamicLayerInfos||d.layerInfos;if(t){var m=null;if(d._params&&(d._params.layers||d._params.dynamicLayers))m=d.visibleLayers;for(var m=D._getVisibleLayers(t,m),p=D._getLayersForScale(n,t),x=t.length,A=0;A<x;A++){var z=t[A],q=z.id,w=d.infoTemplates[q];if(!z.subLayerIds&&w&&w.infoTemplate&&-1<e.indexOf(m,q)&&-1<e.indexOf(p,q)){if(!y){l=!0;break a}var B=
d.id+"_"+q,h=this._featureLayersCache[B];if(!h||!h.loadError)h||((h=w.layerUrl)||(h=z.source?this._getLayerUrl(d.url,"/dynamicLayer"):this._getLayerUrl(d.url,q)),h=new y(h,{id:B,drawMode:!1,mode:y.MODE_SELECTION,outFields:["*"],resourceInfo:w.resourceInfo,source:z.source}),this._featureLayersCache[B]=h),h.setDefinitionExpression(d.layerDefinitions&&d.layerDefinitions[q]),h.setGDBVersion(d.gdbVersion),h.setInfoTemplate(w.infoTemplate),h.setMaxAllowableOffset(s),h.setUseMapTime(!!d.useMapTime),d.layerDrawingOptions&&
(d.layerDrawingOptions[q]&&d.layerDrawingOptions[q].renderer)&&h.setRenderer(d.layerDrawingOptions[q].renderer),f.push(h)}}}}if(l){var v=new u;M(["./layers/FeatureLayer"],function(a){y=a;v.resolve()});v.then(function(){k._getSubLayerFeatureLayers(a,c)})}else{var C=[];e.forEach(f,function(a){if(!a.loaded){var c=new u;J.once(a,"load, error",function(){c.resolve()});C.push(c.promise)}});C.length?K(C).then(function(){f=e.filter(f,function(a){return!a.loadError&&a.isVisibleAtScale(n)});c.resolve(f)}):
(f=e.filter(f,function(a){return a.isVisibleAtScale(n)}),c.resolve(f))}return c.promise},_getLayerUrl:function(a,b){var c=a.indexOf("?");return-1===c?a+"/"+b:a.substring(0,c)+"/"+b+a.substring(c)},_calculateClickTolerance:function(a){var b=6;e.forEach(a,function(a){if(a=a.renderer)"esri.renderer.SimpleRenderer"===a.declaredClass?((a=a.symbol)&&a.xoffset&&(b=Math.max(b,Math.abs(a.xoffset))),a&&a.yoffset&&(b=Math.max(b,Math.abs(a.yoffset)))):("esri.renderer.UniqueValueRenderer"===a.declaredClass||"esri.renderer.ClassBreaksRenderer"===
a.declaredClass)&&e.forEach(a.infos,function(a){(a=a.symbol)&&a.xoffset&&(b=Math.max(b,Math.abs(a.xoffset)));a&&a.yoffset&&(b=Math.max(b,Math.abs(a.yoffset)))})});return b},_showInfoWindow:function(a,b){var c=this.map.infoWindow,f=a.geometry,f=f&&"point"===f.type?f:b,g=a.getContent();c.setTitle(a.getTitle());if(g&&v.isString(g.id)){var e=H.byId(g.id);e&&(e.set&&/_PopupRenderer/.test(e.declaredClass))&&e.set("showTitle",!1)}c.setContent(g);c.show(f)}});I("extend-esri")&&(F.PopupManager=r);return r});