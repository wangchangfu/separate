// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.10/js/esri/copyright.txt for details.
//>>built
define("esri/arcgis/csv","dojo/_base/lang dojo/_base/array dojo/_base/Deferred dojo/sniff dojo/number dojox/data/CsvStore ../kernel ../config ../request ../SpatialReference ../geometry/Geometry ../geometry/jsonUtils ../geometry/webMercatorUtils".split(" "),function(h,e,y,z,K,L,M,A,N,q,t,B,C){function D(b){var c=0,d="";e.forEach([","," ",";","|","\t"],function(f){var e=b.split(f).length;e>c&&(c=e,d=f)});return d}function E(b,c){if(!b||"[object Date]"!==Object.prototype.toString.call(b)||isNaN(b.getTime()))return!1;
var d=!0;if(z("chrome")&&/\d+\W*$/.test(c)){var f=c.match(/[a-zA-Z]{2,}/);if(f){for(var d=!1,e=0,l=f.length,u=/^((jan(uary)?)|(feb(ruary)?)|(mar(ch)?)|(apr(il)?)|(may)|(jun(e)?)|(jul(y)?)|(aug(ust)?)|(sep(tember)?)|(oct(ober)?)|(nov(ember)?)|(dec(ember)?)|(am)|(pm)|(gmt)|(utc))$/i;!d&&e<=l&&!(d=!u.test(f[e]));)e++;d=!d}}return d}function F(b,c,d){var f=b.indexOf("\n"),f=h.trim(b.substr(0,f)),g=c.columnDelimiter;g||(g=D(f));var l=new L({data:b,separator:g});l.fetch({onComplete:function(b,f){var a=
0,g={layerDefinition:c.layerDefinition,featureSet:{features:[],geometryType:"esriGeometryPoint"}},x=g.layerDefinition.objectIdField;!x&&!e.some(g.layerDefinition.fields,function(a){return"esriFieldTypeOID"==a.type?(x=a.name,!0):!1})&&(g.layerDefinition.fields.push({name:"__OBJECTID",alias:"__OBJECTID",type:"esriFieldTypeOID",editable:!1,domain:null}),x="__OBJECTID");var h,n,r=l._attributes,q=[],s=[];e.forEach(g.layerDefinition.fields,function(a,b){"esriFieldTypeDate"===a.type?q.push(a.name):("esriFieldTypeDouble"===
a.type||"esriFieldTypeInteger"===a.type)&&s.push(a.name)});c.locationInfo&&"coordinates"===c.locationInfo.locationType?(h=c.locationInfo.latitudeFieldName,n=c.locationInfo.longitudeFieldName):e.forEach(r,function(a){var b;b=e.indexOf(G,a.toLowerCase());-1!==b&&(h=a);b=e.indexOf(H,a.toLowerCase());-1!==b&&(n=a)},this);if(!h||!n)setTimeout(function(){console.error("File does not seem to contain fields with point coordinates.")},1),d&&d(null,Error("File does not seem to contain fields with point coordinates."));
else{-1===e.indexOf(s,h)&&s.push(h);-1===e.indexOf(s,n)&&s.push(n);var r=0,t=b.length;for(r;r<t;r++){var v=b[r],w=l.getAttributes(v),m={};e.forEach(w,function(a,b){if(a){var c=a;0===a.length&&e.forEach(g.layerDefinition.fields,function(b,c){b.name==="attribute_"+(c-1)&&(a="attribute_"+(c-1))});if(-1<e.indexOf(q,a)){var c=l.getValue(v,c),d=new Date(c);m[a]=E(d,c)?d.getTime():null}else if(-1<e.indexOf(s,a)){d=K.parse(l.getValue(v,c));if((a==h||a==n)&&(isNaN(d)||181<Math.abs(d)))d=parseFloat(l.getValue(v,
c));isNaN(d)?m[a]=null:m[a]=d}else m[a]=l.getValue(v,c)}});m[x]=a;a++;var w=m[h],p=m[n];null==p||(null==w||isNaN(w)||isNaN(p))||g.featureSet.features.push({geometry:{x:p,y:w,spatialReference:{wkid:4326}},attributes:m})}g.layerDefinition.name="csv";d&&d(g)}},onError:function(b){console.error("Error fetching items from CSV store: ",b);d&&d(null,b)}});return!0}function p(b,c,d,f,g,l){0===b.length&&g(null);var u=B.getGeometryType(c),k=[];e.forEach(b,function(a){a=new u(a);a.spatialReference=d;k.push(a)},
this);c=[102113,102100,3857];d.wkid&&4326===d.wkid&&f.wkid&&-1<e.indexOf(c,f.wkid)?(e.forEach(k,function(a){a.xmin?(a.xmin=Math.max(a.xmin,-180),a.xmax=Math.min(a.xmax,180),a.ymin=Math.max(a.ymin,-89.99),a.ymax=Math.min(a.ymax,89.99)):a.rings?e.forEach(a.rings,function(a){e.forEach(a,function(a){a[0]=Math.min(Math.max(a[0],-180),180);a[1]=Math.min(Math.max(a[1],-89.99),89.99)},this)},this):a.paths?e.forEach(a.paths,function(a){e.forEach(a,function(a){a[0]=Math.min(Math.max(a[0],-180),180);a[1]=Math.min(Math.max(a[1],
-89.99),89.99)},this)},this):a.x&&(a.x=Math.min(Math.max(a.x,-180),180),a.y=Math.min(Math.max(a.y,-89.99),89.99))},this),b=[],e.forEach(k,function(a){a=C.geographicToWebMercator(a);102100!==f.wkid&&(a.spatialReference=f);b.push(a.toJson())},this),g(b)):null!==d.wkid&&-1<e.indexOf(c,d.wkid)&&null!==f.wkid&&4326===f.wkid?(b=[],e.forEach(k,function(a){b.push(C.webMercatorToGeographic(a).toJson())},this),g(b)):(c=function(a,c){a&&a.length===b.length?(b=[],e.forEach(a,function(a){a&&(a.rings&&0<a.rings.length&&
0<a.rings[0].length&&0<a.rings[0][0].length&&!isNaN(a.rings[0][0][0])&&!isNaN(a.rings[0][0][1])||a.paths&&0<a.paths.length&&0<a.paths[0].length&&0<a.paths[0][0].length&&!isNaN(a.paths[0][0][0])&&!isNaN(a.paths[0][0][1])||a.xmin&&!isNaN(a.xmin)&&a.ymin&&!isNaN(a.ymin)||a.x&&!isNaN(a.x)&&a.y&&!isNaN(a.y))?b.push(a.toJson()):b.push(null)},this),g(b)):l(a,c)},A.defaults.geometryService?A.defaults.geometryService.project(k,f,h.hitch(this,c),l):g(null))}function I(b,c){var d=[102113,102100,3857];return b&&
c&&b.wkid===c.wkid&&b.wkt===c.wkt||b&&c&&b.wkid&&c.wkid&&-1<e.indexOf(d,b.wkid)&&-1<e.indexOf(d,c.wkid)?!0:!1}function J(b,c,d,f){if(b.featureSet&&0!==b.featureSet.features.length)if(I(d,c))f(b);else{var g=function(a){var c=[];e.forEach(b.featureSet.features,function(b,d){a[d]&&(b.geometry=a[d],c.push(b))},this);f(b)},l=function(a,c){console.error("error projecting featureSet ("+b.layerDefinition.name+"). Final try.");f(b)},u=function(a,f){console.error("error projecting featureSet ("+b.layerDefinition.name+
"). Try one more time.");p(k,b.featureSet.geometryType,c,d,h.hitch(this,g),h.hitch(this,l))};if(b.featureSet.features&&0<b.featureSet.features.length){var k=[];e.forEach(b.featureSet.features,function(a){if(a.geometry.toJson)k.push(a.geometry);else{var c=B.getGeometryType(b.featureSet.geometryType);k.push(new c(a.geometry))}});c.toJson||(c=new q(c));d.toJson||(d=new q(d));p(k,b.featureSet.geometryType,c,d,h.hitch(this,g),h.hitch(this,u))}else f(b)}}var G="lat latitude y ycenter latitude83 latdecdeg POINT-Y".split(" "),
H="lon lng long longitude x xcenter longitude83 longdecdeg POINT-X".split(" ");t={latFieldStrings:G,longFieldStrings:H,buildCSVFeatureCollection:function(b){var c=new y,d=function(b,d){d?c.errback(d):c.callback(b)};N({url:b.url,handleAs:"text",load:function(c){F(c,b,h.hitch(this,d))},error:function(b){c.errback(b);console.error("error: "+b)}},{usePost:!1});return c},projectFeatureCollection:function(b,c,d){var e=new y;d||(d=new q({wkid:4326}));J(b,d,c,h.hitch(this,function(b){e.callback(b)}));return e},
generateDefaultPopupInfo:function(b){var c={esriFieldTypeDouble:1,esriFieldTypeSingle:1},d={esriFieldTypeInteger:1,esriFieldTypeSmallInteger:1},f={esriFieldTypeDate:1},g=null;b=e.map(b.layerDefinition.fields,h.hitch(this,function(b){"NAME"===b.name.toUpperCase()&&(g=b.name);var e="esriFieldTypeOID"!==b.type&&"esriFieldTypeGlobalID"!==b.type&&"esriFieldTypeGeometry"!==b.type,k=null;if(e){var a=b.name.toLowerCase();if(-1<",stretched value,fnode_,tnode_,lpoly_,rpoly_,poly_,subclass,subclass_,rings_ok,rings_nok,".indexOf(","+
a+",")||-1<a.indexOf("area")||-1<a.indexOf("length")||-1<a.indexOf("shape")||-1<a.indexOf("perimeter")||-1<a.indexOf("objectid")||a.indexOf("_")===a.length-1||a.indexOf("_i")===a.length-2&&1<a.length)e=!1;b.type in d?k={places:0,digitSeparator:!0}:b.type in c?k={places:2,digitSeparator:!0}:b.type in f&&(k={dateFormat:"shortDateShortTime"})}return h.mixin({},{fieldName:b.name,label:b.alias,isEditable:!0,tooltip:"",visible:e,format:k,stringFieldOption:"textbox"})}));return{title:g?"{"+g+"}":"",fieldInfos:b,
description:null,showAttachments:!1,mediaInfos:[]}},_getSeparator:D,_isValidDate:E,_processCsvData:F,_projectGeometries:p,_sameSpatialReference:I,_projectFeatureSet:J};z("extend-esri")&&h.setObject("arcgis.csv",t,M);return t});