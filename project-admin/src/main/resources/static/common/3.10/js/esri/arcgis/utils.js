// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.10/js/esri/copyright.txt for details.
//>>built
require({cache:{"esri/layers/FeatureEditResult":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/has","../kernel"],function(q,p,n,r){q=q(null,{declaredClass:"esri.layers.FeatureEditResult",constructor:function(l){l&&p.isObject(l)&&(this.objectId=l.objectId,this.success=l.success,l.success||(l=l.error,this.error=Error(),this.error.code=l.code,this.error.message=l.description))}});n("extend-esri")&&p.setObject("layers.FeatureEditResult",q,r);return q})},"esri/layers/MapImageLayer":function(){define("dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/dom-construct dojo/dom-style ../kernel ../config ../sniff ../domUtils ../geometry/Point ../geometry/webMercatorUtils ./layer".split(" "),
function(q,p,n,r,l,m,f,s,c,g,e,h,k){var a=q([k],{declaredClass:"esri.layers.MapImageLayer","-chains-":{constructor:"manual"},constructor:function(d){this.inherited(arguments,[null,d]);this._mapImages=[];var b=n.hitch;this._panStart=b(this,this._panStart);this._pan=b(this,this._pan);this._extentChange=b(this,this._extentChange);this._zoom=b(this,this._zoom);this._zoomStart=b(this,this._zoomStart);this._scale=b(this,this._scale);this._resize=b(this,this._resize);p.connect(this,"onSuspend",this,this._onSuspend);
p.connect(this,"onResume",this,this._onResume);this.loaded=!0;this.onLoad(this)},opacity:1,_transform:f._getDOMAccessor("transform"),addImage:function(d){var b=this._mapImages.push(d),b=b-1;d._idx=b;d._layer=this;this._div&&this._createImage(d,b)},removeImage:function(d){if(d){var b=d._idx,t=this._mapImages;if(t[b]===d){delete t[b];if(b=d._node)this._clearEvents(b),b.e_idx=b.e_bl=b.e_tr=b.e_l=b.e_t=b.e_w=b.e_h=null,b.parentNode&&(b.parentNode.removeChild(b),l.destroy(b));d._node=d._idx=d._layer=null}}},
removeAllImages:function(){var d=this._mapImages,b,t=d.length;for(b=0;b<t;b++){var a=d[b];a&&this.removeImage(a)}this._mapImages=[]},getImages:function(){var d=this._mapImages,b=[],t,a=d.length;for(t=0;t<a;t++)d[t]&&b.push(d[t]);return b},setOpacity:function(d){this.opacity!=d&&(this._opacityChanged(this.opacity=d),this.onOpacityChange())},onOpacityChange:function(){},_opacityChanged:function(d){var b=this._div,t,a;if(b)if(!c("ie")||8<c("ie"))m.set(b,"opacity",d);else{a=b.childNodes;t=a.length;for(b=
0;b<t;b++)m.set(a[b],"opacity",d)}},_createImage:function(d,b){var t=l.create("img");m.set(t,{position:"absolute"});8>=c("ie")&&m.set(t,"opacity",this.opacity);if(d.rotation){var e="rotate("+(360-d.rotation)+"deg)";9>c("ie")||(m.set(t,this._transform,e),m.set(t,"transform",e))}d._node=t;t.e_idx=b;t.e_layer=this;t.e_load=p.connect(t,"onload",a.prototype._imageLoaded);t.e_error=p.connect(t,"onerror",a.prototype._imageError);t.e_abort=p.connect(t,"onabort",a.prototype._imageError);t.src=d.href},_imageLoaded:function(d,
b){var t=b||d.target||d.currentTarget,a=t.e_layer,e=a._mapImages[t.e_idx],c=a._map;c&&(c.__zooming||c.__panning||!a._sr)?a._standby.push(t):(a._clearEvents(t),e&&e._node===t&&c&&a._attach(e))},_imageError:function(d){d=d.target||d.currentTarget;var b=d.e_layer,a=b._mapImages[d.e_idx];b._clearEvents(d);a&&(a._node=null)},_clearEvents:function(d){var b=p.disconnect;b(d.e_load);b(d.e_error);b(d.e_abort);d.e_load=d.e_error=d.e_abort=d.e_layer=null},_attach:function(d){var b=d.extent,a=b.spatialReference,
c=this._sr,k=this._div,g=d._node,f=new e({x:b.xmin,y:b.ymin,spatialReference:a}),b=new e({x:b.xmax,y:b.ymax,spatialReference:a});c.equals(a)||(c.isWebMercator()&&4326===a.wkid?(f=h.geographicToWebMercator(f),b=h.geographicToWebMercator(b)):a.isWebMercator()&&4326===c.wkid&&(f=h.webMercatorToGeographic(f),b=h.webMercatorToGeographic(b)));g.e_bl=f;g.e_tr=b;d.visible&&(this._setPos(g,k._left,k._top),(this._active||k).appendChild(g))},_setPos:function(d,b,a){var c=d.e_bl,e=d.e_tr,k=this._map,c=k.toScreen(c),
e=k.toScreen(e);b=c.x-b;a=e.y-a;var h=Math.abs(e.x-c.x),c=Math.abs(c.y-e.y),e={width:h+"px",height:c+"px"},g=this._mapImages[d.e_idx];"css-transforms"===k.navigationMode?e[f._css.names.transform]=f._css.translate(b,a)+(g.rotation?" "+f._css.rotate(360-g.rotation):""):(e.left=b+"px",e.top=a+"px");m.set(d,e);d.e_l=b;d.e_t=a;d.e_w=h;d.e_h=c},managedSuspension:!0,_setMap:function(d,b){this.inherited(arguments);var a=this._div=l.create("div",null,b),e=f._css.names,k={position:"absolute"},h=d.__visibleDelta;
if(!c("ie")||8<c("ie"))k.opacity=this.opacity;"css-transforms"===d.navigationMode?(k[e.transform]=f._css.translate(h.x,h.y),m.set(a,k),a._left=h.x,a._top=h.y,k={position:"absolute",width:d.width+"px",height:d.height+"px",overflow:"visible"},this._active=l.create("div",null,a),m.set(this._active,k),this._passive=l.create("div",null,a),m.set(this._passive,k)):(a._left=0,a._top=0,m.set(a,k));this._standby=[];e=this._mapImages;h=e.length;for(k=0;k<h;k++){var s=e[k];s._node||this._createImage(s,s._idx)}g.hide(a);
return a},_unsetMap:function(d,b){this._disconnect();var a=this._div;if(a){var e=this._mapImages,c,k=e.length;for(c=0;c<k;c++){var h=e[c];if(h){var g=h._node;g&&(this._clearEvents(g),g.e_idx=g.e_bl=g.e_tr=g.e_l=g.e_t=g.e_w=g.e_h=null);h._node=null}}b.removeChild(a);l.destroy(a)}this._map=this._div=this._sr=this._active=this._passive=this._standby=null;this.inherited(arguments)},_onSuspend:function(){this._disconnect();g.hide(this._div)},_onResume:function(d){d.firstOccurrence&&(this._sr=this._map.spatialReference,
this._processStandbyList());d=this._map;var b=this._div,a=d.__visibleDelta;"css-transforms"===d.navigationMode&&(b._left=a.x,b._top=a.y,m.set(b,f._css.names.transform,f._css.translate(b._left,b._top)));this._redraw("css-transforms"===d.navigationMode);this._connect(d);g.show(b)},_connect:function(d){if(!this._connections){var b=p.connect,a="css-transforms"===d.navigationMode;this._connections=[b(d,"onPanStart",this._panStart),b(d,"onPan",this._pan),b(d,"onExtentChange",this._extentChange),a&&b(d,
"onZoomStart",this._zoomStart),a?b(d,"onScale",this._scale):b(d,"onZoom",this._zoom),a&&b(d,"onResize",this._resize)]}},_disconnect:function(){this._connections&&(r.forEach(this._connections,p.disconnect),this._connections=null)},_panStart:function(){this._panL=this._div._left;this._panT=this._div._top},_pan:function(d,b){var a=this._div;a._left=this._panL+b.x;a._top=this._panT+b.y;"css-transforms"===this._map.navigationMode?m.set(a,f._css.names.transform,f._css.translate(a._left,a._top)):m.set(a,
{left:a._left+"px",top:a._top+"px"})},_extentChange:function(d,b,a){a?this._redraw("css-transforms"===this._map.navigationMode):b&&this._pan(d,b);this._processStandbyList()},_processStandbyList:function(){var d,b=this._standby;if(b&&b.length)for(d=b.length-1;0<=d;d--)this._imageLoaded(null,b[d]),b.splice(d,1)},_redraw:function(d){if(d){d=this._passive;var b=f._css.names;m.set(d,b.transition,"none");this._moveImages(d,this._active);m.set(d,b.transform,"none")}d=this._active||this._div;var b=this._div._left,
a=this._div._top,e,c=d.childNodes.length,k;for(e=0;e<c;e++)k=d.childNodes[e],this._setPos(k,b,a)},_zoom:function(d,b,a){d=this._div;var e=d._left,c=d._top,k,h=d.childNodes.length,g;for(k=0;k<h;k++){g=d.childNodes[k];var f=g.e_w*b,A=g.e_h*b,l=(a.x-e-g.e_l)*(f-g.e_w)/g.e_w,s=(a.y-c-g.e_t)*(A-g.e_h)/g.e_h,l=isNaN(l)?0:l,s=isNaN(s)?0:s;m.set(g,{left:g.e_l-l+"px",top:g.e_t-s+"px",width:f+"px",height:A+"px"})}},_zoomStart:function(){this._moveImages(this._active,this._passive)},_moveImages:function(d,b){var a=
d.childNodes,e;e=a.length;if(0<e)for(e-=1;0<=e;e--)b.appendChild(a[e])},_scale:function(a,b){var e=f._css.names,c=this._passive;m.set(c,e.transition,b?"none":e.transformName+" "+s.defaults.map.zoomDuration+"ms ease");f._css.matrix(a);m.set(c,e.transform,f._css.matrix(a))},_resize:function(a,b,e){m.set(this._active,{width:b+"px",height:e+"px"});m.set(this._passive,{width:b+"px",height:e+"px"})}});c("extend-esri")&&n.setObject("layers.MapImageLayer",a,f);return a})},"esri/layers/WebTiledLayer":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/url dojo/has dojo/string ../kernel ../urlUtils ../SpatialReference ../geometry/Extent ./TiledMapServiceLayer ./TileInfo".split(" "),
function(q,p,n,r,l,m,f,s,c,g,e,h){q=q(e,{declaredClass:"esri.layers.WebTiledLayer",constructor:function(e,a){a||(a={});this.urlTemplate=e;var d=new g(-2.0037508342787E7,-2.003750834278E7,2.003750834278E7,2.0037508342787E7,new c({wkid:102100})),b=new g(-2.0037508342787E7,-2.003750834278E7,2.003750834278E7,2.0037508342787E7,new c({wkid:102100}));this.initialExtent=a.initialExtent||d;this.fullExtent=a.fullExtent||b;this.tileInfo=a.tileInfo?a.tileInfo:new h({rows:256,cols:256,origin:{x:-2.0037508342787E7,
y:2.0037508342787E7},spatialReference:{wkid:102100},lods:[{level:0,resolution:156543.033928,scale:5.91657527591555E8},{level:1,resolution:78271.5169639999,scale:2.95828763795777E8},{level:2,resolution:39135.7584820001,scale:1.47914381897889E8},{level:3,resolution:19567.8792409999,scale:7.3957190948944E7},{level:4,resolution:9783.93962049996,scale:3.6978595474472E7},{level:5,resolution:4891.96981024998,scale:1.8489297737236E7},{level:6,resolution:2445.98490512499,scale:9244648.868618},{level:7,resolution:1222.99245256249,
scale:4622324.434309},{level:8,resolution:611.49622628138,scale:2311162.217155},{level:9,resolution:305.748113140558,scale:1155581.108577},{level:10,resolution:152.874056570411,scale:577790.554289},{level:11,resolution:76.4370282850732,scale:288895.277144},{level:12,resolution:38.2185141425366,scale:144447.638572},{level:13,resolution:19.1092570712683,scale:72223.819286},{level:14,resolution:9.55462853563415,scale:36111.909643},{level:15,resolution:4.77731426794937,scale:18055.954822},{level:16,resolution:2.38865713397468,
scale:9027.977411},{level:17,resolution:1.19432856685505,scale:4513.988705},{level:18,resolution:0.597164283559817,scale:2256.994353},{level:19,resolution:0.298582141647617,scale:1128.497176}]});this.spatialReference=new c(this.tileInfo.spatialReference.toJson());this.copyright=a.copyright||"";var t=new r(e),d=t.scheme+"://"+t.authority+"/";this.urlPath=e.substring(d.length);this.tileServers=a.tileServers||[];-1===t.authority.indexOf("{subDomain}")&&this.tileServers.push(d);if(a.subDomains&&0<a.subDomains.length&&
1<t.authority.split(".").length){this.subDomains=a.subDomains;var f;n.forEach(a.subDomains,function(b,a){-1<t.authority.indexOf("${subDomain}")?f=t.scheme+"://"+m.substitute(t.authority,{subDomain:b})+"/":-1<t.authority.indexOf("{subDomain}")&&(f=t.scheme+"://"+t.authority.replace(/\{subDomain\}/gi,b)+"/");this.tileServers.push(f)},this)}this.tileServers=n.map(this.tileServers,function(b){"/"!==b.charAt(b.length-1)&&(b+="/");return b});this._levelToLevelValue=[];n.forEach(this.tileInfo.lods,function(b){this._levelToLevelValue[b.level]=
b.levelValue||b.level},this);this.loaded=!0;this.onLoad(this)},getTileUrl:function(e,a,d){e=this._levelToLevelValue[e];var b=this.tileServers[a%this.tileServers.length]+m.substitute(this.urlPath,{level:e,col:d,row:a}),b=b.replace(/\{level\}/gi,e).replace(/\{row\}/gi,a).replace(/\{col\}/gi,d),b=this.addTimestampToURL(b);return s.addProxy(b)}});l("extend-esri")&&p.setObject("layers.WebTiledLayer",q,f);return q})},"esri/layers/ServiceGeneratedFeatureCollection":function(){define("dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/dom-construct dojo/dom-style dojo/has ../kernel ../SpatialReference ../geometry/Extent ../geometry/webMercatorUtils ../renderers/SimpleRenderer ./layer ./FeatureLayer ../dijit/PopupTemplate".split(" "),
function(q,p,n,r,l,m,f,s,c,g,e,h,k,a,d){q=q([k],{declaredClass:"esri.layers._ServiceGeneratedFeatureCollection",constructor:function(b,a){this.pointSymbol=a&&a.pointSymbol;this.polylineSymbol=a&&a.polylineSymbol;this.polygonSymbol=a&&a.polygonSymbol;this._outSR=a&&(a.outSpatialReference||a.outSR)||new c({wkid:4326});this._options=n.mixin({},a)},parse:function(){console.error("parse function has not been implemented")},getFeatureLayers:function(){var b=[];this._fLayers&&(b=b.concat(this._fLayers));
return b},onRefresh:function(){},onOpacityChange:function(){},refresh:function(){this.loaded&&(this._map&&!this._io&&this.visible)&&this._createLayer()},_createLayer:function(b){var a=this;this._fireUpdateStart();b=this.parse(b);b.addCallback(function(b){a._io=null;a._initLayer(b)});b.addErrback(function(b){a._io=null;b=n.mixin(Error(),b);b.message="Unable to load resource: "+a.url+" "+(b.message||"");a._fireUpdateEnd(b);a.onError(b)})},_initLayer:function(b){this.loaded&&this._removeInternalLayers();
this.name=b.name;this.description=b.description;this.snippet=b.snippet;this.defaultVisibility=void 0!==b.visibility?this.visible=!!b.visibility:this.visible=!0;this.featureInfos=b.featureInfos;this.fullExtent=this.initialExtent=new g(b.lookAtExtent);this.copyright=b.author||b.copyright;var e;if((b=n.getObject("featureCollection.layers",!1,b))&&0<b.length)this._fLayers=[],r.forEach(b,function(b,c){var k=n.getObject("featureSet.features",!1,b);k&&0<k.length&&(e=n.mixin({outFields:["*"],infoTemplate:b.popupInfo?
new d(b.popupInfo):null,editable:!1},this._options),e.id&&(e.id=e.id+"_"+c),b.layerDefinition.capabilities="Query,Data",k=new a(b,e),k.geometryType&&(this["_"+k.geometryType]=k),this._fLayers.push(k))},this),0===this._fLayers.length&&delete this._fLayers;this.items=[];this._esriGeometryPoint&&(this.items=this.items.concat(this._esriGeometryPoint.graphics),this.pointSymbol&&(b=new h(this.pointSymbol),this._esriGeometryPoint.setRenderer(b)));this._esriGeometryPolyline&&(this.items=this.items.concat(this._esriGeometryPolyline.graphics),
this.polylineSymbol&&(b=new h(this.polylineSymbol),this._esriGeometryPolyline.setRenderer(b)));this._esriGeometryPolygon&&(this.items=this.items.concat(this._esriGeometryPolygon.graphics),this.polygonSymbol&&(b=new h(this.polygonSymbol),this._esriGeometryPolygon.setRenderer(b)));this._fireUpdateEnd();this.loaded&&(this._addInternalLayers(),this.onRefresh())},_addInternalLayers:function(){var b=this._map;this._fireUpdateStart();var a=b.spatialReference,d=this._outSR,c;if(a.wkid)c=a._isWebMercator()&&
d._isWebMercator()||a.wkid===d.wkid;else if(a.wkt)c=a.wkt===d.wkt;else{console.log("_setMap - map has invalid spatial reference");return}if(!c)if(a._isWebMercator()&&4326===d.wkid)this._converter=e.geographicToWebMercator;else if(d._isWebMercator()&&4326===a.wkid)this._converter=e.webMercatorToGeographic;else{console.log("_setMap - unsupported workflow. Spatial reference of the map and layer do not match, and the conversion cannot be done on the client.");return}(a=this._fLayers)&&0<a.length&&r.forEach(a,
function(a){if(this._converter){var d=a.graphics,e,c,k=d?d.length:0;for(e=0;e<k;e++)(c=d[e].geometry)&&d[e].setGeometry(this._converter(c))}b.addLayer(a)},this);this.setVisibility(this.visible);this._fireUpdateEnd()},_removeInternalLayers:function(){var b=this._map;b&&r.forEach(this.getFeatureLayers(),b.removeLayer,b)},setScaleRange:function(b,a){this.inherited(arguments);r.forEach(this.getFeatureLayers(),function(d){d.setScaleRange(b,a)});this._options.minScale=this.minScale;this._options.maxScale=
this.maxScale},setOpacity:function(b){this.opacity!=b&&(r.forEach(this.getFeatureLayers(),function(a){a.setOpacity(b)}),this.opacity=this._options.opacity=b,this.onOpacityChange(b))},onVisibilityChange:function(b){this._fireUpdateStart();r.forEach(this.getFeatureLayers(),function(a){a.setVisibility(b)});this._fireUpdateEnd()},_setMap:function(b,a){this.inherited(arguments);this._map=b;var d=this._div=l.create("div",null,a);m.set(d,"position","absolute");this._addInternalLayers();this.evaluateSuspension();
return d},_unsetMap:function(b,a){this._io&&this._io.cancel();p.disconnect(this._extChgHandle);delete this._extChgHandle;this._removeInternalLayers();var d=this._div;d&&(a.removeChild(d),l.destroy(d));this._div=null;this.inherited(arguments)}});f("extend-esri")&&n.setObject("layers._ServiceGeneratedFeatureCollection",q,s);return q})},"esri/layers/KMLGroundOverlay":function(){define("dojo/_base/declare dojo/_base/lang dojo/has ../kernel ../lang ./MapImage".split(" "),function(q,p,n,r,l,m){q=q([m],
{declaredClass:"esri.layers.KMLGroundOverlay",constructor:function(f){l.isDefined(this.visibility)&&(this.visible=!!this.visibility)}});n("extend-esri")&&p.setObject("layers.KMLGroundOverlay",q,r);return q})},"dojo/data/util/simpleFetch":function(){define(["../../_base/lang","../../_base/kernel","./sorter"],function(q,p,n){var r={};q.setObject("dojo.data.util.simpleFetch",r);r.errorHandler=function(l,m){m.onError&&m.onError.call(m.scope||p.global,l,m)};r.fetchHandler=function(l,m){var f=m.abort||
null,s=!1,c=m.start?m.start:0,g=m.count&&Infinity!==m.count?c+m.count:l.length;m.abort=function(){s=!0;f&&f.call(m)};var e=m.scope||p.global;m.store||(m.store=this);m.onBegin&&m.onBegin.call(e,l.length,m);m.sort&&l.sort(n.createSortFunction(m.sort,this));if(m.onItem)for(var h=c;h<l.length&&h<g;++h){var k=l[h];s||m.onItem.call(e,k,m)}m.onComplete&&!s&&(h=null,m.onItem||(h=l.slice(c,g)),m.onComplete.call(e,h,m))};r.fetch=function(l){l=l||{};l.store||(l.store=this);this._fetchItems(l,q.hitch(this,"fetchHandler"),
q.hitch(this,"errorHandler"));return l};return r})},"esri/layers/KMLLayer":function(){define("dojo/_base/kernel dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/_base/json dojo/_base/sniff dojo/io-query dojo/dom-construct dojo/dom-style ../kernel ../config ../lang ../request ../SpatialReference ../geometry/webMercatorUtils ../dijit/PopupTemplate ./layer ./KMLFolder ./KMLGroundOverlay ./MapImageLayer ./FeatureLayer".split(" "),function(q,p,n,r,l,m,f,s,c,g,e,h,k,a,d,b,t,u,
w,v,C,y){var H=p([u],{declaredClass:"esri.layers.KMLLayer",serviceUrl:location.protocol+"//utility.arcgis.com/sharing/kml",constructor:function(b,a){b||console.log("KMLLayer:constructor - please provide url for the KML file");this._outSR=a&&a.outSR||new d({wkid:4326});this._options=r.mixin({},a);h.defaults.kmlService&&(this.serviceUrl=h.defaults.kmlService);var e=this.linkInfo=a&&a.linkInfo;e&&(this.visible=!!e.visibility,this._waitingForMap=!!e.viewFormat);(!e||e&&e.visibility&&!this._waitingForMap)&&
this._parseKml();this.refresh=r.hitch(this,this.refresh);this.registerConnectEvents("esri.layers.KMLLayer",!0)},getFeature:function(a){if(a){var b=a.type,d=a.id,e;switch(b){case "esriGeometryPoint":case "esriGeometryPolyline":case "esriGeometryPolygon":(a=this["_"+b])&&(e=r.getObject("_mode._featureMap."+d,!1,a));break;case "GroundOverlay":if(a=this._groundLyr){var c=a.getImages(),b=c.length;for(a=0;a<b;a++)if(c[a].id===d){e=c[a];break}}break;case "ScreenOverlay":break;case "NetworkLink":l.some(this._links,
function(a){return a.linkInfo&&a.linkInfo.id===d?(e=a,!0):!1});break;case "Folder":b=(c=this.folders)?c.length:0;for(a=0;a<b;a++)if(c[a].id===d){e=c[a];break}break;default:console.log("KMLLayer:getFeature - unknown feature type")}return e}},getLayers:function(){var a=[];this._groundLyr&&a.push(this._groundLyr);this._fLayers&&(a=a.concat(this._fLayers));this._links&&l.forEach(this._links,function(b){b.declaredClass&&a.push(b)});return a},setFolderVisibility:function(a,b){a&&(this._fireUpdateStart(),
(a.visible=b)&&(b=this._areLocalAncestorsVisible(a)),this._setState(a,b),this._fireUpdateEnd())},onRefresh:function(){},onOpacityChange:function(){},_parseKml:function(b){var d=this;this._fireUpdateStart();this._io=a({url:this.serviceUrl,content:{url:this._url.path+this._getQueryParameters(b),model:"simple",folders:"",refresh:this.loaded?!0:void 0,outSR:m.toJson(this._outSR.toJson())},callbackParamName:"callback",load:function(a){d._io=null;d._initLayer(a)},error:function(a){d._io=null;a=r.mixin(Error(),
a);a.message="Unable to load KML: "+d.url+" "+(a.message||"");d._fireUpdateEnd(a);d.onError(a)}})},_initLayer:function(a){this.loaded&&this._removeInternalLayers();this.name=a.name;this.description=a.description;this.snippet=a.snippet;this.visibility=a.visibility;this.featureInfos=a.featureInfos;var b,d,e=this.folders=a.folders,c=[],k;if(e){d=e.length;for(b=0;b<d;b++)k=e[b]=new w(e[b]),-1===k.parentFolderId&&c.push(k)}var e=this._links=a.networkLinks,h;d=e?e.length:0;for(b=0;b<d;b++)e[b].viewRefreshMode&&
-1!==e[b].viewRefreshMode.toLowerCase().indexOf("onregion")||(h=r.mixin({},this._options),h.linkInfo=e[b],h.id&&(h.id=h.id+"_"+b),e[b]=new H(e[b].href,h),e[b]._parentLayer=this,e[b]._parentFolderId=this._getLinkParentId(e[b].linkInfo.id));if((e=a.groundOverlays)&&0<e.length){h=r.mixin({},this._options);h.id&&(h.id+="_mapImage");k=this._groundLyr=new C(h);d=e.length;for(b=0;b<d;b++)k.addImage(new v(e[b]))}if((a=r.getObject("featureCollection.layers",!1,a))&&0<a.length)this._fLayers=[],l.forEach(a,
function(a,b){var d=r.getObject("featureSet.features",!1,a);d&&0<d.length&&(h=r.mixin({outFields:["*"],infoTemplate:a.popupInfo?new t(a.popupInfo):null,editable:!1},this._options),h.id&&(h.id=h.id+"_"+b),a.layerDefinition.capabilities="Query,Data",d=new y(a,h),d.geometryType&&(this["_"+d.geometryType]=d),this._fLayers.push(d))},this),0===this._fLayers.length&&delete this._fLayers;d=c.length;for(b=0;b<d;b++)k=c[b],this._setState(k,k.visible);this._fireUpdateEnd();this.loaded?(this._addInternalLayers(),
this.onRefresh()):(this.loaded=!0,this.onLoad(this))},_addInternalLayers:function(){var a=this._map;this._fireUpdateStart();this._links&&l.forEach(this._links,function(b){b.declaredClass&&(a.addLayer(b),b._waitingForMap&&(b._waitingForMap=null,b.visible?b._parseKml(a):b._wMap=a))});var d=a.spatialReference,e=this._outSR,c;if(!d.equals(e))if(d.isWebMercator()&&4326===e.wkid)c=b.geographicToWebMercator;else if(e.isWebMercator()&&4326===d.wkid)c=b.webMercatorToGeographic;else{console.log("KMLLayer:_setMap - unsupported workflow. Spatial reference of the map and kml layer do not match, and the conversion cannot be done on the client.");
return}this._groundLyr&&(c&&l.forEach(this._groundLyr.getImages(),function(a){a.extent=c(a.extent)}),a.addLayer(this._groundLyr));(d=this._fLayers)&&0<d.length&&l.forEach(d,function(b){if(c){var d=b.graphics,e,k,h=d?d.length:0;for(e=0;e<h;e++)(k=d[e].geometry)&&d[e].setGeometry(c(k))}a.addLayer(b)});this.onVisibilityChange(this.visible)},_removeInternalLayers:function(){var a=this._map;this._links&&l.forEach(this._links,function(a){a.declaredClass&&a._io&&a._io.cancel()});a&&l.forEach(this.getLayers(),
a.removeLayer,a)},_setState:function(a,b){var d=a.featureInfos,e,c,k,h=d?d.length:0,g=b?"show":"hide";for(k=0;k<h;k++)if(e=d[k],c=this.getFeature(e))if("Folder"===e.type)this._setState(c,b&&c.visible);else if("NetworkLink"===e.type)this._setInternalVisibility(c,b);else c[g]()},_areLocalAncestorsVisible:function(a){var b=a.parentFolderId;for(a=a.visible;a&&-1!==b;)b=this.getFeature({type:"Folder",id:b}),a=a&&b.visible,b=b.parentFolderId;return a},_setInternalVisibility:function(a,b){var d=a._parentLayer,
e=a._parentFolderId;for(b=b&&a.visible;b&&d;)b=b&&d.visible,-1<e&&(b=b&&d._areLocalAncestorsVisible(d.getFeature({type:"Folder",id:e}))),e=d._parentFolderId,d=d._parentLayer;this._setIntState(a,b)},_setIntState:function(a,b){a&&l.forEach(a.getLayers(),function(d){d.linkInfo?a._setIntState(d,b&&d.visible&&a._areLocalAncestorsVisible(a.getFeature({type:"Folder",id:d._parentFolderId}))):d.setVisibility(b)})},_getLinkParentId:function(a){var b=-1;this.folders&&l.some(this.folders,function(d){return d.networkLinkIds&&
-1!==l.indexOf(d.networkLinkIds,a)?(b=d.id,!0):!1});return b},_checkAutoRefresh:function(){var a=this.linkInfo;if(a)if(this.visible){if(this.loaded&&this._map){var b=a.refreshMode,d=a.refreshInterval,e=a.viewRefreshMode,a=a.viewRefreshTime;b&&(-1!==b.toLowerCase().indexOf("oninterval")&&0<d)&&(this._stopAutoRefresh(),this._timeoutHandle=setTimeout(this.refresh,1E3*d));e&&(-1!==e.toLowerCase().indexOf("onstop")&&0<a)&&!this._extChgHandle&&(this._extChgHandle=n.connect(this._map,"onExtentChange",this,
this._extentChanged))}}else this._stopAutoRefresh(),n.disconnect(this._extChgHandle),delete this._extChgHandle},_stopAutoRefresh:function(){clearTimeout(this._timeoutHandle);this._timeoutHandle=null},_getQueryParameters:function(a){a=a||this._map;var d={},c=this.linkInfo,h=a&&a.extent,g;this._url.query&&(r.mixin(d,this._url.query),g=!!this._url.query.token);if(e.id&&!g&&(g=e.id.findCredential(this._url.path)))d.token=g.token;if(c){g=c.viewFormat;var f=c.httpQuery,c=c.viewBoundScale;if(h&&g){var m=
h,l=h,t=h.spatialReference;t&&(t.isWebMercator()?m=b.webMercatorToGeographic(h):4326===t.wkid&&(l=b.geographicToWebMercator(h)));h=m.getCenter();l=Math.max(l.getWidth(),l.getHeight());c&&(m=m.expand(c));g=g.replace(/\[bboxWest\]/ig,m.xmin).replace(/\[bboxEast\]/ig,m.xmax).replace(/\[bboxSouth\]/ig,m.ymin).replace(/\[bboxNorth\]/ig,m.ymax).replace(/\[lookatLon\]/ig,h.x).replace(/\[lookatLat\]/ig,h.y).replace(/\[lookatRange\]/ig,l).replace(/\[lookatTilt\]/ig,0).replace(/\[lookatHeading\]/ig,0).replace(/\[lookatTerrainLon\]/ig,
h.x).replace(/\[lookatTerrainLat\]/ig,h.y).replace(/\[lookatTerrainAlt\]/ig,0).replace(/\[cameraLon\]/ig,h.x).replace(/\[cameraLat\]/ig,h.y).replace(/\[cameraAlt\]/ig,l).replace(/\[horizFov\]/ig,60).replace(/\[vertFov\]/ig,60).replace(/\[horizPixels\]/ig,a.width).replace(/\[vertPixels\]/ig,a.height).replace(/\[terrainEnabled\]/ig,0);r.mixin(d,s.queryToObject(g))}f&&(f=f.replace(/\[clientVersion\]/ig,e.version).replace(/\[kmlVersion\]/ig,2.2).replace(/\[clientName\]/ig,"ArcGIS API for JavaScript").replace(/\[language\]/ig,
q.locale),r.mixin(d,s.queryToObject(f)))}a=[];for(var n in d)k.isDefined(d[n])&&a.push(n+"\x3d"+d[n]);return(a=a.join("\x26"))?"?"+a:""},setScaleRange:function(a,b){this.inherited(arguments);l.forEach(this.getLayers(),function(d){d.setScaleRange(a,b)});this._options.minScale=this.minScale;this._options.maxScale=this.maxScale},setOpacity:function(a){this.opacity!=a&&(l.forEach(this.getLayers(),function(b){b.setOpacity(a)}),this.opacity=this._options.opacity=a,this.onOpacityChange(a))},_setMap:function(a,
b){this.inherited(arguments);this._map=a;var d=this._div=c.create("div",null,b);g.set(d,"position","absolute");this._addInternalLayers();this.evaluateSuspension();return d},_unsetMap:function(a,b){this._io&&this._io.cancel();this._stopAutoRefresh();n.disconnect(this._extChgHandle);delete this._extChgHandle;this._removeInternalLayers();var d=this._div;d&&(b.removeChild(d),c.destroy(d));this._wMap=this._div=null;this.inherited(arguments)},onVisibilityChange:function(a){this.loaded?(this._fireUpdateStart(),
this._setInternalVisibility(this,a),this._checkAutoRefresh(),this._fireUpdateEnd()):this.linkInfo&&a&&(this._waitingForMap||this._parseKml(this._wMap))},refresh:function(){this.loaded&&(this._map&&!this._io&&this.visible)&&this._parseKml()},getFeatureCollection:function(a){var b,d=[];if(a=this.getFeature({type:"Folder",id:a}))(b=l.map(a.featureInfos,function(a){if("esriGeometryPoint"===a.type||"esriGeometryPolyline"===a.type||"esriGeometryPolygon"===a.type)return a.id},this))&&0<b.length&&l.forEach(this._fLayers,
function(a){var e,c;e=a.toJson();e.featureSet.features&&0<e.featureSet.features.length&&(c=l.filter(e.featureSet.features,function(d){if(-1!==l.indexOf(b,d.attributes[a.objectIdField]))return d},this));c&&0<c.length&&(e.featureSet.features=c,d.push(e))},this);return d},getFeatureCount:function(a){a=this.getFeature({type:"Folder",id:a});var b={points:0,polylines:0,polygons:0};a&&l.forEach(a.featureInfos,function(a){"esriGeometryPoint"===a.type&&(b.points+=1);"esriGeometryPolyline"===a.type&&(b.polylines+=
1);"esriGeometryPolygon"===a.type&&(b.polygons+=1)});return b},_extentChanged:function(){this._stopAutoRefresh();this._timeoutHandle=setTimeout(this.refresh,1E3*this.linkInfo.viewRefreshTime)}});f("extend-esri")&&r.setObject("layers.KMLLayer",H,e);return H})},"dojo/data/util/sorter":function(){define(["../../_base/lang"],function(q){var p={};q.setObject("dojo.data.util.sorter",p);p.basicComparator=function(n,p){var l=-1;null===n&&(n=void 0);null===p&&(p=void 0);if(n==p)l=0;else if(n>p||null==n)l=
1;return l};p.createSortFunction=function(n,q){function l(e,a,d,b){return function(c,h){var g=b.getValue(c,e),f=b.getValue(h,e);return a*d(g,f)}}for(var m=[],f,s=q.comparatorMap,c=p.basicComparator,g=0;g<n.length;g++){f=n[g];var e=f.attribute;if(e){f=f.descending?-1:1;var h=c;s&&("string"!==typeof e&&"toString"in e&&(e=e.toString()),h=s[e]||c);m.push(l(e,f,h,q))}}return function(e,a){for(var d=0;d<m.length;){var b=m[d++](e,a);if(0!==b)return b}return 0}};return p})},"esri/layers/OnDemandMode":function(){define("dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/has ../kernel ../geometry/Point ../tasks/query ./RenderMode ./GridLayout".split(" "),
function(q,p,n,r,l,m,f,s,c,g){q=q([c],{declaredClass:"esri.layers._OnDemandMode",constructor:function(e){this.featureLayer=e;this._featureMap={};this._queryErrorHandler=n.hitch(this,this._queryErrorHandler)},initialize:function(e){this.inherited(arguments);var c=this.featureLayer,k=c._srInfo;this._gridLayer=new g(new f(k?k.valid[0]:e.extent.xmin,e.extent.ymax,e.spatialReference),{width:c._tileWidth,height:c._tileHeight},{width:e.width,height:e.height},k);this._cellMap={};this._gridLayer.setResolution(e.extent)},
startup:function(){this._ioQueue=[];this.featureLayer.suspended||(this._zoomHandler(),this._enableConnectors())},propertyChangeHandler:function(e){this._init&&(2>e?this._zoomHandler():console.log("FeatureLayer: layer in on-demand mode does not support time definitions. Layer id \x3d "+this.featureLayer.id+", Layer URL \x3d "+this.featureLayer.url))},destroy:function(){this._disableConnectors();this.inherited(arguments)},drawFeature:function(e){var c=this._gridLayer,k=e.geometry,a=[];if(k)for(var a=
c.getCellsInExtent("point"===k.type?{xmin:k.x,ymin:k.y,xmax:k.x,ymax:k.y}:k.getExtent(),!1).cells,c=this._cellMap,d,b=e.attributes[this.featureLayer.objectIdField],g,f,m,k=0;k<a.length;k++)d=a[k],g=d.latticeID,f=d.row,m=d.col,g?d=c[g]=c[g]||d:(c[f]=c[f]||{},d=c[f][m]=c[f][m]||d),d.features=d.features||[],d.features.push(e),this._addFeatureIIf(b,e),this._incRefCount(b)},suspend:function(){this._init&&this._disableConnectors()},resume:function(){this._init&&(this._enableConnectors(),this._zoomHandler())},
refresh:function(){this._zoomHandler()},_enableConnectors:function(){var e=this.map;this._zoomConnect=p.connect(e,"onZoomEnd",this,this._zoomHandler);this._panConnect=p.connect(e,"onPanEnd",this,this._panHandler);this._resizeConnect=p.connect(e,"onResize",this,this._panHandler)},_disableConnectors:function(){p.disconnect(this._zoomConnect);p.disconnect(this._panConnect);p.disconnect(this._resizeConnect)},_zoomHandler:function(){this._processIOQueue(!0);var e=this.featureLayer,c=this.map;e.suspended||
(e._fireUpdateStart(),this._clearIIf(),(e=e._trackManager)&&e.clearTracks(),this._cellMap={},this._gridLayer.setResolution(c.extent),this._sendRequest())},_panHandler:function(e){this.featureLayer._fireUpdateStart();this._sendRequest(this.featureLayer._resized&&e)},_getRequestId:function(e,c){return("_"+e.name+e.layerId+e._ulid+"_"+c.resolution+"_"+(c.latticeID||c.row+"_"+c.col)).replace(/[^a-zA-Z0-9\_]+/g,"_")},_sendRequest:function(e){this._exceeds=!1;var c=this.featureLayer,k=this.map;e=e||k.extent;
k=this._gridLayer.getCellsInExtent(e,c.latticeTiling).cells;if(!c.isEditable())var a=this._cellMap,k=r.filter(k,function(b){if(b.lattice){if(a[b.latticeID])return!1}else if(a[b.row]&&a[b.row][b.col])return!1;return!0});var d=c.getOutFields(),b=c.getDefinitionExpression(),g=c._getOffsettedTE(c._mapTimeExtent),f=c.supportsAdvancedQueries?c.getOrderByFields():null,m=c._usePatch,l=this._ioQueue,n,p=this,q=this._drawFeatures,A,x,D;this._pending=this._pending||0;for(n=0;n<k.length;n++){A=k[n];x=new s;x.geometry=
A.extent||A.lattice;x.outFields=d;x.where=b;c.latticeTiling&&A.extent&&(x.spatialRelationship=s.SPATIAL_REL_CONTAINS);x.returnGeometry=!0;x.timeExtent=g;x.maxAllowableOffset=c._maxOffset;c._ts&&(x._ts=(new Date).getTime());x.orderByFields=f;x.multipatchOption=c.multipatchOption;D=null;if(m&&(D=this._getRequestId(c,A),this._isPending(D)))continue;this._pending++;l.push(c._task.execute(x,function(){var a=A;return function(b){q.apply(p,[b,a])}}.call(this),this._queryErrorHandler,D))}this._removeOldCells(e);
this._endCheck()},_drawFeatures:function(e,c){this._exceeds=this._exceeds||e.exceededTransferLimit;this._finalizeIO();var k=this.map.extent,a=c.extent,d=c.row,b=c.col,g=this.featureLayer.objectIdField,f=e.features,m=this._gridLayer,l=this._cellMap,s=c.latticeID,n=s?l[s]:l[d]&&l[d][b];if(c.resolution!=m._resolution||(s?s!==m.getLatticeID(k):!m.intersects(a,k)))n&&this._removeCell(d,b,s);else if(n)this._updateCell(n,f);else{c.features=f;s?l[s]=c:(l[d]=l[d]||{},l[d][b]=c);a=f.length;for(k=0;k<a;k++)d=
f[k],b=d.attributes[g],this._addFeatureIIf(b,d),this._incRefCount(b)}this._endCheck()},_queryErrorHandler:function(e){this._finalizeIO();this.featureLayer._errorHandler(e);this._endCheck(!0)},_finalizeIO:function(){this._purgeRequests();this._pending--},_endCheck:function(e){if(0===this._pending){this._processIOQueue();var c=this.featureLayer,k=c._trackManager;k&&(k.clearTracks(),k.addFeatures(c.graphics),c._ager&&r.forEach(c.graphics,function(a){a._shape&&c._repaint(a)}),k.moveLatestToFront(),k.drawTracks());
this.featureLayer._fireUpdateEnd(e&&Error("FeatureLayer: an error occurred while updating the layer"),this._exceeds?{queryLimitExceeded:!0}:null);if(this._exceeds)c.onQueryLimitExceeded()}},_processIOQueue:function(e){this._ioQueue=r.filter(this._ioQueue,function(e){return-1<e.fired?!1:!0});e&&r.forEach(this._ioQueue,this._cancelPendingRequest)},_removeOldCells:function(e){var c=this._cellMap,k=this._gridLayer,a,d;for(a in c)if(c[a]){var b=c[a],g=b.latticeID,f=0,m=0;if(g)f++,g!==k.getLatticeID(e)&&
(this._removeCell(null,null,g),m++);else for(d in b)b[d]&&(f++,k.intersects(b[d].extent,e)||(this._removeCell(a,d),m++));m===f&&delete c[a]}},_updateCell:function(e,c){var k=this.featureLayer,a=k.objectIdField,k=k._selectedFeatures,d,b=c.length;e.features=e.features||[];for(d=0;d<b;d++){var g=c[d],f=g.attributes[a],m=this._addFeatureIIf(f,g);m===g?(this._incRefCount(f),e.features.push(m)):f in k||(m.setGeometry(g.geometry),m.setAttributes(g.attributes))}},_removeCell:function(e,c,k){var a=this._cellMap,
d=this.featureLayer,b=d.objectIdField,g=k?a[k]:a[e]&&a[e][c];if(g){k?delete a[k]:delete a[e][c];e=g.features;for(c=0;c<e.length;c++)k=e[c].attributes[b],this._decRefCount(k),k in d._selectedFeatures||this._removeFeatureIIf(k)}}});l("extend-esri")&&n.setObject("layers._OnDemandMode",q,m);return q})},"esri/layers/FeatureLayer":function(){define("require module dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/_base/json dojo/_base/Deferred dojo/date/locale dojo/sniff dojo/io-query dojo/dom-construct dojo/i18n dojo/when dojo/promise/all ../kernel ../lang ../request ../config ../deferredUtils ../SpatialReference ../symbols/SimpleMarkerSymbol ../symbols/SimpleLineSymbol ../symbols/SimpleFillSymbol ../symbols/jsonUtils ../renderers/SimpleRenderer ../renderers/UniqueValueRenderer ../renderers/jsonUtils ../tasks/QueryTask ../tasks/query ../tasks/FeatureSet ../tasks/StatisticDefinition ../geometry/Extent ../geometry/jsonUtils ../geometry/normalizeUtils ../geometry/scaleUtils ./GraphicsLayer ./Field ./TimeInfo ./FeatureType ./FeatureTemplate ./FeatureEditResult ./LabelClass ./SnapshotMode ./OnDemandMode ./SelectionMode ./StreamMode ./TrackManager dojo/i18n!../nls/jsapi dojo/has!extend-esri?./agscommon".split(" "),
function(q,p,n,r,l,m,f,s,c,g,e,h,k,a,d,b,t,u,w,v,C,y,H,A,x,D,R,S,T,G,N,K,U,E,ba,ca,da,ea,F,fa,ga,L,ha,O,ia,ja,ka,P,M){var Q=w.defaults,z=n(da,{declaredClass:"esri.layers.FeatureLayer",invalidParams:"query contains one or more unsupported parameters",reHostedFS:/https?:\/\/services.*\.arcgis\.com/i,maxPointCountForAuto:4E3,maxRecordCountForAuto:2E3,maxVertexCountForAuto:25E4,generalizeForScale:4E3,_eventMap:{"add-attachment-complete":["result"],"before-apply-edits":["adds","updates","deletes"],"delete-attachments-complete":["results"],
"edits-complete":["adds","updates","deletes"],"query-attachment-infos-complete":["results"],"query-count-complete":["count"],"query-features-complete":["featureSet"],"query-ids-complete":["objectIds"],"query-related-features-complete":["featureSets"],"selection-complete":["features","method"],"update-end":["error","info"]},constructor:function(a,b){this._preventInit||this._initFeatureLayer(a,b)},_initFeatureLayer:function(a,b){this.i18n=M;b=b||{};this._outFields=b.outFields;this._loadCallback=b.loadCallback;
var d=b._usePatch;this._usePatch=null===d||void 0===d?!0:d;this._trackIdField=b.trackIdField;this.objectIdField=b.objectIdField;this._maxOffset=null!=b.maxAllowableOffset?b.maxAllowableOffset:this.maxAllowableOffset;this._optEditable=b.editable;this._optAutoGen=b.autoGeneralize;this.editSummaryCallback=b.editSummaryCallback;this.userId=b.userId;this.userIsAdmin=b.userIsAdmin;this.useMapTime=b.hasOwnProperty("useMapTime")?!!b.useMapTime:!0;this.source=b.source;this.gdbVersion=b.gdbVersion;this.orderByFields=
b.orderByFields;this.maxPointCountForAuto=null!=b.maxPointCountForAuto?b.maxPointCountForAuto:this.maxPointCountForAuto;this.maxRecordCountForAuto=null!=b.maxRecordCountForAuto?b.maxRecordCountForAuto:this.maxRecordCountForAuto;this.maxVertexCountForAuto=null!=b.maxVertexCountForAuto?b.maxVertexCountForAuto:this.maxVertexCountForAuto;this.generalizeForScale=null!=b.generalizeForScale?b.generalizeForScale:this.generalizeForScale;this.queryPagination=null!=b.queryPagination?b.queryPagination:this.url?
this.reHostedFS.test(this.url):!1;this.multipatchOption=b.multipatchOption;this._selectedFeatures={};this._selectedFeaturesArr=[];this._newFeatures=[];this._deletedFeatures={};this._ulid=this._getUniqueId();var c=z,d=this.mode=t.isDefined(b.mode)?b.mode:c.MODE_ONDEMAND;this._isStream&&(this.mode=d=c.MODE_STREAM);switch(d){case c.MODE_SNAPSHOT:this.currentMode=c.MODE_SNAPSHOT;this._mode=new O(this);this._isSnapshot=!0;break;case c.MODE_ONDEMAND:case c.MODE_AUTO:this.currentMode=c.MODE_ONDEMAND;this._tileWidth=
b.tileWidth||512;this._tileHeight=b.tileHeight||512;this._mode=new ia(this);this.latticeTiling=b.latticeTiling;break;case c.MODE_SELECTION:this.currentMode=c.MODE_SELECTION;this._mode=new ja(this);this._isSelOnly=!0;break;case c.MODE_STREAM:this.currentMode=c.MODE_STREAM,this._mode=new ka(this),this._isStream=!0}this._initLayer=l.hitch(this,this._initLayer);this._selectHandler=l.hitch(this,this._selectHandler);this._editable=!1;if(l.isObject(a)&&a.layerDefinition)return this._collection=!0,this.mode=
this._isStream?c.MODE_STREAM:c.MODE_SNAPSHOT,this._initLayer(a),this;this._task=new T(this.url,{source:this.source,gdbVersion:this.gdbVersion});d=this._url.path;this._fserver=!1;-1!==d.search(/\/FeatureServer\//i)&&(this._fserver=!0);this.mode===c.MODE_AUTO&&this.reHostedFS.test(this.url)&&this._queryLimit();(c=b.resourceInfo)?this._initLayer(c):(this.source&&(c={source:this.source.toJson()},this._url.query=l.mixin(this._url.query,{layer:f.toJson(c)})),this.gdbVersion&&(this._url.query=l.mixin(this._url.query,
{gdbVersion:this.gdbVersion})),u({url:d,content:l.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:this._initLayer,error:this._errorHandler}));this.registerConnectEvents()},_initLayer:function(a,b){if(a||b){this._json=a;this._findCredential();if(this.credential&&this.credential.ssl||a&&a._ssl)this._useSSL(),this._task._useSSL();this._collection&&(this._isStream||(this.currentMode=z.MODE_SNAPSHOT,this._mode=new O(this)),this._isSnapshot=!0,this._featureSet=a.featureSet,this._nextId=
a.nextObjectId,a=a.layerDefinition);this.geometryType=a.geometryType;"string"!==typeof this.multipatchOption&&"esriGeometryMultiPatch"===this.geometryType&&(this.multipatchOption="xyFootprint");if(a.hasOwnProperty("capabilities")){var d=this.capabilities=a.capabilities;d&&-1!==d.toLowerCase().indexOf("editing")?this._editable=!0:this._editable=!1}else this._collection||(this._editable=this._fserver);t.isDefined(this._optEditable)?(this._editable=this._optEditable,delete this._optEditable):"esriGeometryMultiPatch"===
this.geometryType&&(this._editable=!1);this._json=f.toJson(this._json);if(this.isEditable())delete this._maxOffset;else if(this.currentMode!==z.MODE_SNAPSHOT&&("esriGeometryPolyline"===this.geometryType||"esriGeometryPolygon"===this.geometryType||this.hasXYFootprint()))this._autoGeneralize=t.isDefined(this._optAutoGen)?this._optAutoGen:this.currentMode===z.MODE_ONDEMAND,delete this._optAutoGen;var d=a.effectiveMinScale||a.minScale,c=a.effectiveMaxScale||a.maxScale;!this._hasMin&&d&&this.setMinScale(d);
!this._hasMax&&c&&this.setMaxScale(c);this.layerId=a.id;this.name=a.name;this.description=a.description;this.copyright=a.copyrightText;this.type=a.type;this.displayField=a.displayField;this.defaultDefinitionExpression=a.definitionExpression;this.fullExtent=new U(a.extent);this.initialExtent=new U(this.fullExtent.toJson());this.fullExtent.spatialReference&&(this.spatialReference=new C(this.fullExtent.spatialReference.toJson()));this.defaultVisibility=a.defaultVisibility;if("esriGeometryPoint"===this.geometryType||
"esriGeometryMultipoint"===this.geometryType)this.latticeTiling=!1;this.indexedFields=a.indexedFields;this.maxRecordCount=a.maxRecordCount;this.canModifyLayer=a.canModifyLayer;this.supportsStatistics=a.supportsStatistics;this.supportsAdvancedQueries=this._collection?!1:a.supportsAdvancedQueries;this.hasLabels=a.hasLabels;this.canScaleSymbols=a.canScaleSymbols;this.supportsRollbackOnFailure=a.supportsRollbackOnFailure;this.syncCanReturnChanges=a.syncCanReturnChanges;this.isDataVersioned=a.isDataVersioned;
this.editFieldsInfo=a.editFieldsInfo;this.ownershipBasedAccessControlForFeatures=a.ownershipBasedAccessControlForFeatures;this.editFieldsInfo&&this.ownershipBasedAccessControlForFeatures&&(this.creatorField=this.editFieldsInfo.creatorField);this.relationships=a.relationships;this.allowGeometryUpdates=t.isDefined(a.allowGeometryUpdates)?a.allowGeometryUpdates:!0;this._isTable="Table"===this.type;for(var e=this.fields=[],c=a.fields,d=0;d<c.length;d++)e.push(new ea(c[d]));if(!this.objectIdField){this.objectIdField=
a.objectIdField;if(!this.objectIdField){c=a.fields;for(d=0;d<c.length;d++)if(e=c[d],"esriFieldTypeOID"===e.type){this.objectIdField=e.name;break}}this.objectIdField||console.debug("esri.layers.FeatureLayer: "+t.substitute({url:this.url},"objectIdField is not set [url: ${url}]"))}if(!t.isDefined(this._nextId)){c=this.objectIdField;e=-1;if(this._collection&&c)for(var k=(d=this._featureSet)&&d.features,h=k?k.length:0,s,d=0;d<h;d++)s=(s=k[d].attributes)&&s[c],s>e&&(e=s);this._nextId=e+1}this.globalIdField=
a.globalIdField;if(d=this.typeIdField=a.typeIdField)if(d=!this._getField(d)&&this._getField(d,!0))this.typeIdField=d.name;this.visibilityField=a.visibilityField;if(c=a.defaultSymbol)this.defaultSymbol=x.fromJson(c);var n=this.types=[],p=a.types,q,r,e=(d=this.editFieldsInfo)&&d.creatorField,k=d&&d.editorField;s=e||k;h=[];if(p)for(d=0;d<p.length;d++)q=new fa(p[d]),r=q.templates,s&&(r&&r.length)&&(h=h.concat(r)),n.push(q);p=a.templates;q=this.templates=[];if(p)for(d=0;d<p.length;d++)n=new ga(p[d]),s&&
h.push(n),q.push(n);for(d=0;d<h.length;d++)if(s=l.getObject("prototype.attributes",!1,h[d]))e&&delete s[e],k&&delete s[k];if(d=a.timeInfo)this.timeInfo=new F(d),this._startTimeField=d.startTimeField,this._endTimeField=d.endTimeField,this._startTimeField&&this._endTimeField&&(this._twoTimeFields=!0),this._trackIdField?d.trackIdField=this._trackIdField:this._trackIdField=d.trackIdField;this.hasAttachments=!this._collection&&a.hasAttachments?!0:!1;this.htmlPopupType=a.htmlPopupType;var d=a.drawingInfo,
v;if((e=d&&d.labelingInfo)&&!this.labelingInfo)this.labelingInfo=m.map(e,function(a){return new ha(a)}),this._fixLabelExpr();if(!this.renderer)if(d&&d.renderer){if(v=d.renderer,this.setRenderer(S.fromJson(v)),"classBreaks"===v.type&&this.renderer.setMaxInclusive(!0),!this._collection){var u=v.type,c=[];v=this.renderer;switch(u){case "simple":c.push(v.symbol);break;case "uniqueValue":case "classBreaks":c.push(v.defaultSymbol),c=c.concat(m.map(v.infos,function(a){return a.symbol}))}var c=m.filter(c,
t.isDefined),w=this._url.path+"/images/",G=this._getToken();m.forEach(c,function(a){var b=a.url;b&&(-1===b.search(/https?\:/)&&-1===b.indexOf("data:")&&(a.url=w+b),G&&-1!==a.url.search(/https?\:/)&&(a.url+="?token\x3d"+G))})}}else if(c)p=this.types,0<p.length?(v=new R(this.defaultSymbol,this.typeIdField),m.forEach(p,function(a){v.addValue(a.id,a.symbol)})):v=new D(this.defaultSymbol),this.setRenderer(v);else if(!this._isTable){switch(this.geometryType){case "esriGeometryPoint":case "esriGeometryMultipoint":u=
new y;break;case "esriGeometryPolyline":u=new H;break;case "esriGeometryPolygon":u=new A;break;default:this.hasXYFootprint()&&(u=new A)}this.setRenderer(u?new D(u):null)}u=d&&d.transparency||0;!this.hasOwnProperty("opacity")&&0<u&&(this.opacity=1-u/100);this.version=a.currentVersion;this.version||(this.version="capabilities"in a||"drawingInfo"in a||"hasAttachments"in a||"htmlPopupType"in a||"relationships"in a||"timeInfo"in a||"typeIdField"in a||"types"in a?10:9.3);if((g("ie")||g("safari"))&&this.isEditable()&&
10.02>this.version)this._ts=!0;this.statistics=a.statistics;this._fixRendererFields();this._checkFields();this._updateCaps();var K=function(){this.currentMode!==z.MODE_SNAPSHOT&&(this.queryPagination=!1);this.loaded=!0;this.onLoad(this);var a=this._loadCallback;a&&(delete this._loadCallback,a(this))};this._collection?(u=this._featureSet,this._featureSet=null,this._mode._drawFeatures(new N(u)),this._fcAdded=!0,K.call(this)):this._forceIdentity(this._limitPromise?function(){var a=this;this._limitPromise.then(function(b){a._checkMode(b)});
this._limitPromise.always(function(){a._limitPromise=null;K.call(a)})}:K)}},onRendererChange:function(){this.inherited(arguments);var a=this._getRenderer();this._ager=!(!a||!a.observationAger||!a.observationRenderer);if(a){var b=[],a=m.filter([a,a.observationRenderer,a.latestObservationRenderer,a.trackRenderer],t.isDefined);m.forEach(a,function(a){l.isFunction(a.attributeField)||b.push(a.attributeField);b.push(a.attributeField2);b.push(a.attributeField3)},this);this._rendererFields=m.filter(b,t.isDefined)}else this._rendererFields=
[];this.loaded&&(this._fixRendererFields(),this._checkFields(this._rendererFields),this._collection&&(this._typesDirty=!0))},redraw:function(){this.inherited(arguments);this._trackManager&&this._trackManager.container&&this._trackManager.container.redraw()},_evalSDRenderer:function(){this.inherited(arguments);var a=this._getRenderer();this._ager=!(!a||!a.observationAger||!a.observationRenderer);this._trackManager&&this._trackManager.container&&this._trackManager.container.setRenderer(a&&a.trackRenderer)},
_setMap:function(a){var b=this.inherited(arguments),d=this._mode,c=this;d&&d.initialize(a);this.geometryType&&this.attr("data-geometry-type",this.geometryType.replace(/esriGeometry/i,"").toLowerCase());this._addHandle=this.on("graphic-node-add",function(a){a=a.graphic.attributes;(a=c._selectedFeatures[a&&a[c.objectIdField]])&&a.attr("data-selected","")});return b},_unsetMap:function(a){var b=this._mode;b&&b.suspend();this._trackManager&&(this._trackManager.destroy(),this._trackManager=null);r.disconnect(this._zoomConnect);
r.disconnect(this._addHandle);this._zoomConnect=this._addHandle=null;this._toggleTime(!1);this.inherited("_unsetMap",arguments)},refresh:function(){var a=this._mode;a&&a.refresh()},hasXYFootprint:function(){return"esriGeometryMultiPatch"===this.geometryType&&"xyFootprint"===this.multipatchOption},getOutFields:function(){return m.filter(this._getOutFields(),function(a){return"*"===a||!!this._getField(a)},this)},setEditable:function(a){if(!this._collection)return console.log("FeatureLayer:setEditable - this functionality is not yet supported for layer in a feature service"),
this;if(!this.loaded)return this._optEditable=a,this;var b=this._editable;this._editable=a;this._updateCaps();if(b!==a)this.onCapabilitiesChange();return this},getEditCapabilities:function(a){var b={canCreate:!1,canUpdate:!1,canDelete:!1};if(!this.loaded||!this.isEditable())return b;var d=a&&a.feature;a=a&&a.userId;var c=m.map(this.capabilities?this.capabilities.toLowerCase().split(","):[],l.trim),e=-1<m.indexOf(c,"editing"),k=e&&-1<m.indexOf(c,"create"),b=e&&-1<m.indexOf(c,"update"),c=e&&-1<m.indexOf(c,
"delete"),g=this.ownershipBasedAccessControlForFeatures,f=this.editFieldsInfo,h=f&&f.creatorField,f=f&&f.realm,d=(d=d&&d.attributes)&&h?d[h]:void 0,s=!!this.userIsAdmin,h=!g||s||!(!g.allowOthersToUpdate&&!g.allowUpdateToOthers),g=!g||s||!(!g.allowOthersToDelete&&!g.allowDeleteToOthers);if(s||e&&!k&&!b&&!c)k=b=c=!0;e={canCreate:k,canUpdate:b,canDelete:c};null===d?(e.canUpdate=b&&h,e.canDelete=c&&g):""!==d&&d&&((a=a||this.getUserId())&&f&&(a=a+"@"+f),a.toLowerCase()!==d.toLowerCase()&&(e.canUpdate=
b&&h,e.canDelete=c&&g));return e},getUserId:function(){var a;this.loaded&&(a=this.credential&&this.credential.userId||this.userId||"");return a},setUserIsAdmin:function(a){this.userIsAdmin=a},setEditSummaryCallback:function(a){this.editSummaryCallback=a},getEditSummary:function(a,b,d){d=t.isDefined(d)?d:(new Date).getTime();var c="";d=this.getEditInfo(a,b,d);(b=b&&b.callback||this.editSummaryCallback)&&(d=b(a,d)||"");if(l.isString(d))c=d;else{if(d){a=d.action;b=d.userId;var e=d.timeValue,g=0;a&&g++;
b&&g++;t.isDefined(e)&&g++;1<g&&(c=("edit"===a?"edit":"create")+(b?"User":"")+(t.isDefined(e)?d.displayPattern:""))}c=c&&t.substitute(d,this.i18n.layers.FeatureLayer[c])}return c},getEditInfo:function(a,b,d){if(this.loaded){d=t.isDefined(d)?d:(new Date).getTime();b=b&&b.action||"last";var c=this.editFieldsInfo,e=c&&c.creatorField,g=c&&c.creationDateField,k=c&&c.editorField,c=c&&c.editDateField,k=(a=a&&a.attributes)&&k?a[k]:void 0,c=a&&c?a[c]:null,e=this._getEditData(a&&e?a[e]:void 0,a&&g?a[g]:null,
d);d=this._getEditData(k,c,d);var f;switch(b){case "creation":f=e;break;case "edit":f=d;break;case "last":f=d||e}f&&(f.action=f===d?"edit":"creation");return f}},_getEditData:function(a,b,d){var e,g,k;t.isDefined(b)&&(g=d-b,k=0>g?"Full":6E4>g?"Seconds":12E4>g?"Minute":36E5>g?"Minutes":72E5>g?"Hour":864E5>g?"Hours":6048E5>g?"WeekDay":"Full");if(void 0!==a||k)e=e||{},e.userId=a,k&&(a=c.format,d=new Date(b),e.minutes=Math.floor(g/6E4),e.hours=Math.floor(g/36E5),e.weekDay=a(d,{datePattern:"EEEE",selector:"date"}),
e.formattedDate=a(d,{selector:"date"}),e.formattedTime=a(d,{selector:"time"}),e.displayPattern=k,e.timeValue=b);return e},isEditable:function(){return!(!this._editable&&!this.userIsAdmin)},setMaxAllowableOffset:function(a){this.isEditable()||(this._maxOffset=a);return this},getMaxAllowableOffset:function(){return this._maxOffset},setAutoGeneralize:function(a){if(this.loaded){if(!this.isEditable()&&this.currentMode!==z.MODE_SNAPSHOT&&("esriGeometryPolyline"===this.geometryType||"esriGeometryPolygon"===
this.geometryType||this.hasXYFootprint()))if(this._autoGeneralize=a){if((a=this._map)&&a.loaded)this._maxOffset=Math.floor(a.extent.getWidth()/a.width)}else delete this._maxOffset}else this._optAutoGen=a;return this},setGDBVersion:function(a){if(!this._collection&&a!==this.gdbVersion&&(a||this.gdbVersion))this.gdbVersion=a,this._task.gdbVersion=a,this._url.query=l.mixin(this._url.query,{gdbVersion:a}),this.loaded&&(this.clearSelection(),this._map&&this.refresh()),this.onGDBVersionChange();return this},
setDefinitionExpression:function(a){this._defnExpr=a;(a=this._mode)&&a.propertyChangeHandler(1);return this},getDefinitionExpression:function(){return this._defnExpr},setTimeDefinition:function(a){this._isSnapshot?(this._timeDefn=a,(a=this._mode)&&a.propertyChangeHandler(2)):console.log("FeatureLayer.setTimeDefinition: layer in on-demand or selection mode does not support time definitions. Layer id \x3d "+this.id+", Layer URL \x3d "+this.url);return this},getTimeDefinition:function(){return this._timeDefn},
setTimeOffset:function(a,b){this._timeOffset=a;this._timeOffsetUnits=b;var d=this._mode;d&&d.propertyChangeHandler(0);return this},setUseMapTime:function(a){this.useMapTime=a;this._toggleTime(!this.suspended);(a=this._mode)&&a.propertyChangeHandler(0)},selectFeatures:function(b,d,c,e){d=d||z.SELECTION_NEW;b=this._getShallowClone(b);var g=this._map,k,f=this,h=v._fixDfd(new s(v._dfdCanceller));b.outFields=this.getOutFields();b.returnGeometry=!0;b.multipatchOption=this.multipatchOption;g&&(b.outSpatialReference=
new C(g.spatialReference.toJson()));if(!this._applyQueryFilters(b,!0))return k={features:[]},this._selectHandler(k,d,c,e,h),h;if(g=this._canDoClientSideQuery(b))h._pendingDfd=a(this._doQuery(b,g)),h._pendingDfd.then(function(a){k={features:a};f._selectHandler(k,d,c,e,h)});else{if(this._collection)return this._resolve([Error("FeatureLayer::selectFeatures - "+this.invalidParams)],null,e,h,!0),h;var m=this;this._ts&&(b._ts=(new Date).getTime());(h._pendingDfd=this._task.execute(b)).addCallbacks(function(a){m._selectHandler(a,
d,c,e,h)},function(a){m._resolve([a],null,e,h,!0)})}return h},getSelectedFeatures:function(){var a=this._selectedFeatures,b=[],d;for(d in a)a.hasOwnProperty(d)&&b.push(a[d]);return b},clearSelection:function(a){var b=this._selectedFeatures,d=this._mode,c;for(c in b)b.hasOwnProperty(c)&&(this._unSelectFeatureIIf(c,d),d._removeFeatureIIf(c));this._selectedFeatures={};this._isSelOnly&&d._applyTimeFilter(!0);if(!a)this.onSelectionClear();return this},setSelectionSymbol:function(a){if(this._selectionSymbol=
a){var b=this._selectedFeatures,d;for(d in b)b.hasOwnProperty(d)&&b[d].setSymbol(a)}return this},getSelectionSymbol:function(){return this._selectionSymbol},setLabelingInfo:function(a){a?(this.labelingInfo=a,this._fixLabelExpr()):delete this.labelingInfo;this._collection&&(this._typesDirty=!0);this.onLabelingInfoChange()},_fixLabelExpr:function(){var a=/\[([^\[\]]+)\]/ig,b,d=this,c=function(a,b){var c=d._getField(b,!0);return"["+(c&&c.name||b)+"]"};m.forEach(this.labelingInfo,function(d){if(b=d.labelExpression)d.labelExpression=
b.replace(a,c)})},__msigns:[{n:"applyEdits",c:5,a:[{i:0},{i:1}],e:4,f:1}],applyEdits:function(a,b,d,c,e,g){var k=g.assembly,f=g.dfd;this._applyNormalized(a,k&&k[0]);this._applyNormalized(b,k&&k[1]);this.onBeforeApplyEdits(a,b,d);var h={},s=this.objectIdField,k={f:"json"},n=!1;if(this._collection)g={},g.addResults=a?m.map(a,function(){n=!0;return{objectId:this._nextId++,success:!0}},this):null,g.updateResults=b?m.map(b,function(a){n=!0;var b=a.attributes[s];h[b]=a;return{objectId:b,success:!0}},this):
null,g.deleteResults=d?m.map(d,function(a){n=!0;return{objectId:a.attributes[s],success:!0}},this):null,n&&this._editHandler(g,a,h,c,e,f);else{a&&0<a.length&&(k.adds=this._convertFeaturesToJson(a,0,1),n=!0);if(b&&0<b.length){for(g=0;g<b.length;g++){var p=b[g];h[p.attributes[s]]=p}k.updates=this._convertFeaturesToJson(b,0,0,1);n=!0}if(d&&0<d.length){b=[];for(g=0;g<d.length;g++)b.push(d[g].attributes[s]);k.deletes=b.join(",");n=!0}if(n){var t=this;return u({url:this._url.path+"/applyEdits",content:l.mixin(k,
this._url.query),callbackParamName:"callback",load:function(b){t._editHandler(b,a,h,c,e,f)},error:function(a){t._resolve([a],null,e,f,!0)}},{usePost:!0})}}},queryFeatures:function(a,b,d){return this._query("execute","onQueryFeaturesComplete",a,b,d)},queryRelatedFeatures:function(a,b,d){return this._query("executeRelationshipQuery","onQueryRelatedFeaturesComplete",a,b,d)},queryIds:function(a,b,d){return this._query("executeForIds","onQueryIdsComplete",a,b,d)},queryCount:function(a,b,d){return this._query("executeForCount",
"onQueryCountComplete",a,b,d)},queryExtent:function(a,b,d){return this._query("executeForExtent","onQueryExtentComplete",a,b,d)},queryAttachmentInfos:function(a,b,d){var c=this._url.path+"/"+a+"/attachments",g=new s(v._dfdCanceller),k=this;g._pendingDfd=u({url:c,content:l.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:function(d){d=d.attachmentInfos;var f;m.forEach(d,function(b){f=e.objectToQuery({gdbVersion:k._url.query&&k._url.query.gdbVersion,layer:k._url.query&&k._url.query.layer,
token:k._getToken()});b.url=c+"/"+b.id+(f?"?"+f:"");b.objectId=a});k._resolve([d],"onQueryAttachmentInfosComplete",b,g)},error:function(a){k._resolve([a],null,d,g,!0)}});return g},addAttachment:function(a,b,d,c){return this._sendAttachment("add",a,b,d,c)},updateAttachment:function(a,b,d,c,e){d.appendChild(h.create("input",{type:"hidden",name:"attachmentId",value:b}));return this._sendAttachment("update",a,d,c,e)},deleteAttachments:function(a,b,d,c){var e=this._url.path+"/"+a+"/deleteAttachments",
g=new s(v._dfdCanceller),k=this;b={f:"json",attachmentIds:b.join(",")};g._pendingDfd=u({url:e,content:l.mixin(b,this._url.query),callbackParamName:"callback",load:l.hitch(this,function(b){b=b.deleteAttachmentResults;b=m.map(b,function(b){b=new L(b);b.attachmentId=b.objectId;b.objectId=a;return b});k._resolve([b],"onDeleteAttachmentsComplete",d,g)}),error:function(a){k._resolve([a],null,c,g,!0)}},{usePost:!0});return g},addType:function(a){var b=this.types;if(b){if(m.some(b,function(b){return b.id==
a.id?!0:!1}))return!1;b.push(a)}else this.types=[a];return this._typesDirty=!0},deleteType:function(a){if(this._collection){var b=this.types;if(b){var d=-1;m.some(b,function(b,c){return b.id==a?(d=c,!0):!1});if(-1<d)return this._typesDirty=!0,b.splice(d,1)[0]}}},toJson:function(){var a=this._json;if(a=l.isString(a)?f.fromJson(a):l.clone(a)){var a=a.layerDefinition?a:{layerDefinition:a},b=a.layerDefinition,d=this._collection;if(d&&this._typesDirty){b.types=m.map(this.types||[],function(a){return a.toJson()});
var c=this.renderer,e=this.labelingInfo,g=b.drawingInfo;if((c||e)&&!g)g=b.drawingInfo={};g&&(c&&-1===c.declaredClass.indexOf("TemporalRenderer"))&&(g.renderer=c.toJson());e&&(g.labelingInfo=m.map(e,function(a){return a.toJson()}))}c=null;if(!d||this._fcAdded)c={geometryType:b.geometryType,features:this._convertFeaturesToJson(this.graphics,!0)};a.featureSet=l.mixin({},a.featureSet||{},c);d&&(a.nextObjectId=this._nextId,b.capabilities=this.capabilities);return a}},onSelectionComplete:function(){},onSelectionClear:function(){},
onBeforeApplyEdits:function(){},onEditsComplete:function(){},onQueryFeaturesComplete:function(){},onQueryRelatedFeaturesComplete:function(){},onQueryIdsComplete:function(){},onQueryCountComplete:function(){},onQueryExtentComplete:function(){},onQueryAttachmentInfosComplete:function(){},onAddAttachmentComplete:function(){},onUpdateAttachmentComplete:function(){},onDeleteAttachmentsComplete:function(){},onCapabilitiesChange:function(){},onGDBVersionChange:function(){},onQueryLimitExceeded:function(){},
onLabelingInfoChange:function(){},_forceIdentity:function(a){var d=this,c=this._url&&this._url.path;(this.ownershipBasedAccessControlForFeatures||this.userIsAdmin)&&!this._getToken()&&c&&b.id&&b.id._hasPortalSession()&&b.id._doPortalSignIn(c)?b.id.getCredential(c).then(function(){d._findCredential();a.call(d)},function(){a.call(d)}):a.call(this)},_checkMode:function(a){var b=this.geometryType,d=this.maxRecordCount;a=(a=a&&a.features&&a.features[0])&&a.attributes&&a.attributes.exceedslimit;if(this.mode===
z.MODE_AUTO&&!this.isEditable()&&0===a&&(this.queryPagination||("esriGeometryPolyline"===b||"esriGeometryPolygon"===b||"esriGeometryMultipoint"===b||this.hasXYFootprint())&&d>=this.maxRecordCountForAuto||"esriGeometryPoint"===b&&d>=this.maxPointCountForAuto))this.currentMode=z.MODE_SNAPSHOT,this._mode=new O(this),this._isSnapshot=!0,this._autoGeneralize=!1},_queryLimit:function(){var a=this,b=new s;this._limitPromise=b.promise;setTimeout(function(){var d=new G,c=new K;c.statisticType="exceedslimit";
c.maxPointCount=a.maxPointCountForAuto;c.maxRecordCount=a.maxRecordCountForAuto;c.maxVertexCount=a.maxVertexCountForAuto;c.outStatisticFieldName="exceedslimit";d.outStatistics=[c];a.queryFeatures(d).promise.then(function(a){b.resolve(a)},function(a){b.reject(a)})},0)},_updateCaps:function(){var a=this._editable,b=l.trim(this.capabilities||""),d=m.map(b?b.split(","):[],l.trim),c=m.map(b?b.toLowerCase().split(","):[],l.trim),b=m.indexOf(c,"editing"),e,c={Create:m.indexOf(c,"create"),Update:m.indexOf(c,
"update"),Delete:m.indexOf(c,"delete")};if(a&&-1===b)d.push("Editing");else if(!a&&-1<b){a=[b];for(e in c)-1<c[e]&&a.push(c[e]);a.sort();for(e=a.length-1;0<=e;e--)d.splice(a[e],1)}this.capabilities=d.join(",")},_counter:{value:0},_getUniqueId:function(){return this._counter.value++},onSuspend:function(){this.inherited(arguments);this._toggleTime(!1);var a=this._mode;a&&a.suspend()},onResume:function(a){this.inherited(arguments);this._toggleTime(!0);this._updateMaxOffset();var b=this._mode,d=this._map,
c=this._getRenderer();if(a.firstOccurrence){this._fixRendererFields();this._checkFields();this.clearSelection();if(this.timeInfo&&(this._trackIdField||c&&(c.latestObservationRenderer||c.trackRenderer)))this._trackManager=new P(this),this._trackManager.initialize(d);if(this.mode===z.MODE_AUTO&&this.currentMode===z.MODE_SNAPSHOT&&("esriGeometryPolyline"===this.geometryType||"esriGeometryPolygon"===this.geometryType||this.hasXYFootprint())&&!this.getMaxAllowableOffset())c=this.generalizeForScale,c=this.maxScale?
this.maxScale:this.minScale?Math.min(c,this.minScale):Math.min(c,ca.getScale(d,this.initialExtent)),this.setMaxAllowableOffset(d.extent.getWidth()/d.width/d.getScale()*c);this._zoomConnect=r.connect(d,"onZoomEnd",this,this._updateMaxOffset)}b&&(a.firstOccurrence?b.startup():b.resume())},_updateMaxOffset:function(){var a=this._map;a&&a.loaded&&this._autoGeneralize&&(this._maxOffset=Math.floor(a.extent.getWidth()/a.width))},_toggleTime:function(a){var b=this._map;a&&this.timeInfo&&this.useMapTime&&
b?(this._mapTimeExtent=b.timeExtent,this._timeConnect||(this._timeConnect=r.connect(b,"onTimeExtentChange",this,this._timeChangeHandler))):(this._mapTimeExtent=null,r.disconnect(this._timeConnect),this._timeConnect=null)},_timeChangeHandler:function(a){this._mapTimeExtent=a;(a=this._mode)&&a.propertyChangeHandler(0)},_getOffsettedTE:function(a){var b=this._timeOffset,d=this._timeOffsetUnits;return a&&b&&d?a.offset(-1*b,d):a},_getTimeOverlap:function(a,b){return a&&b?a.intersection(b):a||b},_getTimeFilter:function(a){var b=
this.getTimeDefinition(),d;if(b&&(d=this._getTimeOverlap(b,null),!d))return[!1];if(a){if(a=d?this._getTimeOverlap(a,d):a,!a)return[!1]}else a=d;return[!0,a]},_getAttributeFilter:function(a){var b=this.getDefinitionExpression();return a?b?"("+b+") AND ("+a+")":a:b},_applyQueryFilters:function(a,b){a.where=this._getAttributeFilter(a.where);a.maxAllowableOffset=this._maxOffset;b&&this.supportsAdvancedQueries&&(a.orderByFields=a.orderByFields||this.getOrderByFields());if(this.timeInfo){var d=this._getTimeFilter(a.timeExtent);
if(d[0])a.timeExtent=d[1];else return!1}return!0},_add:function(a){var b=this._selectionSymbol,d=a.attributes,c=this.visibilityField;b&&this._isSelOnly&&a.setSymbol(b);if(c&&d&&d.hasOwnProperty(c))a[d[c]?"show":"hide"]();return this.add.apply(this,arguments)},_remove:function(){return this.remove.apply(this,arguments)},_canDoClientSideQuery:function(a){var b=[],d=this._map;if(!(this._isTable||!d&&!this._collection))if(!a.text&&!(a.where&&a.where!==this.getDefinitionExpression()||a.orderByFields&&
a.orderByFields.length||a.outStatistics)){var c=this._isSnapshot,e=this._isSelOnly,g=a.geometry;if(g)if(!e&&a.spatialRelationship===G.SPATIAL_REL_INTERSECTS&&"extent"===g.type&&(c||d.extent.contains(g)))b.push(1);else return;if(d=a.objectIds)if(c)b.push(2);else{var g=d.length,k=this._mode,f=0,h;for(h=0;h<g;h++)k._getFeature(d[h])&&f++;if(f===g)b.push(2);else return}if(this.timeInfo)if(a=a.timeExtent,d=this._mapTimeExtent,c)a&&b.push(3);else if(e){if(a)return}else if(d)if(-1!==m.indexOf(b,2))a&&b.push(3);
else return;else if(0<b.length)a&&b.push(3);else if(a)return;return 0<b.length?b:null}},_getAbsMid:function(a){return q.toAbsMid?q.toAbsMid(a):p.id.replace(/\/[^\/]*$/ig,"/")+a},_doQuery:function(a,b,d){var c=[],e=this._mode,g=this.objectIdField,k=this,f,h,n=new s,p=new s,t=function(a,b){if(!a.length||!b.length)return a.length?a:b;var d,c,e={};a.length>b.length?(c=a,d=b):(c=b,d=a);for(var k=c.length,f=d.length,h;k--;)h=c[k],e[h.attributes[g]]=!0;for(;f--;)h=d[f],e[h.attributes[g]]||c.push(h);return c};
if(-1!==m.indexOf(b,1)){h=this.graphics;f=h.length;var q=this.spatialIndex||this._map&&this._map.spatialIndex,r,v=a.geometry._normalize(null,!0);null==q&&Q.autoSpatialIndexing?r=(this._map||this).addPlugin(this._getAbsMid("../plugins/spatialIndex")).then(l.hitch(this,l.partial(this._getFromIndex,v,q)),function(a){p.resolve(l.hitch(this,l.partial(this._filterByExtent,h,v)))}):q&&(r=this._getFromIndex(v,q));r?r.then(function(a){for(var b=0;b<a.length;b++)a[b].results&&(c=c.concat(a[b].results));p.resolve(c)}).otherwise(function(a){p.reject(a)}):
p.resolve(this._filterByExtent(h,v))}else p.resolve([]);p.then(function(c){var h=[];if(-1!==m.indexOf(b,2)){var s=a.objectIds;for(f=s.length;f--;){var l=e._getFeature(s[f]);l&&h.push(l)}h=t(c,h)}else h=c;-1!==m.indexOf(b,3)&&this.timeInfo&&(c=a.timeExtent,h=k._filterByTime(h,c.startTime,c.endTime).match);d&&(h=m.map(h,function(a){return a.attributes[g]},this));n.resolve(h)});return n},_getFromIndex:function(a,b){b=b||this.spatialIndex||this._map.spatialIndex;a instanceof Array||(a=[a]);var c=this.id;
return d(m.map(a,function(a){return b.intersects(a,c)}))},_filterByExtent:function(a,b){for(var d=[],c=0,e=a.length;c<e;c++){var g=a[c],k=g.geometry;k&&(this.normalization&&b.length?(b[0].intersects(k)||b[1].intersects(k))&&d.push(g):b.intersects(k)&&d.push(g))}return d},_filterByTime:function(a,b,d){var c=this._startTimeField,e=this._endTimeField,g;this._twoTimeFields||(g=c||e);var k=t.isDefined,h=[],f=[],m,s=a.length,l,n;b=b?b.getTime():-Infinity;d=d?d.getTime():Infinity;if(g)for(m=0;m<s;m++)l=
a[m],n=l.attributes,c=n[g],c>=b&&c<=d?h.push(l):f.push(l);else for(m=0;m<s;m++)l=a[m],n=l.attributes,g=n[c],n=n[e],g=k(g)?g:-Infinity,n=k(n)?n:Infinity,g>=b&&g<=d||n>=b&&n<=d||b>=g&&d<=n?h.push(l):f.push(l);return{match:h,noMatch:f}},_resolve:function(a,b,d,c,e){b&&this[b].apply(this,a);d&&d.apply(null,a);c&&v._resDfd(c,a,e)},_getShallowClone:function(a){var b=new G,d;for(d in a)a.hasOwnProperty(d)&&(b[d]=a[d]);return b},_query:function(b,d,c,e,g){var k=this,h=this._map,f=new s(v._dfdCanceller),m=
c,l=function(a,c){if(!c&&("execute"===b||"executeRelationshipQuery"===b)){var g,h;if("execute"===b){g=a.features;h=g.length;for(h-=1;0<=h;h--)if(g[h]._layer=k,!k._isTable){var m=k._mode._getFeature(g[h].attributes[k.objectIdField]);m&&g.splice(h,1,m)}}else for(m in a)if(a.hasOwnProperty(m)){g=a[m].features;h=g.length;for(h-=1;0<=h;h--)g[h]._layer=k}}k._resolve([a],d,e,f)};if("executeRelationshipQuery"!==b){m=this._getShallowClone(c);m.outFields=this.getOutFields();m.returnGeometry=c.hasOwnProperty("returnGeometry")?
c.returnGeometry:!c.outStatistics;m.returnGeometry&&(m.multipatchOption=this.multipatchOption);var n;h&&(m.outSpatialReference=new C(h.spatialReference.toJson()));if(!this._applyQueryFilters(m,"execute"===b)){switch(b){case "execute":n=new N({features:[]});break;case "executeForIds":n=[];break;case "executeForCount":n=0;break;case "executeForExtent":n={}}l(n,!0);return f}if(c="executeForExtent"!==b&&this._canDoClientSideQuery(m))return f._pendingDfd=a(this._doQuery(m,c,"executeForIds"===b||"executeForCount"===
b)),f._pendingDfd.then(function(a){switch(b){case "execute":n=new N;n.features=a;break;case "executeForIds":n=a;break;case "executeForCount":n=a.length}l(n,!0)}),f}if(this._collection)return this._resolve([Error("FeatureLayer::_query - "+this.invalidParams)],null,g,f,!0),f;this._ts&&(m._ts=(new Date).getTime());(f._pendingDfd=this._task[b](m)).addCallbacks(l,function(a){k._resolve([a],null,g,f,!0)});return f},_convertFeaturesToJson:function(a,b,d,c){var e=[],g=this._selectionSymbol,k=this.visibilityField,
h,s=this.objectIdField;if(this.loaded&&(d||c))h=m.filter(this.fields,function(a){return!1===a.editable&&(!c||a.name!==s)});for(d=0;d<a.length;d++){var n=a[d],p={},t=n.geometry,q=n.attributes,r=n.symbol;if(t&&(!c||!this.loaded||this.allowGeometryUpdates))p.geometry=t.toJson();k?(p.attributes=q=l.mixin({},q),q[k]=n.visible?1:0):q&&(p.attributes=l.mixin({},q));p.attributes&&(h&&h.length)&&m.forEach(h,function(a){delete p.attributes[a.name]});r&&r!==g&&(p.symbol=r.toJson());e.push(p)}return b?e:f.toJson(e)},
_selectHandler:function(a,b,d,c,e){var g;c=z;switch(b){case c.SELECTION_NEW:this.clearSelection(!0);g=!0;break;case c.SELECTION_ADD:g=!0;break;case c.SELECTION_SUBTRACT:g=!1}c=a.features;var k=this._mode,h=[],f=this.objectIdField,m,l;if(g)for(g=0;g<c.length;g++)m=c[g],l=m.attributes[f],m=k._addFeatureIIf(l,m),h.push(m),this._selectFeatureIIf(l,m,k);else for(g=0;g<c.length;g++)m=c[g],l=m.attributes[f],this._unSelectFeatureIIf(l,k),l=k._removeFeatureIIf(l),h.push(l||m);this._isSelOnly&&k._applyTimeFilter(!0);
this._resolve([h,b,a.exceededTransferLimit?{queryLimitExceeded:!0}:null],"onSelectionComplete",d,e);if(a.exceededTransferLimit)this.onQueryLimitExceeded()},_selectFeatureIIf:function(a,b,d){var c=this._selectedFeatures,e=c[a];e||(d._incRefCount(a),c[a]=b,this._isTable||(this._setSelectSymbol(b),b.attr("data-selected","")));return e||b},_unSelectFeatureIIf:function(a,b){var d=this._selectedFeatures[a];d&&(b._decRefCount(a),delete this._selectedFeatures[a],this._isTable||(this._setUnSelectSymbol(d),
d.attr("data-selected")));return d},_isSelected:function(a){},_setSelectSymbol:function(a){var b=this._selectionSymbol;b&&!this._isSelOnly&&a.setSymbol(b)},_setUnSelectSymbol:function(a){var b=this._selectionSymbol;b&&!this._isSelOnly&&b===a.symbol&&a.setSymbol(null,!0)},_getOutFields:function(){var a=[this.objectIdField,this.typeIdField,this.creatorField,this._startTimeField,this._endTimeField,this._trackIdField].concat(this._rendererFields).concat(this.dataAttributes),a=m.filter(a,function(a,b,
d){return!!a&&m.indexOf(d,a)===b}),b=l.clone(this._outFields);if(b){if(-1!==m.indexOf(b,"*"))return b;m.forEach(a,function(a){-1===m.indexOf(b,a)&&b.push(a)});return b}return a},_checkFields:function(a){var b=a||this._getOutFields();m.forEach(b,function(a){"*"!==a&&(this._getField(a)||console.debug("esri.layers.FeatureLayer: "+t.substitute({url:this.url,field:a},"unable to find '${field}' field in the layer 'fields' information [url: ${url}]")))},this);!a&&(!this._isTable&&!this._fserver&&!this._collection)&&
(m.some(this.fields,function(a){return a&&"esriFieldTypeGeometry"===a.type?!0:!1})||console.debug("esri.layers.FeatureLayer: "+t.substitute({url:this.url},"unable to find a field of type 'esriFieldTypeGeometry' in the layer 'fields' information. If you are using a map service layer, features will not have geometry [url: ${url}]")))},_fixRendererFields:function(){var a=this.renderer;this._orderBy=null;if(a&&0<this.fields.length){var b=[],d,c,a=m.filter([a,a.observationRenderer,a.latestObservationRenderer,
a.trackRenderer],t.isDefined),e=[].concat(a);m.forEach(a,function(a){m.forEach(a.rendererInfos,function(a){a.renderer&&e.push(a.renderer)})});m.forEach(e,function(a){if((c=a.attributeField)&&!l.isFunction(c))if(d=!this._getField(c)&&this._getField(c,!0))a.attributeField=d.name;if(c=a.attributeField2)if(d=!this._getField(c)&&this._getField(c,!0))a.attributeField2=d.name;if(c=a.attributeField3)if(d=!this._getField(c)&&this._getField(c,!0))a.attributeField3=d.name;l.isFunction(a.attributeField)||b.push(a.attributeField);
b.push(a.attributeField2);b.push(a.attributeField3);if((c=a.rotationInfo&&a.rotationInfo.field)&&!l.isFunction(c)){if(d=!this._getField(c)&&this._getField(c,!0))c=a.rotationInfo.field=d.name;b.push(c)}if(a.proportionalSymbolInfo){if((c=a.proportionalSymbolInfo.field)&&!l.isFunction(c)){if(d=!this._getField(c)&&this._getField(c,!0))c=a.proportionalSymbolInfo.field=d.name;b.push(c);this._orderBy||(this._orderBy=[c+" DESC"])}if((c=a.proportionalSymbolInfo.normalizationField)&&!l.isFunction(c)){if(d=
!this._getField(c)&&this._getField(c,!0))c=a.proportionalSymbolInfo.normalizationField=d.name;b.push(c)}}if(a.colorInfo){if((c=a.colorInfo.field)&&!l.isFunction(c)){if(d=!this._getField(c)&&this._getField(c,!0))c=a.colorInfo.field=d.name;b.push(c)}if((c=a.colorInfo.normalizationField)&&!l.isFunction(c)){if(d=!this._getField(c)&&this._getField(c,!0))c=a.colorInfo.normalizationField=d.name;b.push(c)}}if(!this._orderBy&&a.addBreak&&!l.isFunction(a.attributeField)&&(a.backgroundFillSymbol||this._hasSizeDiff(a)))this._orderBy=
[a.attributeField+" DESC"]},this);this._rendererFields=m.filter(b,t.isDefined)}},_hasSizeDiff:function(a){var b=Number.MAX_VALUE,d=-Number.MAX_VALUE,c,e;m.forEach(a.infos,function(a){if(e=a.symbol){c=0;switch(e.type){case "simplemarkersymbol":c=e.size;break;case "picturemarkersymbol":c=(e.width+e.height)/2;break;case "simplelinesymbol":case "cartographiclinesymbol":c=e.width;break;case "simplefillsymbol":case "picturefillsymbol":c=e.outline&&e.outline.width}c&&(b=Math.min(b,c),d=Math.max(d,c))}});
return b!==Number.MAX_VALUE&&d!==-Number.MAX_VALUE&&1<Math.abs(d-b)},getOrderByFields:function(){var a=this.orderByFields||this._orderBy;return this.supportsAdvancedQueries&&a?m.filter(a,function(a){a=a.split(" ")[0];return!!this._getField(a,!0)},this):null},_getField:function(a,b){var d=this.fields;if(!d||0===d.length)return null;var c;b&&(a=a.toLowerCase());m.some(d,function(d){var e=!1;(e=b?d&&d.name.toLowerCase()===a?!0:!1:d&&d.name===a?!0:!1)&&(c=d);return e});return c},_getDateOpts:function(){this._dtOpts||
(this._dtOpts={properties:m.map(m.filter(this.fields,function(a){return!!(a&&"esriFieldTypeDate"===a.type)}),function(a){return a.name})});return this._dtOpts},_applyNormalized:function(a,b){a&&b&&m.forEach(a,function(a,d){a&&b[d]&&a.setGeometry(b[d])})},_editHandler:function(a,b,d,c,e,g){e=a.addResults;var k=a.updateResults;a=a.deleteResults;var h,f,l,s,n=this.objectIdField,p=this._mode,t=this._isTable;h=this.editFieldsInfo;var q=this.getOutFields()||[],r=h&&h.creatorField,v=h&&h.creationDateField,
u=h&&h.editorField,y=h&&h.editDateField;h=h&&h.realm;-1===m.indexOf(q,"*")&&(r&&-1===m.indexOf(q,r)&&(r=null),v&&-1===m.indexOf(q,v)&&(v=null),u&&-1===m.indexOf(q,u)&&(u=null),y&&-1===m.indexOf(q,y)&&(y=null));var q=v||y?(new Date).getTime():null,w=r||u?this.getUserId():void 0;w&&h&&(w=w+"@"+h);if(e)for(h=0;h<e.length;h++)e[h]=new L(e[h]),t||(f=e[h],f.success&&(f=f.objectId,l=b[h],(s=l._graphicsLayer)&&s!==this&&s.remove(l),s=l.attributes||{},s[n]=f,r&&(s[r]=w),u&&(s[u]=w),v&&(s[v]=q),y&&(s[y]=q),
l.setAttributes(s),p._init&&p.drawFeature(l)));if(k)for(h=0;h<k.length;h++)if(k[h]=new L(k[h]),!t&&(f=k[h],f.success)){f=f.objectId;l=d[f];if(b=p._getFeature(f))b.geometry!==l.geometry&&b.setGeometry(E.fromJson(l.geometry.toJson())),this._repaint(b,f);l=b||l;s=l.attributes||{};u&&(s[u]=w);y&&(s[y]=q);l.setAttributes(s)}if(a){d=[];for(h=0;h<a.length;h++)if(a[h]=new L(a[h]),!t&&(f=a[h],f.success&&(f=f.objectId,l=p._getFeature(f))))this._unSelectFeatureIIf(f,p)&&d.push(l),l._count=0,p._removeFeatureIIf(f);
if(0<d.length)this.onSelectionComplete(d,z.SELECTION_SUBTRACT)}this._resolve([e,k,a],"onEditsComplete",c,g)},_sendAttachment:function(a,b,d,c,e){var g=this;return u({url:this._url.path+"/"+b+"/"+("add"===a?"addAttachment":"updateAttachment"),form:d,content:l.mixin(this._url.query,{f:"json",token:this._getToken()||void 0}),callbackParamName:"callback.html",handleAs:"json"}).addCallback(function(d){var e="add"===a?"onAddAttachmentComplete":"onUpdateAttachmentComplete";d=new L(d["add"===a?"addAttachmentResult":
"updateAttachmentResult"]);d.attachmentId=d.objectId;d.objectId=b;g._resolve([d],e,c);return d}).addErrback(function(a){g._resolve([a],null,e,null,!0)})},_repaint:function(a,b,d){b=t.isDefined(b)?b:a.attributes[this.objectIdField];(!(b in this._selectedFeatures)||!this._selectionSymbol)&&a.setSymbol(a.symbol,d)},_getKind:function(a){var b=this._trackManager;return b?b.isLatestObservation(a)?1:0:0}});l.mixin(z,{MODE_SNAPSHOT:0,MODE_ONDEMAND:1,MODE_SELECTION:2,SELECTION_NEW:3,SELECTION_ADD:4,SELECTION_SUBTRACT:5,
MODE_AUTO:6,MODE_STREAM:7,POPUP_NONE:"esriServerHTMLPopupTypeNone",POPUP_HTML_TEXT:"esriServerHTMLPopupTypeAsHTMLText",POPUP_URL:"esriServerHTMLPopupTypeAsURL"});ba._createWrappers(z);g("extend-esri")&&l.setObject("layers.FeatureLayer",z,b);return z})},"esri/layers/CSVLayer":function(){define("dojo/_base/array dojo/_base/declare dojo/_base/lang dojo/has ../kernel ../arcgis/csv ./FeatureLayer ../geometry/Extent ../tasks/FeatureSet".split(" "),function(q,p,n,r,l,m,f,s,c){p=p(f,{declaredClass:"esri.layers.CSVLayer",
_preventInit:!0,_fieldTypeMap:{Date:"esriFieldTypeDate",Number:"esriFieldTypeDouble",String:"esriFieldTypeString"},constructor:function(c,e){this.url=c;e=n.mixin(e,{outFields:["*"]});this.columnDelimiter=e.columnDelimiter;this.latitudeFieldName=e.latitudeFieldName;this.longitudeFieldName=e.longitudeFieldName;var h=e.layerDefinition;h||(h={fields:e.fields||[],geometryType:"esriGeometryPoint",copyrightText:e.copyright},e.fields&&q.forEach(e.fields,n.hitch(this,function(c){c.type=this._fieldTypeMap[c.type||
"String"];c.alias||(c.alias=c.name)})));this._buildCsvFcParam={url:this.url,columnDelimiter:this.columnDelimiter,layerDefinition:h};this.latitudeFieldName&&this.longitudeFieldName&&(this._buildCsvFcParam.locationInfo={locationType:"coordinates",latitudeFieldName:this.latitudeFieldName,longitudeFieldName:this.longitudeFieldName});this._projectFeatures=n.hitch(this,this._projectFeatures);this._addFeatures=n.hitch(this,this._addFeatures);this._initCSVLayer(e)},refresh:function(){this._fireUpdateStart();
this.applyEdits(null,null,this.graphics);this._loadFeatures()},_setMap:function(c){var e=this.inherited(arguments);this._fireUpdateStart();this._projectFeatures(this._csvFC).then(this._addFeatures).otherwise(this._errorHandler);this._csvFC=null;return e},_initCSVLayer:function(c){var e=this;m.buildCSVFeatureCollection(this._buildCsvFcParam).then(function(h){e._csvFC=h;var k=h.layerDefinition;k.extent=e._getFCExtent(h);e._initFeatureLayer({layerDefinition:k},c)}).otherwise(this._errorHandler)},_loadFeatures:function(){m.buildCSVFeatureCollection(this._buildCsvFcParam).then(this._projectFeatures).then(this._addFeatures).otherwise(this._errorHandler)},
_projectFeatures:function(c){return m.projectFeatureCollection(c,this._map.spatialReference)},_addFeatures:function(g){g=new c(g.featureSet);this.applyEdits(g.features,null,null);this._fireUpdateEnd()},_getFCExtent:function(c){var e;if(c&&c.featureSet&&c.featureSet.features){c=c.featureSet.features;var h=c.length;if(1<h){var k=c[0].geometry;e=new s(k.x,k.y,k.x,k.y);for(h-=1;0<h;h--)k=c[h].geometry,e.xmin=Math.min(e.xmin,k.x),e.ymin=Math.min(e.ymin,k.y),e.xmax=Math.max(e.xmax,k.x),e.ymax=Math.max(e.ymax,
k.y);0>=e.getWidth()&&0>=e.getHeight()&&(e=null)}}return e}});r("extend-esri")&&n.setObject("layers.CSVLayer",p,l);return p})},"dojo/DeferredList":function(){define(["./_base/kernel","./_base/Deferred","./_base/array"],function(q,p,n){q.DeferredList=function(q,l,m,f,s){var c=[];p.call(this);var g=this;0===q.length&&!l&&this.resolve([0,[]]);var e=0;n.forEach(q,function(h,k){function a(a,b){c[k]=[a,b];e++;e===q.length&&g.resolve(c)}h.then(function(d){l?g.resolve([k,d]):a(!0,d)},function(d){m?g.reject(d):
a(!1,d);if(f)return null;throw d;})})};q.DeferredList.prototype=new p;q.DeferredList.prototype.gatherResults=function(p){p=new q.DeferredList(p,!1,!0,!1);p.addCallback(function(l){var m=[];n.forEach(l,function(f){m.push(f[1])});return m});return p};return q.DeferredList})},"esri/layers/KMLFolder":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/has","../kernel","../lang"],function(q,p,n,r,l){q=q(null,{declaredClass:"esri.layers.KMLFolder",constructor:function(m){p.mixin(this,m);l.isDefined(this.visibility)&&
(this.visible=!!this.visibility)}});n("extend-esri")&&p.setObject("layers.KMLFolder",q,r);return q})},"esri/layers/TrackManager":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has ../kernel ../graphic ../geometry/Polyline ./GraphicsLayer".split(" "),function(q,p,n,r,l,m,f,s){q=q(null,{declaredClass:"esri.layers._TrackManager",constructor:function(c){this.layer=c;this.trackMap={};this.trackLineMap={}},initialize:function(c){this.map=c;var g=this.layer,e=g._getRenderer(),
e=e&&e.trackRenderer;if("esriGeometryPoint"===g.geometryType){var h=this.container=new s._GraphicsLayer({id:g.id+"_tracks",_child:!0});h.loaded=!0;h.onLoad(h);h._setMap(c,g._div);h.setRenderer(e)}},addFeatures:function(c){var g=this.trackMap,e=this.layer,h=e._trackIdField,k=[];n.forEach(c,function(a){var b=a.attributes[h];(g[b]=g[b]||[]).push(a);-1===n.indexOf(k,b)&&k.push(b)});var a=e._startTimeField,d=e.objectIdField,b=function(b,c){var e=b.attributes[a],g=c.attributes[a];return e===g?b.attributes[d]<
c.attributes[d]?-1:1:e<g?-1:1};n.forEach(k,function(a){g[a].sort(b)})},trimTracks:function(c){function g(a){for(a=e[a]||[];a.length>h;)k.push(a.shift())}var e=this.trackMap,h=this.layer.maximumTrackPoints||0,k=[],a;if(!h)return k;if(c)n.forEach(c,function(a){g(a)});else for(a in e)e.hasOwnProperty(a)&&g(a);return k},drawTracks:function(c){function g(b){var c=k[b],g,l,s;l=e.trackLineMap[b];h.remove(l);delete e.trackLineMap[b];if(!c||2>c.length)return!1;l=[];for(g=c.length-1;0<=g;g--)(s=c[g].geometry)&&
l.push([s.x,s.y]);c={};c[d]=b;1<l.length&&(l=new m(new f({paths:[l],spatialReference:a}),null,c),h.add(l),e.trackLineMap[b]=l)}var e=this,h=this.container,k,a,d,b;if(h)if(k=this.trackMap,a=this.map.spatialReference,d=this.layer._trackIdField,c)n.forEach(c,function(a){g(a)});else for(b in k)k.hasOwnProperty(b)&&g(b)},refreshTracks:function(c){function g(b){var d,c;e.drawTracks([b]);if(a&&a.latestObservationRenderer){b=h[b]||[];d=b.length;for(c=0;c<d;c++)k._repaint(b[c],null,!0)}}var e=this,h=this.trackMap,
k=this.layer,a=k._getRenderer(),d;if(c)n.forEach(c,function(a){g(a)});else for(d in h)h.hasOwnProperty(d)&&g(d);this.moveLatestToFront()},moveLatestToFront:function(c){n.forEach(this.getLatestObservations(c),function(c){var e=c._shape;e&&e._moveToFront();this._repaint(c,null,!0)},this.layer)},getLatestObservations:function(c){function g(a){a=k[a];return a[a.length-1]}var e=[],h=this.layer._getRenderer(),k=this.trackMap,a;if(!h.latestObservationRenderer)return e;if(c)n.forEach(c,function(a){e.push(g(a))});
else for(a in k)k.hasOwnProperty(a)&&e.push(g(a));return e},clearTracks:function(c){var g=this.getLatestObservations(c),e=this.container,h;c?n.forEach(c,function(c){delete this.trackMap[c];e&&(h=this.trackLineMap[c],e.remove(h),delete this.trackLineMap[c])},this):(this.trackMap={},this.trackLineMap={},e&&e.clear());n.forEach(g,function(c){this._repaint(c,null,!0)},this.layer)},isLatestObservation:function(c){var g=this.trackMap[c.attributes[this.layer._trackIdField]];return g?g[g.length-1]===c:!1},
destroy:function(){var c=this.container;c&&(c.clear(),c._unsetMap(this.map,this.layer._div));this.map=this.layer=this.trackMap=this.container=null}});r("extend-esri")&&p.setObject("layers._TrackManager",q,l);return q})},"esri/layers/WMSLayer":function(){define("require dojo/_base/kernel dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has ../kernel ../request ../urlUtils ../SpatialReference ../geometry/Extent ./DynamicMapServiceLayer ./WMSLayerInfo dojo/query".split(" "),function(q,p,n,r,
l,m,f,s,c,g,e,h,k){n=n([h],{declaredClass:"esri.layers.WMSLayer",_CRS_TO_EPSG:{84:4326,83:4269,27:4267},_REVERSED_LAT_LONG_RANGES:[[4001,4999],[2044,2045],[2081,2083],[2085,2086],[2093,2093],[2096,2098],[2105,2132],[2169,2170],[2176,2180],[2193,2193],[2200,2200],[2206,2212],[2319,2319],[2320,2462],[2523,2549],[2551,2735],[2738,2758],[2935,2941],[2953,2953],[3006,3030],[3034,3035],[3058,3059],[3068,3068],[3114,3118],[3126,3138],[3300,3301],[3328,3335],[3346,3346],[3350,3352],[3366,3366],[3416,3416],
[20004,20032],[20064,20092],[21413,21423],[21473,21483],[21896,21899],[22171,22177],[22181,22187],[22191,22197],[25884,25884],[27205,27232],[27391,27398],[27492,27492],[28402,28432],[28462,28492],[30161,30179],[30800,30800],[31251,31259],[31275,31279],[31281,31290],[31466,31700]],_WEB_MERCATOR:[102100,3857,102113,900913],_WORLD_MERCATOR:[3395,54004],allExtents:[],version:null,constructor:function(a,d){var b=c.urlToObject(a);if(b.query&&(b.query.version||b.query.Version||b.query.VERSION))this.version=
b.query.version||b.query.Version||b.query.VERSION;this.url=a=this._stripParameters(a,"version service request bbox format height width layers srs crs styles transparent bgcolor exceptions time elevation sld wfs".split(" "));this._url=c.urlToObject(a);this._getCapabilitiesURL=a;this._initLayer=r.hitch(this,this._initLayer);this._parseCapabilities=r.hitch(this,this._parseCapabilities);this._getCapabilitiesError=r.hitch(this,this._getCapabilitiesError);d?(this.imageFormat=this._getImageFormat(d.format),
this.imageTransparency=!1===d.transparent?!1:!0,this.visibleLayers=d.visibleLayers?d.visibleLayers:[],this.version=d.version||this.version,d.resourceInfo?this._readResourceInfo(d.resourceInfo):this._getCapabilities()):(this.imageFormat="image/png",this.imageTransparency=!0,this.visibleLayers=[],this._getCapabilities());this._blankImageURL=q.toUrl("../images/pixel.png")},setVisibleLayers:function(a){this.visibleLayers=(a=this._checkVisibleLayersList(a))?a:[];this.refresh(!0)},setImageFormat:function(a){this.imageFormat=
this._getImageFormat(a);this.refresh(!0)},setImageTransparency:function(a){this.imageTransparency=a;this.refresh(!0)},getImageUrl:function(a,d,b,e){if(!this.visibleLayers||0===this.visibleLayers.length)e(this._blankImageURL);else{var g=a.spatialReference.wkid;-1===l.indexOf(this.spatialReferences,g)&&a.spatialReference.latestWkid&&(g=a.spatialReference.latestWkid);if(l.some(this._WEB_MERCATOR,function(a){return a==g})){var k=l.filter(this.spatialReferences,function(a){return l.some(this._WEB_MERCATOR,
function(b){return b==a})},this);0==k.length&&(k=l.filter(this.spatialReferences,function(a){return l.some(this._WORLD_MERCATOR,function(b){return b==a})},this));g=0<k.length?k[0]:this._WEB_MERCATOR[0]}this.spatialReferences=l.filter(this.spatialReferences,function(a){return a!==g});this.spatialReferences.unshift(g);var k=a.xmin,h=a.xmax,f=a.ymin,m=a.ymax;a={SERVICE:"WMS",REQUEST:"GetMap"};a.FORMAT=this.imageFormat;a.TRANSPARENT=this.imageTransparency?"TRUE":"FALSE";a.STYLES="";a.VERSION=this.version;
a.LAYERS=this.visibleLayers?this.visibleLayers.toString():null;a.WIDTH=d;a.HEIGHT=b;this.maxWidth<d&&(a.WIDTH=this.maxWidth);this.maxHeight<b&&(a.HEIGHT=this.maxHeight);d=g?g:NaN;isNaN(d)||("1.3.0"==this.version?a.CRS="EPSG:"+d:a.SRS="EPSG:"+d);"1.3.0"==this.version&&this._useLatLong(d)?a.BBOX=f+","+k+","+m+","+h:a.BBOX=k+","+f+","+h+","+m;d=this.getMapURL;var s;d+=-1==d.indexOf("?")?"?":"";for(s in a)d+="?"==d.substring(d.length-1,d.length)?"":"\x26",d+=s+"\x3d"+a[s];e(c.addProxy(d))}},_initLayer:function(a,
d){this.spatialReference=new g(this.extent.spatialReference);this.initialExtent=new e(this.extent);this.fullExtent=new e(this.extent);this.visibleLayers=this._checkVisibleLayersList(this.visibleLayers);this.loaded=!0;this.onLoad(this);var b=this._loadCallback;b&&(delete this._loadCallback,b(this))},_readResourceInfo:function(a){a.extent?a.layerInfos?(this.extent=a.extent,this.allExtents[0]=a.extent,this.layerInfos=a.layerInfos,this.description=a.description?a.description:"",this.copyright=a.copyright?
a.copyright:"",this.title=a.title?a.title:"",this.getMapURL=a.getMapURL?a.getMapURL:this._getCapabilitiesURL,this.version=a.version?a.version:"1.3.0",this.maxWidth=a.maxWidth?a.maxWidth:5E3,this.maxHeight=a.maxHeight?a.maxHeight:5E3,this.spatialReferences=a.spatialReferences?a.spatialReferences:[],this.imageFormat=this._getImageFormat(a.format),this.setScaleRange(a.minScale,a.maxScale),this._initLayer()):console.error("esri.layers.WMSLayer: unable to find the 'layerInfos' property in resourceInfo"):
console.error("esri.layers.WMSLayer: unable to find the 'extent' property in resourceInfo")},_getCapabilities:function(){var a=this._url.query?this._url.query:{};a.SERVICE="WMS";a.REQUEST="GetCapabilities";this.version&&(a.VERSION=this.version);var d=this._url.path+"?",b;for(b in a)d+="?"==d.substring(d.length-1,d.length)?"":"\x26",d+=b+"\x3d"+a[b];s({url:d,handleAs:"xml",headers:{"Content-Type":null},load:this._parseCapabilities,error:this._getCapabilitiesError},{usePost:!1})},_parseCapabilities:function(a){if(a){this.version=
this._getAttributeValue("WMS_Capabilities","version",a,null);this.version||(this.version=this._getAttributeValue("WMT_MS_Capabilities","version",a,"1.3.0"));var d=this._getTag("Service",a);this.title=this._getTagValue("Title",d,"");if(!this.title||0==this.title.length)this.title=this._getTagValue("Name",d,"");this.copyright=this._getTagValue("AccessConstraints",d,"");this.description=this._getTagValue("Abstract",d,"");this.maxWidth=parseInt(this._getTagValue("MaxWidth",d,5E3),10);this.maxHeight=parseInt(this._getTagValue("MaxHeight",
d,5E3),10);if(d=this._getTag("Layer",a)){var b=this._getLayerInfo(d),c=0,g=null,d=this._getTag("Capability",a);l.forEach(d.childNodes,function(a){"Layer"==a.nodeName&&(0===c?g=a:(1===c&&b.name&&(b.name="",b.subLayers=[],b.subLayers.push(this._getLayerInfo(g))),b.subLayers.push(this._getLayerInfo(a))),c++)},this);if(b){this.layerInfos=b.subLayers;if(!this.layerInfos||0==this.layerInfos.length)this.layerInfos=[b];this.extent=b.extent;this.extent||(b.extent=new e(this.layerInfos[0].extent.toJson()),
this.extent=b.extent);this.allExtents=b.allExtents;if(!this.allExtents||!this.allExtents.length)b.allExtents=[],dojo.forEach(this.layerInfos[0].allExtents,function(a,d){a&&(b.allExtents[d]=new e(a.toJson()))}),this.allExtents=b.allExtents;this.spatialReferences=b.spatialReferences;0==this.spatialReferences.length&&0<this.layerInfos.length&&(this.spatialReferences=this.layerInfos[0].spatialReferences)}this.getMapURL=this._getCapabilitiesURL;if((d=p.query("DCPType",this._getTag("GetMap",a)))&&0<d.length)if((d=
p.query("HTTP",d[0]))&&0<d.length)if((d=p.query("Get",d[0]))&&0<d.length)if(d=this._getAttributeValue("OnlineResource","xlink:href",d[0],null))d.indexOf("\x26")==d.length-1&&(d=d.substring(0,d.length-1)),this.getMapURL=d;this.getMapFormats=[];0==p.query("Operation",a).length?l.forEach(p.query("Format",this._getTag("GetMap",a)),function(a){this.getMapFormats.push(a.text?a.text:a.textContent)},this):l.forEach(p.query("Operation",a),function(a){"GetMap"==a.getAttribute("name")&&l.forEach(p.query("Format",
a),function(a){this.getMapFormats.push(a.text?a.text:a.textContent)},this)},this);l.some(this.getMapFormats,function(a){return-1<a.indexOf(this.imageFormat)},this)||(this.imageFormat=this.getMapFormats[0]);this._initLayer()}else this._getCapabilitiesError({error:{message:"Response does not contain any layers."}})}else this.onError("GetCapabilities request for "+this._getCapabilitiesURL+" failed. (Response is null.)")},_getCapabilitiesError:function(a,d){this.onError("GetCapabilities request for "+
this._getCapabilitiesURL+" failed.",a)},_getLayerInfo:function(a){if(!a)return null;var d=new k;d.name="";d.title="";d.description="";d.allExtents=[];d.spatialReferences=[];d.subLayers=[];var b=this._getTag("LatLonBoundingBox",a);b&&(d.allExtents[0]=this._getExtent(b,4326));var c=this._getTag("EX_GeographicBoundingBox",a);if(c){var h=new e(0,0,0,0,new g({wkid:4326}));h.xmin=parseFloat(this._getTagValue("westBoundLongitude",c,0));h.ymin=parseFloat(this._getTagValue("southBoundLatitude",c,0));h.xmax=
parseFloat(this._getTagValue("eastBoundLongitude",c,0));h.ymax=parseFloat(this._getTagValue("northBoundLatitude",c,0));d.allExtents[0]=h}!b&&!c&&(h=new e(-180,-90,180,90,new g({wkid:4326})),d.allExtents[0]=h);d.extent=d.allExtents[0];var f=-1<l.indexOf(["1.0.0","1.1.0","1.1.1"],this.version)?"SRS":"CRS";l.forEach(a.childNodes,function(a){if("Name"==a.nodeName)d.name=(a.text?a.text:a.textContent)||"";else if("Title"==a.nodeName)d.title=(a.text?a.text:a.textContent)||"";else if("Abstract"==a.nodeName)d.description=
(a.text?a.text:a.textContent)||"";else if("BoundingBox"==a.nodeName){var b=a.getAttribute(f);b&&0===b.indexOf("EPSG:")?(b=parseInt(b.substring(5),10),0!==b&&!isNaN(b)&&(a="1.3.0"==this.version?this._getExtent(a,b,this._useLatLong(b)):this._getExtent(a,b),d.allExtents[b]=a,d.extent||(d.extent=a))):b&&0===b.indexOf("CRS:")?(b=parseInt(b.substring(4),10),0!==b&&!isNaN(b)&&(this._CRS_TO_EPSG[b]&&(b=this._CRS_TO_EPSG[b]),d.allExtents[b]=this._getExtent(a,b))):(b=parseInt(b,10),0!==b&&!isNaN(b)&&(d.allExtents[b]=
this._getExtent(a,b)))}else if(a.nodeName==f)a=(a.text?a.text:a.textContent).split(" "),l.forEach(a,function(a){a=-1<a.indexOf(":")?parseInt(a.split(":")[1],10):parseInt(a,10);0!==a&&!isNaN(a)&&(this._CRS_TO_EPSG[a]&&(a=this._CRS_TO_EPSG[a]),-1==l.indexOf(d.spatialReferences,a)&&d.spatialReferences.push(a))},this);else if("Style"==a.nodeName){if(a=this._getTag("LegendURL",a))if(a=this._getTag("OnlineResource",a))d.legendURL=a.getAttribute("xlink:href")}else"Layer"===a.nodeName&&d.subLayers.push(this._getLayerInfo(a))},
this);d.title=d.title||d.name;return d},_getImageFormat:function(a){switch(a?a.toLowerCase():""){case "jpg":return"image/jpeg";case "bmp":return"image/bmp";case "gif":return"image/gif";case "svg":return"image/svg+xml";default:return"image/png"}},getImageFormat:function(){switch(this.imageFormat?this.imageFormat.toLowerCase():""){case "image/jpeg":return"jpg";case "image/bmp":return"bmp";case "image/gif":return"gif";case "image/svg+xml":return"svg";default:return"png"}},_getExtent:function(a,d,b){var c;
if(a){c=new e;var k=parseFloat(a.getAttribute("minx")),h=parseFloat(a.getAttribute("miny")),f=parseFloat(a.getAttribute("maxx"));a=parseFloat(a.getAttribute("maxy"));b?(c.xmin=isNaN(h)?-1*Number.MAX_VALUE:h,c.ymin=isNaN(k)?-1*Number.MAX_VALUE:k,c.xmax=isNaN(a)?Number.MAX_VALUE:a,c.ymax=isNaN(f)?Number.MAX_VALUE:f):(c.xmin=isNaN(k)?-1*Number.MAX_VALUE:k,c.ymin=isNaN(h)?-1*Number.MAX_VALUE:h,c.xmax=isNaN(f)?Number.MAX_VALUE:f,c.ymax=isNaN(a)?Number.MAX_VALUE:a);c.spatialReference=new g({wkid:d})}return c},
_useLatLong:function(a){var d,b;for(b=0;b<this._REVERSED_LAT_LONG_RANGES.length;b++){var c=this._REVERSED_LAT_LONG_RANGES[b];if(a>=c[0]&&a<=c[1]){d=!0;break}}return d},_getTag:function(a,d){var b=p.query(a,d);return b&&0<b.length?b[0]:null},_getTagValue:function(a,d,b){return(a=p.query(a,d))&&0<a.length?a[0].text?a[0].text:a[0].textContent:b},_getAttributeValue:function(a,d,b,c){return(a=p.query(a,b))&&0<a.length?a[0].getAttribute(d):c},_checkVisibleLayersList:function(a){if(a&&(0<a.length&&this.layerInfos&&
0<this.layerInfos.length)&&"number"==typeof a[0]){var d=[];l.forEach(a,function(a){a<this.layerInfos.length&&d.push(this.layerInfos[a].name)},this);a=d}return a},_stripParameters:function(a,d){var b=c.urlToObject(a),e,g=[];for(e in b.query)-1===l.indexOf(d,e.toLowerCase())&&g.push(e+"\x3d"+b.query[e]);return b.path+(g.length?"?"+g.join("\x26"):"")}});m("extend-esri")&&r.setObject("layers.WMSLayer",n,f);return n})},"esri/layers/SnapshotMode":function(){define("dojo/_base/declare dojo/_base/lang dojo/has ../kernel ../SpatialReference ../tasks/query ./RenderMode".split(" "),
function(q,p,n,r,l,m,f){q=q([f],{declaredClass:"esri.layers._SnapshotMode",constructor:function(f){this.featureLayer=f;this.pagination=f.queryPagination;this._featureMap={};this._drawFeatures=p.hitch(this,this._drawFeatures);this._queryErrorHandler=p.hitch(this,this._queryErrorHandler)},startup:function(){this.pagination=this.pagination&&null!=this.featureLayer.maxRecordCount;this.featureLayer._collection?this._applyTimeFilter():this._fetchAll()},propertyChangeHandler:function(f){this._init&&(f?this.featureLayer._collection?
console.log("FeatureLayer: layer created by value (from a feature collection) does not support definition expressions and time definitions. Layer id \x3d "+this.featureLayer.id):this._fetchAll():this._applyTimeFilter())},drawFeature:function(f){var c=f.attributes[this.featureLayer.objectIdField];this._addFeatureIIf(c,f);this._incRefCount(c)},resume:function(){this.propertyChangeHandler(0)},refresh:function(){var f=this.featureLayer;f._collection?(f._fireUpdateStart(),f._refresh(!0),f._fireUpdateEnd()):
this._fetchAll()},_getRequestId:function(f){return("_"+f.name+f.layerId+f._ulid).replace(/[^a-zA-Z0-9\_]+/g,"_")},_fetchAll:function(){var f=this.featureLayer;!f._collection&&!f.suspended&&(f._fireUpdateStart(),this._clearIIf(),this._sendRequest())},_sendRequest:function(f){var c=this.map,g=this.featureLayer,e=g.getDefinitionExpression(),h=new m;h.outFields=g.getOutFields();h.where=e||"1\x3d1";h.returnGeometry=!0;h.outSpatialReference=new l(c.spatialReference.toJson());h.timeExtent=g.getTimeDefinition();
h.maxAllowableOffset=g._maxOffset;g._ts&&(h._ts=(new Date).getTime());h.orderByFields=g.supportsAdvancedQueries?g.getOrderByFields():null;h.multipatchOption=g.multipatchOption;this.pagination&&(this._start=h.start=null==f?0:f,h.num=g.maxRecordCount);var k;g._usePatch&&(k=this._getRequestId(g),this._cancelPendingRequest(null,k));g._task.execute(h,this._drawFeatures,this._queryErrorHandler,k)},_drawFeatures:function(f){this._purgeRequests();var c=f.features,g=this.featureLayer,e=g.objectIdField,h,k=
c.length,a=f.exceededTransferLimit&&!g._collection,d,b;for(h=0;h<k;h++)d=c[h],b=d.attributes[e],this._addFeatureIIf(b,d),this._incRefCount(b);this._applyTimeFilter(!0);if(!this.pagination||!a)g._fireUpdateEnd(null,f.exceededTransferLimit?{queryLimitExceeded:!0}:null);a&&(this.pagination&&this._sendRequest(this._start+g.maxRecordCount),g.onQueryLimitExceeded())},_queryErrorHandler:function(f){this._purgeRequests();var c=this.featureLayer;c._errorHandler(f);c._fireUpdateEnd(f)}});n("extend-esri")&&
p.setObject("layers._SnapshotMode",q,r);return q})},"esri/layers/SelectionMode":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/has","../kernel","./RenderMode"],function(q,p,n,r,l){q=q([l],{declaredClass:"esri.layers._SelectionMode",constructor:function(m){this.featureLayer=m;this._featureMap={}},propertyChangeHandler:function(m){this._init&&0===m&&this._applyTimeFilter()},resume:function(){this.propertyChangeHandler(0)}});n("extend-esri")&&p.setObject("layers._SelectionMode",q,r);
return q})},"esri/layers/GridLayout":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has ../kernel ../SpatialReference ../geometry/Extent ../geometry/Polyline".split(" "),function(q,p,n,r,l,m,f,s){q=q(null,{declaredClass:"esri.layers._GridLayout",constructor:function(c,g,e,h){this.origin=c;this.cellWidth=g.width;this.cellHeight=g.height;this.mapWidth=e.width;this.mapHeight=e.height;this.srInfo=h},setResolution:function(c){this._resolution=(c.xmax-c.xmin)/this.mapWidth;
this.srInfo&&(c=Math.round(2*this.srInfo.valid[1]/this._resolution),c=Math.round(c/this.cellWidth),this._frameStats=[c,0,c-1])},getCellCoordinates:function(c){var g=this._resolution,e=this.origin;return{row:Math.floor((e.y-c.y)/(this.cellHeight*g)),col:Math.floor((c.x-e.x)/(this.cellWidth*g))}},normalize:function(c){var g=this._frameStats;if(g){var e=g[0],h=g[1],g=g[2];c<h?(c%=e,c=c<h?c+e:c):c>g&&(c%=e)}return c},intersects:function(c,g){var e=this.srInfo;return e?n.some(g._getParts(e),function(e){return c.intersects(e.extent)}):
c.intersects(g)},getCellExtent:function(c,g){var e=this._resolution,h=this.origin,k=this.cellWidth,a=this.cellHeight;return new f(g*k*e+h.x,h.y-(c+1)*a*e,(g+1)*k*e+h.x,h.y-c*a*e,new m(h.spatialReference.toJson()))},getLatticeID:function(c){var g=this.getCellCoordinates({x:c.xmin,y:c.ymax}),e=this.getCellCoordinates({x:c.xmax,y:c.ymin});c=g.row;var h=e.row,g=this.normalize(g.col),e=this.normalize(e.col);return c+"_"+h+"_"+g+"_"+e},sorter:function(c,g){return c<g?-1:1},getCellsInExtent:function(c,g){var e=
this.getCellCoordinates({x:c.xmin,y:c.ymax}),h=this.getCellCoordinates({x:c.xmax,y:c.ymin}),k=e.row,a=h.row,e=e.col,h=h.col,d=[],b,f,m,l=[],n=[],p,q,r,A=[];for(b=k;b<=a;b++)for(f=e;f<=h;f++)m=this.normalize(f),c=this.getCellExtent(b,m),d.push({row:b,col:m,extent:c,resolution:this._resolution}),g&&(l.push(c.xmin,c.xmax),n.push(c.ymin,c.ymax));e=this.normalize(e);h=this.normalize(h);l.sort(this.sorter);n.sort(this.sorter);f=l.length;for(b=f-1;0<=b;b--)b<f-1&&l[b]===l[b+1]&&l.splice(b,1);f=n.length;
for(b=f-1;0<=b;b--)b<f-1&&n[b]===n[b+1]&&n.splice(b,1);if(l.length&&n.length){m=l[0];p=l[l.length-1];q=n[0];r=n[n.length-1];f=l.length;for(b=0;b<f;b++)A.push([[l[b],r],[l[b],q]]);f=n.length;for(b=0;b<f;b++)A.push([[m,n[b]],[p,n[b]]]);b=new s({paths:A,spatialReference:this.origin.spatialReference.toJson()});d.push({latticeID:k+"_"+a+"_"+e+"_"+h,lattice:b,resolution:this._resolution})}return{minRow:k,maxRow:a,minCol:e,maxCol:h,cells:d}}});r("extend-esri")&&p.setObject("layers._GridLayout",q,l);return q})},
"dojox/data/CsvStore":function(){define("dojo/_base/lang dojo/_base/declare dojo/_base/xhr dojo/_base/kernel dojo/data/util/filter dojo/data/util/simpleFetch".split(" "),function(q,p,n,r,l,m){p=p("dojox.data.CsvStore",null,{constructor:function(f){this._attributes=[];this._attributeIndexes={};this._dataArray=[];this._arrayOfAllItems=[];this._loadFinished=!1;f.url&&(this.url=f.url);this._csvData=f.data;f.label?this.label=f.label:""===this.label&&(this.label=void 0);this._storeProp="_csvStore";this._idProp=
"_csvId";this._features={"dojo.data.api.Read":!0,"dojo.data.api.Identity":!0};this._loadInProgress=!1;this._queuedFetches=[];this.identifier=f.identifier;""===this.identifier?delete this.identifier:this._idMap={};"separator"in f&&(this.separator=f.separator);"urlPreventCache"in f&&(this.urlPreventCache=f.urlPreventCache?!0:!1)},url:"",label:"",identifier:"",separator:",",urlPreventCache:!1,_assertIsItem:function(f){if(!this.isItem(f))throw Error(this.declaredClass+": a function was passed an item argument that was not an item");
},_getIndex:function(f){f=this.getIdentity(f);this.identifier&&(f=this._idMap[f]);return f},getValue:function(f,l,c){this._assertIsItem(f);var g=c;if("string"===typeof l)l=this._attributeIndexes[l],null!=l&&(g=this._dataArray[this._getIndex(f)][l]||c);else throw Error(this.declaredClass+": a function was passed an attribute argument that was not a string");return g},getValues:function(f,l){var c=this.getValue(f,l);return c?[c]:[]},getAttributes:function(f){this._assertIsItem(f);var l=[];f=this._dataArray[this._getIndex(f)];
for(var c=0;c<f.length;c++)""!==f[c]&&l.push(this._attributes[c]);return l},hasAttribute:function(f,l){this._assertIsItem(f);if("string"===typeof l){var c=this._attributeIndexes[l],g=this._dataArray[this._getIndex(f)];return"undefined"!==typeof c&&c<g.length&&""!==g[c]}throw Error(this.declaredClass+": a function was passed an attribute argument that was not a string");},containsValue:function(f,m,c){var g=void 0;"string"===typeof c&&(g=l.patternToRegExp(c,!1));return this._containsValue(f,m,c,g)},
_containsValue:function(f,l,c,g){f=this.getValues(f,l);for(l=0;l<f.length;++l){var e=f[l];if("string"===typeof e&&g)return null!==e.match(g);if(c===e)return!0}return!1},isItem:function(f){if(f&&f[this._storeProp]===this)if(f=f[this._idProp],this.identifier){if(this._dataArray[this._idMap[f]])return!0}else if(0<=f&&f<this._dataArray.length)return!0;return!1},isItemLoaded:function(f){return this.isItem(f)},loadItem:function(f){},getFeatures:function(){return this._features},getLabel:function(f){if(this.label&&
this.isItem(f))return this.getValue(f,this.label)},getLabelAttributes:function(f){return this.label?[this.label]:null},_fetchItems:function(f,m,c){var g=this,e=function(a,d){var c=null;if(a.query){var e,k,c=[],f=a.queryOptions?a.queryOptions.ignoreCase:!1,h={};for(e in a.query)k=a.query[e],"string"===typeof k&&(h[e]=l.patternToRegExp(k,f));for(f=0;f<d.length;++f){var n=!0,p=d[f];for(e in a.query)k=a.query[e],g._containsValue(p,e,k,h[e])||(n=!1);n&&c.push(p)}}else c=d.slice(0,d.length);m(c,a)};if(this._loadFinished)e(f,
this._arrayOfAllItems);else if(""!==this.url)if(this._loadInProgress)this._queuedFetches.push({args:f,filter:e});else{this._loadInProgress=!0;var h=n.get({url:g.url,handleAs:"text",preventCache:g.urlPreventCache});h.addCallback(function(a){try{g._processData(a),e(f,g._arrayOfAllItems),g._handleQueuedFetches()}catch(d){c(d,f)}});h.addErrback(function(a){g._loadInProgress=!1;if(c)c(a,f);else throw a;});var k=null;f.abort&&(k=f.abort);f.abort=function(){h&&-1===h.fired&&h.cancel();k&&k.call(f)}}else if(this._csvData)try{this._processData(this._csvData),
this._csvData=null,e(f,this._arrayOfAllItems)}catch(a){c(a,f)}else{var d=Error(this.declaredClass+": No CSV source data was provided as either URL or String data input.");if(c)c(d,f);else throw d;}},close:function(f){},_getArrayOfArraysFromCsvFileContents:function(f){if(q.isString(f)){var l=RegExp("^\\s+","g"),c=RegExp("\\s+$","g"),g=RegExp('""',"g"),e=[],h=this._splitLines(f);for(f=0;f<h.length;++f){var k=h[f];if(0<k.length){for(var k=k.split(this.separator),a=0;a<k.length;){var d=k[a].replace(l,
""),b=d.replace(c,""),m=b.charAt(0),n=b.charAt(b.length-1),p=b.charAt(b.length-2),r=b.charAt(b.length-3);if(2===b.length&&'""'==b)k[a]="";else if('"'==m&&('"'!=n||'"'==n&&'"'==p&&'"'!=r)){if(a+1===k.length)return;k[a]=d+this.separator+k[a+1];k.splice(a+1,1)}else'"'==m&&'"'==n&&(b=b.slice(1,b.length-1),b=b.replace(g,'"')),k[a]=b,a+=1}e.push(k)}}this._attributes=e.shift();for(f=0;f<this._attributes.length;f++)this._attributeIndexes[this._attributes[f]]=f;this._dataArray=e}},_splitLines:function(f){var l=
[],c,g="",e=!1;for(c=0;c<f.length;c++){var h=f.charAt(c);switch(h){case '"':e=!e;g+=h;break;case "\r":e?g+=h:(l.push(g),g="",c<f.length-1&&"\n"==f.charAt(c+1)&&c++);break;case "\n":e?g+=h:(l.push(g),g="");break;default:g+=h}}""!==g&&l.push(g);return l},_processData:function(f){this._getArrayOfArraysFromCsvFileContents(f);this._arrayOfAllItems=[];if(this.identifier&&void 0===this._attributeIndexes[this.identifier])throw Error(this.declaredClass+": Identity specified is not a column header in the data set.");
for(f=0;f<this._dataArray.length;f++){var l=f;this.identifier&&(l=this._dataArray[f][this._attributeIndexes[this.identifier]],this._idMap[l]=f);this._arrayOfAllItems.push(this._createItemFromIdentity(l))}this._loadFinished=!0;this._loadInProgress=!1},_createItemFromIdentity:function(f){var l={};l[this._storeProp]=this;l[this._idProp]=f;return l},getIdentity:function(f){return this.isItem(f)?f[this._idProp]:null},fetchItemByIdentity:function(f){var l,c=f.scope?f.scope:r.global;if(this._loadFinished)l=
this._createItemFromIdentity(f.identity),this.isItem(l)||(l=null),f.onItem&&f.onItem.call(c,l);else{var g=this;if(""!==this.url)this._loadInProgress?this._queuedFetches.push({args:f}):(this._loadInProgress=!0,l=n.get({url:g.url,handleAs:"text"}),l.addCallback(function(e){try{g._processData(e);var k=g._createItemFromIdentity(f.identity);g.isItem(k)||(k=null);f.onItem&&f.onItem.call(c,k);g._handleQueuedFetches()}catch(a){f.onError&&f.onError.call(c,a)}}),l.addErrback(function(e){this._loadInProgress=
!1;f.onError&&f.onError.call(c,e)}));else if(this._csvData)try{g._processData(g._csvData),g._csvData=null,l=g._createItemFromIdentity(f.identity),g.isItem(l)||(l=null),f.onItem&&f.onItem.call(c,l)}catch(e){f.onError&&f.onError.call(c,e)}}},getIdentityAttributes:function(f){return this.identifier?[this.identifier]:null},_handleQueuedFetches:function(){if(0<this._queuedFetches.length){for(var f=0;f<this._queuedFetches.length;f++){var l=this._queuedFetches[f],c=l.filter,g=l.args;c?c(g,this._arrayOfAllItems):
this.fetchItemByIdentity(l.args)}this._queuedFetches=[]}}});q.extend(p,m);return p})},"esri/arcgis/csv":function(){define("dojo/_base/lang dojo/_base/array dojo/_base/Deferred dojo/sniff dojo/number dojox/data/CsvStore ../kernel ../config ../request ../SpatialReference ../geometry/Geometry ../geometry/jsonUtils ../geometry/webMercatorUtils".split(" "),function(q,p,n,r,l,m,f,s,c,g,e,h,k){function a(a){var b=0,d="";p.forEach([","," ",";","|","\t"],function(c){var e=a.split(c).length;e>b&&(b=e,d=c)});
return d}function d(a,b){if(!a||"[object Date]"!==Object.prototype.toString.call(a)||isNaN(a.getTime()))return!1;var d=!0;if(r("chrome")&&/\d+\W*$/.test(b)){var c=b.match(/[a-zA-Z]{2,}/);if(c){for(var d=!1,e=0,g=c.length,k=/^((jan(uary)?)|(feb(ruary)?)|(mar(ch)?)|(apr(il)?)|(may)|(jun(e)?)|(jul(y)?)|(aug(ust)?)|(sep(tember)?)|(oct(ober)?)|(nov(ember)?)|(dec(ember)?)|(am)|(pm)|(gmt)|(utc))$/i;!d&&e<=g&&!(d=!k.test(c[e]));)e++;d=!d}}return d}function b(b,c,e){var g=b.indexOf("\n"),g=q.trim(b.substr(0,
g)),k=c.columnDelimiter;k||(k=a(g));var f=new m({data:b,separator:k});f.fetch({onComplete:function(a,b){var g=0,k={layerDefinition:c.layerDefinition,featureSet:{features:[],geometryType:"esriGeometryPoint"}},h=k.layerDefinition.objectIdField;!h&&!p.some(k.layerDefinition.fields,function(a){return"esriFieldTypeOID"==a.type?(h=a.name,!0):!1})&&(k.layerDefinition.fields.push({name:"__OBJECTID",alias:"__OBJECTID",type:"esriFieldTypeOID",editable:!1,domain:null}),h="__OBJECTID");var m,n,s=f._attributes,
q=[],r=[];p.forEach(k.layerDefinition.fields,function(a,b){"esriFieldTypeDate"===a.type?q.push(a.name):("esriFieldTypeDouble"===a.type||"esriFieldTypeInteger"===a.type)&&r.push(a.name)});c.locationInfo&&"coordinates"===c.locationInfo.locationType?(m=c.locationInfo.latitudeFieldName,n=c.locationInfo.longitudeFieldName):p.forEach(s,function(a){var b;b=p.indexOf(v,a.toLowerCase());-1!==b&&(m=a);b=p.indexOf(C,a.toLowerCase());-1!==b&&(n=a)},this);if(!m||!n)setTimeout(function(){console.error("File does not seem to contain fields with point coordinates.")},
1),e&&e(null,Error("File does not seem to contain fields with point coordinates."));else{-1===p.indexOf(r,m)&&r.push(m);-1===p.indexOf(r,n)&&r.push(n);var s=0,t=a.length;for(s;s<t;s++){var y=a[s],x=f.getAttributes(y),u={};p.forEach(x,function(a,b){if(a){var c=a;0===a.length&&p.forEach(k.layerDefinition.fields,function(b,d){b.name==="attribute_"+(d-1)&&(a="attribute_"+(d-1))});if(-1<p.indexOf(q,a)){var c=f.getValue(y,c),e=new Date(c);u[a]=d(e,c)?e.getTime():null}else if(-1<p.indexOf(r,a)){e=l.parse(f.getValue(y,
c));if((a==m||a==n)&&(isNaN(e)||181<Math.abs(e)))e=parseFloat(f.getValue(y,c));isNaN(e)?u[a]=null:u[a]=e}else u[a]=f.getValue(y,c)}});u[h]=g;g++;var x=u[m],D=u[n];null==D||(null==x||isNaN(x)||isNaN(D))||k.featureSet.features.push({geometry:{x:D,y:x,spatialReference:{wkid:4326}},attributes:u})}k.layerDefinition.name="csv";e&&e(k)}},onError:function(a){console.error("Error fetching items from CSV store: ",a);e&&e(null,a)}});return!0}function t(a,b,d,c,e,g){0===a.length&&e(null);var f=h.getGeometryType(b),
l=[];p.forEach(a,function(a){a=new f(a);a.spatialReference=d;l.push(a)},this);b=[102113,102100,3857];d.wkid&&4326===d.wkid&&c.wkid&&-1<p.indexOf(b,c.wkid)?(p.forEach(l,function(a){a.xmin?(a.xmin=Math.max(a.xmin,-180),a.xmax=Math.min(a.xmax,180),a.ymin=Math.max(a.ymin,-89.99),a.ymax=Math.min(a.ymax,89.99)):a.rings?p.forEach(a.rings,function(a){p.forEach(a,function(a){a[0]=Math.min(Math.max(a[0],-180),180);a[1]=Math.min(Math.max(a[1],-89.99),89.99)},this)},this):a.paths?p.forEach(a.paths,function(a){p.forEach(a,
function(a){a[0]=Math.min(Math.max(a[0],-180),180);a[1]=Math.min(Math.max(a[1],-89.99),89.99)},this)},this):a.x&&(a.x=Math.min(Math.max(a.x,-180),180),a.y=Math.min(Math.max(a.y,-89.99),89.99))},this),a=[],p.forEach(l,function(b){b=k.geographicToWebMercator(b);102100!==c.wkid&&(b.spatialReference=c);a.push(b.toJson())},this),e(a)):null!==d.wkid&&-1<p.indexOf(b,d.wkid)&&null!==c.wkid&&4326===c.wkid?(a=[],p.forEach(l,function(b){a.push(k.webMercatorToGeographic(b).toJson())},this),e(a)):(b=function(b,
d){b&&b.length===a.length?(a=[],p.forEach(b,function(b){b&&(b.rings&&0<b.rings.length&&0<b.rings[0].length&&0<b.rings[0][0].length&&!isNaN(b.rings[0][0][0])&&!isNaN(b.rings[0][0][1])||b.paths&&0<b.paths.length&&0<b.paths[0].length&&0<b.paths[0][0].length&&!isNaN(b.paths[0][0][0])&&!isNaN(b.paths[0][0][1])||b.xmin&&!isNaN(b.xmin)&&b.ymin&&!isNaN(b.ymin)||b.x&&!isNaN(b.x)&&b.y&&!isNaN(b.y))?a.push(b.toJson()):a.push(null)},this),e(a)):g(b,d)},s.defaults.geometryService?s.defaults.geometryService.project(l,
c,q.hitch(this,b),g):e(null))}function u(a,b){var d=[102113,102100,3857];return a&&b&&a.wkid===b.wkid&&a.wkt===b.wkt||a&&b&&a.wkid&&b.wkid&&-1<p.indexOf(d,a.wkid)&&-1<p.indexOf(d,b.wkid)?!0:!1}function w(a,b,d,c){if(a.featureSet&&0!==a.featureSet.features.length)if(u(d,b))c(a);else{var e=function(b){var d=[];p.forEach(a.featureSet.features,function(a,c){b[c]&&(a.geometry=b[c],d.push(a))},this);c(a)},k=function(b,d){console.error("error projecting featureSet ("+a.layerDefinition.name+"). Final try.");
c(a)},f=function(c,g){console.error("error projecting featureSet ("+a.layerDefinition.name+"). Try one more time.");t(l,a.featureSet.geometryType,b,d,q.hitch(this,e),q.hitch(this,k))};if(a.featureSet.features&&0<a.featureSet.features.length){var l=[];p.forEach(a.featureSet.features,function(b){if(b.geometry.toJson)l.push(b.geometry);else{var d=h.getGeometryType(a.featureSet.geometryType);l.push(new d(b.geometry))}});b.toJson||(b=new g(b));d.toJson||(d=new g(d));t(l,a.featureSet.geometryType,b,d,q.hitch(this,
e),q.hitch(this,f))}else c(a)}}var v="lat latitude y ycenter latitude83 latdecdeg POINT-Y".split(" "),C="lon lng long longitude x xcenter longitude83 longdecdeg POINT-X".split(" ");e={latFieldStrings:v,longFieldStrings:C,buildCSVFeatureCollection:function(a){var d=new n,e=function(a,b){b?d.errback(b):d.callback(a)};c({url:a.url,handleAs:"text",load:function(d){b(d,a,q.hitch(this,e))},error:function(a){d.errback(a);console.error("error: "+a)}},{usePost:!1});return d},projectFeatureCollection:function(a,
b,d){var c=new n;d||(d=new g({wkid:4326}));w(a,d,b,q.hitch(this,function(a){c.callback(a)}));return c},generateDefaultPopupInfo:function(a){var b={esriFieldTypeDouble:1,esriFieldTypeSingle:1},d={esriFieldTypeInteger:1,esriFieldTypeSmallInteger:1},c={esriFieldTypeDate:1},e=null;a=p.map(a.layerDefinition.fields,q.hitch(this,function(a){"NAME"===a.name.toUpperCase()&&(e=a.name);var g="esriFieldTypeOID"!==a.type&&"esriFieldTypeGlobalID"!==a.type&&"esriFieldTypeGeometry"!==a.type,k=null;if(g){var f=a.name.toLowerCase();
if(-1<",stretched value,fnode_,tnode_,lpoly_,rpoly_,poly_,subclass,subclass_,rings_ok,rings_nok,".indexOf(","+f+",")||-1<f.indexOf("area")||-1<f.indexOf("length")||-1<f.indexOf("shape")||-1<f.indexOf("perimeter")||-1<f.indexOf("objectid")||f.indexOf("_")===f.length-1||f.indexOf("_i")===f.length-2&&1<f.length)g=!1;a.type in d?k={places:0,digitSeparator:!0}:a.type in b?k={places:2,digitSeparator:!0}:a.type in c&&(k={dateFormat:"shortDateShortTime"})}return q.mixin({},{fieldName:a.name,label:a.alias,
isEditable:!0,tooltip:"",visible:g,format:k,stringFieldOption:"textbox"})}));return{title:e?"{"+e+"}":"",fieldInfos:a,description:null,showAttachments:!1,mediaInfos:[]}},_getSeparator:a,_isValidDate:d,_processCsvData:b,_projectGeometries:t,_sameSpatialReference:u,_projectFeatureSet:w};r("extend-esri")&&q.setObject("arcgis.csv",e,f);return e})},"dojo/data/util/filter":function(){define(["../../_base/lang"],function(q){var p={};q.setObject("dojo.data.util.filter",p);p.patternToRegExp=function(n,p){for(var l=
"^",m=null,f=0;f<n.length;f++)switch(m=n.charAt(f),m){case "\\":l+=m;f++;l+=n.charAt(f);break;case "*":l+=".*";break;case "?":l+=".";break;case "$":case "^":case "/":case "+":case ".":case "|":case "(":case ")":case "{":case "}":case "[":case "]":l+="\\";default:l+=m}l+="$";return p?RegExp(l,"mi"):RegExp(l,"m")};return p})},"esri/layers/WMSLayerInfo":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/has","../kernel"],function(q,p,n,r,l){q=q(null,{declaredClass:"esri.layers.WMSLayerInfo",
name:null,title:null,description:null,extent:null,legendURL:null,subLayers:[],allExtents:[],spatialReferences:[],constructor:function(l){l&&(this.name=l.name,this.title=l.title,this.description=l.description,this.extent=l.extent,this.legendURL=l.legendURL,this.subLayers=l.subLayers?l.subLayers:[],this.allExtents=l.allExtents?l.allExtents:[],this.spatialReferences=l.spatialReferences?l.spatialReferences:[])},clone:function(){var l={name:this.name,title:this.title,description:this.description,legendURL:this.legendURL},
f;this.extent&&(l.extent=this.extent.getExtent());l.subLayers=[];n.forEach(this.subLayers,function(f){l.subLayers.push(f.clone())});l.allExtents=[];for(f in this.allExtents)f=parseInt(f,10),isNaN(f)||(l.allExtents[f]=this.allExtents[f].getExtent());l.spatialReferences=[];n.forEach(this.spatialReferences,function(f){l.spatialReferences.push(f)});return l}});r("extend-esri")&&p.setObject("layers.WMSLayerInfo",q,l);return q})},"esri/layers/RenderMode":function(){define("dojo/_base/kernel dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has dojo/io/script ../kernel".split(" "),
function(q,p,n,r,l,m,f){p=p(null,{declaredClass:"esri.layers._RenderMode",constructor:function(){this._prefix="jsonp_"+(q._scopeName||"dojo")+"IoScript"},initialize:function(f){this.map=f;this._init=!0},startup:function(){},propertyChangeHandler:function(f){},destroy:function(){this._init=!1},drawFeature:function(f){},suspend:function(){},resume:function(){},refresh:function(){},_incRefCount:function(f){(f=this._featureMap[f])&&f._count++},_decRefCount:function(f){(f=this._featureMap[f])&&f._count--},
_getFeature:function(f){return this._featureMap[f]},_addFeatureIIf:function(f,c){var g=this._featureMap,e=g[f],h=this.featureLayer;e||(g[f]=c,h._add(c),c._count=0);return e||c},_removeFeatureIIf:function(f){var c=this._featureMap[f],g=this.featureLayer;if(c){if(c._count)return;delete this._featureMap[f];g._remove(c)}return c},_clearIIf:function(){var f;f=this.featureLayer;var c=f.graphics,g=f._selectedFeatures,e=f.objectIdField;for(f=c.length-1;0<=f;f--){var h=c[f],k=h.attributes[e];k in g?h._count=
1:(h._count=0,this._removeFeatureIIf(k))}},_isPending:function(f){return m[this._prefix+f]?!0:!1},_cancelPendingRequest:function(f,c){if(f=f||m[this._prefix+c])try{f.cancel(),m._validCheck(f)}catch(g){}},_purgeRequests:function(){m._validCheck(null)},_toggleVisibility:function(f){var c=this.featureLayer,g=c.graphics,e=f?"show":"hide",h,k=g.length;f=f&&c._ager;for(h=0;h<k;h++){var a=g[h];a[e]();f&&c._repaint(a)}},_applyTimeFilter:function(f){var c=this.featureLayer;if(c.timeInfo&&!c.suspended){f||
c._fireUpdateStart();var g=c._trackManager;g&&g.clearTracks();var e=c.getTimeDefinition(),h=c._getOffsettedTE(c._mapTimeExtent);h?(h=c._getTimeOverlap(e,h))?(e=c._filterByTime(c.graphics,h.startTime,h.endTime),g&&g.addFeatures(e.match),r.forEach(e.match,function(e){var a=e._shape;e.visible||(e.show(),(a=e._shape)&&a._moveToFront());c._ager&&a&&c._repaint(e)}),r.forEach(e.noMatch,function(c){c.visible&&c.hide()})):this._toggleVisibility(!1):(g&&g.addFeatures(c.graphics),this._toggleVisibility(!0));
g&&(g.moveLatestToFront(),g.drawTracks());f||c._fireUpdateEnd()}}});l("extend-esri")&&n.setObject("layers._RenderMode",p,f);return p})},"esri/layers/FeatureType":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has ../kernel ../lang ../symbols/jsonUtils ./RangeDomain ./CodedValueDomain ./InheritedDomain ./FeatureTemplate".split(" "),function(q,p,n,r,l,m,f,s,c,g,e){q=q(null,{declaredClass:"esri.layers.FeatureType",constructor:function(h){if(h&&p.isObject(h)){this.id=h.id;
this.name=h.name;var k=h.symbol;k&&(this.symbol=f.fromJson(k));var k=h.domains,a,d=this.domains={};for(a in k)if(k.hasOwnProperty(a)){var b=k[a];switch(b.type){case "range":d[a]=new s(b);break;case "codedValue":d[a]=new c(b);break;case "inherited":d[a]=new g(b)}}if(a=h.templates){k=this.templates=[];for(h=0;h<a.length;h++)k.push(new e(a[h]))}}},toJson:function(){var c={id:this.id,name:this.name,symbol:this.symbol&&this.symbol.toJson()},e,a=this.domains,d=this.templates,b=m.fixJson;if(a){var f=c.domains=
{};for(e in a)a.hasOwnProperty(e)&&(f[e]=a[e]&&a[e].toJson());b(f)}d&&(c.templates=n.map(d,function(a){return a.toJson()}));return b(c)}});r("extend-esri")&&p.setObject("layers.FeatureType",q,l);return q})},"esri/layers/StreamMode":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has ../kernel ../SpatialReference ../tasks/query ./RenderMode".split(" "),function(q,p,n,r,l,m,f,s){q=q([s],{declaredClass:"esri.layers._StreamMode",constructor:function(c){console.log("entering 'stream' mode...");
this.featureLayer=c;this._featureMap={};this._drawFeatures=p.hitch(this,this._drawFeatures);this._queryErrorHandler=p.hitch(this,this._queryErrorHandler)},startup:function(){this.featureLayer._collection?console.log("Feature layer is a collection"):this._fetchArchive()},propertyChangeHandler:function(c){this._init&&(c?console.debug("StreamLayer: Stream Layer only supports changing map time. Layer id \x3d "+this.featureLayer.id):this._applyTimeFilter())},drawFeature:function(c){c.visible=this._checkFeatureTimeIntersects(c);
this._addTrackedFeature(c)},resume:function(){this.propertyChangeHandler(0)},refresh:function(){var c=this.featureLayer;c._collection?(c._fireUpdateStart(),c._refresh(!0),c._fireUpdateEnd()):this._fetchArchive()},_drawFeatures:function(c){this._purgeRequests();c=c.features||[];var f=this.featureLayer.objectIdField,e,h=c.length,k,a;for(e=0;e<h;e++)k=c[e],a=k.attributes[f],this._addFeatureIIf(a,k),this._incRefCount(a);this._applyTimeFilter(!0)},_applyTimeFilter:function(c){var f=this.featureLayer._trackManager,
e;this.inherited(arguments);if(f&&(e=f.trimTracks())&&0<e.length)this._removeFeatures(e),f.refreshTracks()},_addTrackedFeature:function(c){var f=this.featureLayer,e=f._trackManager,h,k=c.attributes[f.objectIdField],a;e&&c.visible&&(e.addFeatures([c]),h=c.attributes[f._trackIdField],a=e.trimTracks([h]));this._addFeatureIIf(k,c);this._incRefCount(k);h&&(this._removeFeatures(a),e.refreshTracks([h]))},_removeFeatures:function(c){var f=this.featureLayer,e=f.objectIdField;c&&n.forEach(c,function(c){c=c.attributes[e];
f._unSelectFeatureIIf(c,this);this._decRefCount(c);this._removeFeatureIIf(c)},this)},_checkFeatureTimeIntersects:function(c){var f=this.featureLayer,e=f.getMap().timeExtent;return!e||!f.timeInfo||!f.timeInfo.startTimeField&&!f.timeInfo.endTimeField?!0:0<f._filterByTime([c],e.startTime,e.endTime).match.length},_fetchArchive:function(){console.log("Stream layer archiving not supported")},_queryErrorHandler:function(c){this._purgeRequests();var f=this.featureLayer;f._errorHandler(c);f._fireUpdateEnd(c)}});
r("extend-esri")&&p.setObject("layers._StreamMode",q,l);return q})},"esri/layers/GeoRSSLayer":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/json dojo/has ../kernel ../config ../request ./ServiceGeneratedFeatureCollection".split(" "),function(q,p,n,r,l,m,f,s){q=q([s],{declaredClass:"esri.layers.GeoRSSLayer",serviceUrl:location.protocol+"//utility.arcgis.com/sharing/rss",constructor:function(c,f){m.defaults.geoRSSService&&(this.serviceUrl=m.defaults.geoRSSService);this._createLayer()},
parse:function(){return this._io=f({url:this.serviceUrl,content:{url:this.url,refresh:this.loaded?!0:void 0,outSR:this._outSR?n.toJson(this._outSR.toJson()):void 0},callbackParamName:"callback"})},_initLayer:function(c){this.inherited(arguments);this.loaded||(this.loaded=!0,this.onLoad(this))}});r("extend-esri")&&p.setObject("layers.GeoRSSLayer",q,l);return q})},"esri/layers/FeatureTemplate":function(){define("dojo/_base/declare dojo/_base/lang dojo/has ../kernel ../lang ../graphic".split(" "),function(q,
p,n,r,l,m){q=q(null,{declaredClass:"esri.layers.FeatureTemplate",constructor:function(f){f&&p.isObject(f)&&(this.name=f.name,this.description=f.description,this.drawingTool=f.drawingTool,f=f.prototype,this.prototype=new m(f.geometry,null,f.attributes))},toJson:function(){return l.fixJson({name:this.name,description:this.description,drawingTool:this.drawingTool,prototype:this.prototype&&this.prototype.toJson()})}});p.mixin(q,{TOOL_AUTO_COMPLETE_POLYGON:"esriFeatureEditToolAutoCompletePolygon",TOOL_CIRCLE:"esriFeatureEditToolCircle",
TOOL_ELLIPSE:"esriFeatureEditToolEllipse",TOOL_FREEHAND:"esriFeatureEditToolFreehand",TOOL_LINE:"esriFeatureEditToolLine",TOOL_NONE:"esriFeatureEditToolNone",TOOL_POINT:"esriFeatureEditToolPoint",TOOL_POLYGON:"esriFeatureEditToolPolygon",TOOL_RECTANGLE:"esriFeatureEditToolRectangle",TOOL_ARROW:"esriFeatureEditToolArrow",TOOL_TRIANGLE:"esriFeatureEditToolTriangle",TOOL_LEFT_ARROW:"esriFeatureEditToolLeftArrow",TOOL_RIGHT_ARROW:"esriFeatureEditToolRightArrow",TOOL_UP_ARROW:"esriFeatureEditToolUpArrow",
TOOL_DOWN_ARROW:"esriFeatureEditToolDownArrow"});n("extend-esri")&&p.setObject("layers.FeatureTemplate",q,r);return q})},"*noref":1}});
define("esri/arcgis/utils","require dojo/_base/lang dojo/_base/array dojo/_base/connect dojo/_base/Deferred dojo/_base/json dojo/_base/url dojo/on dojo/DeferredList dojo/dom-construct ../kernel ../config ../lang ../request ../SpatialReference ../map ../urlUtils ../geometry/ScreenPoint ../geometry/Extent ../geometry/webMercatorUtils ../symbols/jsonUtils ../renderers/jsonUtils ../dijit/PopupTemplate ../dijit/Popup ../tasks/query ../tasks/GeometryService ./csv ../layers/ArcGISTiledMapServiceLayer ../layers/ArcGISDynamicMapServiceLayer ../layers/ArcGISImageServiceLayer ../layers/CSVLayer ../layers/OpenStreetMapLayer ../layers/WebTiledLayer ../layers/FeatureLayer ../layers/WMSLayer ../layers/KMLLayer ../layers/GeoRSSLayer ../layers/LabelClass ../virtualearth/VETiledLayer ../layers/TileInfo ../layers/DynamicLayerInfo ../layers/LayerDrawingOptions ../layers/ImageParameters ../layers/ImageServiceParameters ../layers/RasterFunction ../layers/MosaicRule ../layers/WMSLayerInfo dojo/i18n!../nls/jsapi".split(" "),function(q,
p,n,r,l,m,f,s,c,g,e,h,k,a,d,b,t,u,w,v,C,y,H,A,x,D,R,S,T,G,N,K,U,E,ba,ca,da,ea,F,fa,ga,L,ha,O,ia,ja,ka,P){function M(b){return a({url:B.arcgisUrl+"/"+b.itemId+"/data",content:{f:"json"},callbackParamName:"callback"},{disableIdentityLookup:!0,_preLookup:!0})}function Q(b,d){var c={f:"json"};d&&(c.token=d);return a({url:b,content:c,callbackParamName:"callback"},{disableIdentityLookup:!0})}function z(a){a.itemProperties.layerDefinition&&(a.layerDefinition?(a.layerDefinition.drawingInfo||(a.layerDefinition.drawingInfo=
a.itemProperties.layerDefinition.drawingInfo),k.isDefined(a.layerDefinition.definitionExpression)||(a.layerDefinition.definitionExpression=a.itemProperties.layerDefinition.definitionExpression),k.isDefined(a.layerDefinition.minScale)||(a.layerDefinition.minScale=a.itemProperties.layerDefinition.minScale),k.isDefined(a.layerDefinition.maxScale)||(a.layerDefinition.maxScale=a.itemProperties.layerDefinition.maxScale)):a.layerDefinition=a.itemProperties.layerDefinition);a.itemProperties.popupInfo&&(!a.popupInfo&&
!a.disablePopup)&&(a.popupInfo=a.itemProperties.popupInfo);k.isDefined(a.itemProperties.showLegend)&&!k.isDefined(a.showLegend)&&(a.showLegend=a.itemProperties.showLegend);k.isDefined(a.itemProperties.refreshInterval)&&!k.isDefined(a.refreshInterval)&&(a.refreshInterval=a.itemProperties.refreshInterval)}function V(a,b){var d=new l,e=a.itemData,f=[],g=[];n.forEach(e.operationalLayers,function(a){if(a.itemId&&!a.type){var b=a.url.toLowerCase();-1<b.indexOf("/featureserver")||-1<b.indexOf("/mapserver/")?
(g.push(a),f.push(M(a))):-1<b.indexOf("/mapserver")&&-1===b.indexOf("/mapserver/")&&(!a.layers||!k.isDefined(a.minScale)&&!k.isDefined(a.maxScale))?(g.push(a),f.push(M(a))):-1<b.indexOf("/imageserver")&&(!k.isDefined(a.minScale)&&!k.isDefined(a.maxScale))&&(g.push(a),f.push(M(a)))}});e.baseMap&&e.baseMap.baseMapLayers&&n.forEach(e.baseMap.baseMapLayers,function(a){a.itemId&&(g.push(a),f.push(M(a)))});if(0<f.length){var h={};(new c(f)).addCallback(function(b){n.forEach(g,function(a,d){var c=b[d][1];
if(c&&!(c instanceof Error)&&(h[a.itemId]=c,!a.type)){var e=a.url.toLowerCase();if((-1<e.indexOf("/featureserver")||-1<e.indexOf("/mapserver/"))&&c.layers)n.forEach(c.layers,function(b){if(e.endsWith("/featureserver/"+b.id)||e.endsWith("/mapserver/"+b.id))a.itemProperties=b,z(a)});else if(-1<e.indexOf("/mapserver"))c.layers&&!a.layers&&(a.layers=c.layers),k.isDefined(c.minScale)&&!k.isDefined(a.minScale)&&(a.minScale=c.minScale),k.isDefined(c.maxScale)&&!k.isDefined(a.maxScale)&&(a.maxScale=c.maxScale),
k.isDefined(c.refreshInterval)&&!k.isDefined(a.refreshInterval)&&(a.refreshInterval=c.refreshInterval);else if(-1<e.indexOf("/imageserver")&&(k.isDefined(c.minScale)&&!k.isDefined(a.minScale)&&(a.minScale=c.minScale),k.isDefined(c.maxScale)&&!k.isDefined(a.maxScale)&&(a.maxScale=c.maxScale),k.isDefined(c.refreshInterval)&&!k.isDefined(a.refreshInterval)&&(a.refreshInterval=c.refreshInterval),c.popupInfo&&(!a.popupInfo&&!a.disablePopup)&&(a.popupInfo=c.popupInfo),c.renderingRule&&!a.renderingRule&&
(a.renderingRule=c.renderingRule,c.renderingRule.functionName&&(a.renderingRule.rasterFunction=c.renderingRule.functionName)),c.bandIds&&!a.bandIds&&(a.bandIds=c.bandIds),c.mosaicRule&&!a.mosaicRule&&(a.mosaicRule=c.mosaicRule),c.format&&!a.format&&(a.format=c.format),k.isDefined(c.compressionQuality)&&!k.isDefined(a.compressionQuality)&&(a.compressionQuality=c.compressionQuality),c.layerDefinition&&c.layerDefinition.definitionExpression&&(!k.isDefined(a.layerDefinition)||!k.isDefined(a.layerDefinition.definitionExpression))))a.layerDefinition=
a.layerDefinition||{},a.layerDefinition.definitionExpression=c.layerDefinition.definitionExpression}});a.relatedItemsData=h;d.callback(a)})}else d.callback(a);return d}function Na(a,b){var c=new l,d=a.itemData,f=d.baseMap.baseMapLayers[0];if("BingMapsAerial"===f.type||"BingMapsRoad"===f.type||"BingMapsHybrid"===f.type)if(f.portalUrl)delete b.bingMapsKey,e.id.checkSignInStatus(t.urlToObject(B.arcgisUrl).path).then(p.hitch(null,function(a,b,c,d,e){Q(f.portalUrl,e.token).then(p.hitch(null,la,a,b,c,d),
p.hitch(null,W,a,b,c,d))},a,b,d,c),p.hitch(null,function(a,b,c,d,e){Q(f.portalUrl).then(p.hitch(null,la,a,b,c,d),p.hitch(null,W,a,b,c,d))},a,b,d,c));else if(b.bingMapsKey){var g=new F({bingMapsKey:b.bingMapsKey,mapStyle:F.MAP_STYLE_AERIAL});r.connect(g,"onLoad",p.hitch(this,function(){c.callback([a,b])}));r.connect(g,"onError",function(e){delete b.bingMapsKey;a.itemData=X(d);f=a.itemData.baseMap.baseMapLayers[0];f.errors=[];f.errors.push({message:"The owner of the application has not provided a valid Bing Key for the Bing Map it includes. Switching to Esri layers."});
c.callback([a,b])})}else a.itemData=X(d),f=a.itemData.baseMap.baseMapLayers[0],f.errors=[],f.errors.push({message:"The owner of the application has not provided a Bing Key for the Bing Map it includes. Switching to Esri layers."}),c.callback([a,b]);else c.callback([a,b]);return c}function la(a,b,c,d,e){e.bingKey?(b.bingMapsKey=e.bingKey,e=new F({bingMapsKey:b.bingMapsKey,mapStyle:F.MAP_STYLE_AERIAL}),r.connect(e,"onLoad",p.hitch(this,function(){d.callback([a,b])})),r.connect(e,"onError",function(e){delete b.bingMapsKey;
a.itemData=X(c);e=a.itemData.baseMap.baseMapLayers[0];e.errors=[];e.errors.push({message:"The owner of the map has not provided a valid Bing Key for the Bing Map it includes. Switching to Esri layers."});d.callback([a,b])})):W(a,b,c,d)}function W(a,b,c,d){delete b.bingMapsKey;a.itemData=X(c);c=a.itemData.baseMap.baseMapLayers[0];c.errors=[];c.errors.push({message:"The owner of the map has not provided a Bing Key for the Bing Map it includes. Switching to Esri layers."});d.callback([a,b])}function X(a){a.baseMap=
"BingMapsAerial"===a.baseMap.baseMapLayers[0].type?{title:"Imagery",baseMapLayers:[{id:"World_Imagery_2017",visibility:!0,opacity:1,url:"http://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer"}]}:"BingMapsRoad"===a.baseMap.baseMapLayers[0].type?{title:"Streets",baseMapLayers:[{id:"World_Street_Map_8421",opacity:1,visibility:!0,url:"http://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer"}]}:{title:"Imagery with Labels",baseMapLayers:[{id:"World_Imagery_6611",
opacity:1,visibility:!0,url:"http://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer"},{id:"World_Boundaries_and_Places_1145",isReference:!0,opacity:1,visibility:!0,url:"http://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer"}]};return a}function ma(a,b,c,d){var e=a.dynamicLayerInfos||a.layerInfos,f=b.layers;if(f&&e)if(d.usePopupManager){var g;n.forEach(e,function(a){var b=a.id;if(!a.subLayerIds)for(a=0;a<f.length;a++){var d=f[a];
if(d.id===b&&d.popupInfo){g||(g={});g[b]={infoTemplate:new c(d.popupInfo),layerUrl:d.layerUrl};break}}});g&&a.setInfoTemplates(g)}else{var h=[],l=[],m=[],p=[],q=[],r=[];n.forEach(e,function(b){var c=b.id;if(!b.subLayerIds&&-1!==n.indexOf(a.visibleLayers,c))for(b=0;b<f.length;b++){var d=f[b];if(d.id===c){l.push(c);h.push(d.popupInfo);m.push(d.layerUrl||"");d.layerDefinition&&d.layerDefinition.definitionExpression?p.push(d.layerDefinition.definitionExpression):p.push("");q.push(k.isDefined(d.minScale)?
d.minScale:null);r.push(k.isDefined(d.maxScale)?d.maxScale:null);break}}});h.length&&(a.__popups=h,a.__popupIds=l,a.__popupUrls=m,a.__popupWhereClauses=p,a.__popupMinScales=q,a.__popupMaxScales=r,a.__resourceInfo=b.resourceInfo)}}function na(a){if(!a)return!1;var b=(new f(B.arcgisUrl)).authority;return-1!==a.indexOf(".arcgis.com/")||-1!==a.indexOf(b)}function xa(a){return!a?!1:-1!==a.indexOf("/services.arcgisonline.com/")||-1!==a.indexOf("/server.arcgisonline.com/")}function I(a){if("https:"===location.protocol&&
(na(a)||xa(a)))a=a.replace("http:","https:");return a}function oa(a,b,c){var d=[],e;a.displayLevels||(d=n.map(a.resourceInfo.tileInfo.lods,function(a){return a.level}));a.exclusionAreas&&(e=p.clone(a.exclusionAreas),e=n.map(e,function(a){a.geometry=new w(a.geometry);return a}));d=new S(I(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,displayLevels:a.displayLevels||d,id:a.id,minScale:a.minScale,maxScale:a.maxScale,refreshInterval:a.refreshInterval,exclusionAreas:e});c.ignorePopups||
ma(d,a,b,c);return d}function pa(a,b){if(!a||!b||0===b.length)return[];var c=","+b+",",d=[],e,f=",";for(e=0;e<a.length;e++)if(null!==a[e].subLayerIds){if(-1===c.indexOf(","+a[e].id+",")||-1<f.indexOf(","+a[e].id+","))f+=a[e].subLayerIds.toString()+","}else-1<c.indexOf(","+a[e].id+",")&&-1===f.indexOf(","+a[e].id+",")&&d.push(a[e].id);return d}function ya(a,b,c){var d=new ha;d.format="png24";a.resourceInfo&&(a.resourceInfo.supportedImageFormatTypes&&-1<a.resourceInfo.supportedImageFormatTypes.indexOf("PNG32"))&&
(d.format="png32");var d=new T(I(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id,imageParameters:d,minScale:a.minScale,maxScale:a.maxScale,refreshInterval:a.refreshInterval}),e=a.visibleLayers;if(!a.visibleLayers){var f="";n.forEach(d.layerInfos,function(a){a.defaultVisibility&&(f+=(0<f.length?",":"")+a.id)});e=f}if(a.layers&&0<a.layers.length){var g=[],k=[],h,l=[],m,q;n.forEach(a.layers,function(b){b.layerDefinition&&b.layerDefinition.definitionExpression&&(g[b.id]=
b.layerDefinition.definitionExpression);if(b.layerDefinition&&b.layerDefinition.source){h=null;q=b.layerDefinition.source;if("mapLayer"===q.type){var c=n.filter(a.resourceInfo.layers,function(a){return a.id===q.mapLayerId});c.length&&(h=p.mixin(c[0],b))}else h=p.mixin({},b);h&&(h.source=q,delete h.popupInfo,h=new ga(h),a.visibleLayers&&(c="string"==typeof a.visibleLayers?a.visibleLayers.split(","):a.visibleLayers,-1<n.indexOf(c,b.id)?h.defaultVisibility=!0:h.defaultVisibility=!1),k.push(h))}b.layerDefinition&&
(b.layerDefinition.source&&b.layerDefinition.drawingInfo)&&(m=new L(b.layerDefinition.drawingInfo),l[b.id]=m)},this);0<g.length&&d.setLayerDefinitions(g);0<k.length?(d.setDynamicLayerInfos(k,!0),0<l.length&&d.setLayerDrawingOptions(l,!0)):(e=pa(d.layerInfos,e),d.setVisibleLayers(e))}else e=pa(d.layerInfos,e),d.setVisibleLayers(e);c.ignorePopups||ma(d,a,b,c);return d}function Oa(a,b,c){var d=new O;d.bandIds=a.bandIds;null!=a.format&&(d.format=a.format,null!=a.compressionQuality&&(d.compressionQuality=
a.compressionQuality));if(a.renderingRule&&a.renderingRule.rasterFunction){var e=new ia(a.renderingRule);d.renderingRule=e}a.mosaicRule&&(e=new ja(a.mosaicRule),d.mosaicRule=e);k.isDefined(a.noData)&&(d.noData=a.noData);k.isDefined(a.noDataInterpretation)&&(d.noDataInterpretation=a.noDataInterpretation);k.isDefined(a.interpolation)&&(d.interpolation=a.interpolation);d=new G(I(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id,imageServiceParameters:d,minScale:a.minScale,
maxScale:a.maxScale,refreshInterval:a.refreshInterval});a.layerDefinition&&a.layerDefinition.definitionExpression&&d.setDefinitionExpression(a.layerDefinition.definitionExpression,!0);!c.ignorePopups&&a.popupInfo&&d.setInfoTemplate(new b(a.popupInfo));return d}function ra(a,b,c){var e=[102113,102100,3857],f=c||new d(b[0].layerObject.fullExtent.spatialReference),g=new d(a.resourceInfo.fullExtent.spatialReference);return f.wkt==g.wkt&&(f.wkid==g.wkid||k.isDefined(f.latestWkid)&&f.latestWkid==g.wkid||
k.isDefined(g.latestWkid)&&f.wkid==g.latestWkid||k.isDefined(f.latestWkid)&&f.latestWkid==g.latestWkid)||f.wkid&&g.wkid&&n.some(e,function(a){return a===g.wkid})&&n.some(e,function(a){return a===f.wkid})?!0:!1}function sa(a,b){if(!b[0].layerObject.tileInfo)return!1;var d=[];n.forEach(b,function(a){a.baseMapLayer&&a.layerObject.tileInfo&&(d=d.concat(n.map(a.layerObject.tileInfo.lods,function(a){return a.scale})))});return n.some(a.resourceInfo.tileInfo.lods,function(a){return n.some(d,function(b){return b===
a.scale})})}function ta(a,b,c,f,g){var h,l=c._clazz;if("OpenStreetMap"===a.type)h=new K({id:a.id,opacity:a.opacity,visible:null!==a.visibility&&void 0!==a.visibility?a.visibility:!0});else if("WMS"===a.type){var q=[],s=[];n.forEach(a.layers,function(a){s.push(new ka({name:a.name,title:a.title,legendURL:a.legendURL}));q.push(a.name)},this);a.visibleLayers&&(q=a.visibleLayers);f={extent:new w(a.extent[0][0],a.extent[0][1],a.extent[1][0],a.extent[1][1],new d({wkid:4326})),layerInfos:s,version:a.version,
maxWidth:a.maxWidth,maxHeight:a.maxHeight,getMapURL:a.mapUrl,spatialReferences:a.spatialReferences,title:a.title,copyright:a.copyright,minScale:a.minScale||0,maxScale:a.maxScale||0,format:a.format};h=new ba(a.url,{id:a.id,visibleLayers:q,format:"png",transparent:a.baseMapLayer?!1:!0,opacity:a.opacity,visible:null!==a.visibility?a.visibility:!0,resourceInfo:f,refreshInterval:a.refreshInterval});h.spatialReference.wkid=f.spatialReferences[0]}else if("KML"===a.type){c=a.url;if(e.id&&(l=e.id.findCredential(t.urlToObject(B.arcgisUrl).path))){b=
B.arcgisUrl.substring(B.arcgisUrl.indexOf("//")+2,B.arcgisUrl.indexOf("/",B.arcgisUrl.indexOf("//")+3));g=b.split(".");g=g[g.length-2]+"."+g[g.length-1];var u=c.indexOf(g);-1<u&&(c="https://"+b+c.substring(u+g.length));c+="?token\x3d"+l.token}h=new ca(c,{id:a.id,visible:null!==a.visibility?a.visibility:!0,outSR:f,refreshInterval:a.refreshInterval});r.connect(h,"onLoad",function(){(a.opacity||0===a.opacity)&&h.setOpacity(a.opacity);k.isDefined(a.minScale)&&k.isDefined(a.maxScale)&&h.setScaleRange(a.minScale,
a.maxScale);a.visibleFolders&&n.forEach(h.folders,function(b){-1<n.indexOf(a.visibleFolders,b.id)?h.setFolderVisibility(b,!0):h.setFolderVisibility(b,!1)},this)})}else"WebTiledLayer"===a.type?(h=new U(a.templateUrl,{id:a.id,visible:null!==a.visibility?a.visibility:!0,opacity:a.opacity,copyright:a.copyright,fullExtent:a.fullExtent&&new w(a.fullExtent),initialExtent:a.fullExtent&&new w(a.fullExtent),subDomains:a.subDomains,tileInfo:a.tileInfo?new fa(a.tileInfo):null,refreshInterval:a.refreshInterval}),
r.connect(h,"onLoad",function(){(k.isDefined(a.minScale)||k.isDefined(a.maxScale))&&h.setScaleRange(a.minScale,a.maxScale)})):"GeoRSS"===a.type?(h=new da(a.url,{id:a.id,opacity:a.opacity,outSpatialReference:f,refreshInterval:a.refreshInterval}),r.connect(h,"onLoad",function(){!1===a.visibility&&h.hide();k.isDefined(a.minScale)&&k.isDefined(a.maxScale)&&h.setScaleRange(a.minScale,a.maxScale);var b=h.getFeatureLayers();n.forEach(b,function(c){a.pointSymbol&&"esriGeometryPoint"===c.geometryType?(c.renderer.symbol=
C.fromJson(a.pointSymbol),1===b.length&&(h.pointSymbol=C.fromJson(a.pointSymbol))):a.lineSymbol&&"esriGeometryPolyline"===c.geometryType?(c.renderer.symbol=C.fromJson(a.lineSymbol),1===b.length&&(h.polylineSymbol=C.fromJson(a.lineSymbol))):a.polygonSymbol&&"esriGeometryPolygon"===c.geometryType&&(c.renderer.symbol=C.fromJson(a.polygonSymbol),1===b.length&&(h.polygonSymbol=C.fromJson(a.polygonSymbol)))})})):"CSV"==a.type&&a.url?(f={layerDefinition:a.layerDefinition,columnDelimiter:a.columnDelimiter,
id:a.id?a.id:null,visible:null!==a.visibility?a.visibility:!0,opacity:a.opacity,refreshInterval:a.refreshInterval},a.locationInfo&&(f.latitudeFieldName=a.locationInfo.latitudeFieldName,f.longitudeFieldName=a.locationInfo.longitudeFieldName),c.ignorePopups||(f.infoTemplate=new H(a.popupInfo?a.popupInfo:R.generateDefaultPopupInfo(a))),h=new N(a.url,f)):a.layerDefinition&&!a.url?(f=m.fromJson(m.toJson(a)),delete f.id,delete f.opacity,delete f.visibility,h=new E(f,{id:a.id,opacity:a.opacity,visible:a.visibility,
outFields:["*"],autoGeneralize:!0}),!c.ignorePopups&&f.popupInfo&&h.setInfoTemplate(new l(f.popupInfo))):"BingMapsAerial"===a.type||"BingMapsRoad"===a.type||"BingMapsHybrid"===a.type?c.bingMapsKey?(f=F.MAP_STYLE_AERIAL_WITH_LABELS,"BingMapsAerial"===a.type?f=F.MAP_STYLE_AERIAL:"BingMapsRoad"===a.type&&(f=F.MAP_STYLE_ROAD),h=new F({bingMapsKey:c.bingMapsKey,mapStyle:f,opacity:a.opacity,id:a.id}),r.connect(h,"onError",p.hitch(this,function(a){a.errors=a.errors||[];a.errors.push({message:"This application does not have a valid Bing Key for the Bing layer that is included in this map. [type:"+
a.type+"]"})},a))):(a.errors=a.errors||[],a.errors.push({message:"This application does not provide a Bing Key for the Bing layer that is included in this map. [type:"+a.type+"]"})):a.resourceInfo&&a.resourceInfo.mapName?h=!0===a.resourceInfo.singleFusedMapCache&&(a.baseMapLayer||ra(a,b,f)&&sa(a,g))?oa(a,l,c):ya(a,l,c):a.resourceInfo&&a.resourceInfo.pixelSizeX?h=!0===a.resourceInfo.singleFusedMapCache&&(a.baseMapLayer||ra(a,b,f)&&sa(a,g))?oa(a,l,c):Oa(a,l,c):a.resourceInfo&&"Feature Layer"===a.resourceInfo.type&&
(a.capabilities&&(a.resourceInfo.capabilities=a.capabilities),h=new E(I(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id,mode:na(a.url)?E.MODE_AUTO:k.isDefined(a.mode)?a.mode:E.MODE_ONDEMAND,outFields:["*"],autoGeneralize:!0,refreshInterval:a.refreshInterval}),!c.ignorePopups&&a.popupInfo&&h.setInfoTemplate(new l(a.popupInfo)),a.layerDefinition&&(a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.renderer&&(f=y.fromJson(a.layerDefinition.drawingInfo.renderer),
f.isMaxInclusive=!0,h.setRenderer(f)),a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.labelingInfo&&(f=n.map(a.layerDefinition.drawingInfo.labelingInfo,function(a){return new ea(a)}),h.setLabelingInfo(f)),a.layerDefinition.definitionExpression&&h.setDefinitionExpression(a.layerDefinition.definitionExpression),k.isDefined(a.layerDefinition.minScale)&&h.setMinScale(a.layerDefinition.minScale),k.isDefined(a.layerDefinition.maxScale)&&h.setMaxScale(a.layerDefinition.maxScale)));h&&(h.arcgisProps=
{title:a.title},a.baseMapLayer&&(h._basemapGalleryLayerType=a.isReference?"reference":"basemap"));return h}function ua(a,b,c,d){n.forEach(a,function(e,f){if(e.url&&!e.type){if(0===f||a[0].layerObject)e.layerObject=ta(e,a,b,c,d)}else e.layerObject=ta(e,a,b,c,d)});var e=n.filter(a,function(a){return!a.isReference}),f=n.filter(a,function(a){return!!a.isReference});return a=e.concat(f)}function qa(a){var b=null;a=a[0];a.url&&!a.type?a.resourceInfo.spatialReference&&(b=new d,a.resourceInfo.spatialReference.wkid&&
(b.wkid=a.resourceInfo.spatialReference.wkid),a.resourceInfo.spatialReference.wkt&&(b.wkt=a.resourceInfo.spatialReference.wkt)):-1<a.type.indexOf("BingMaps")||"OpenStreetMap"==a.type?b=new d({wkid:102100}):"WMS"==a.type&&(b=new d({wkid:a.spatialReferences[0]}));return b}function za(a,b,c,d,e,f,g){n.forEach(b,function(b,c){b.url&&!b.type&&(b.resourceInfo=a[b.deferredsPos][1],delete b.deferredsPos)});f=f||qa(b);b=ua(b,c,f,g);e.callback(b);return e}function Aa(b,c){var d=I(b);return a({url:d,content:{f:"json"},
callbackParamName:"callback",error:function(a,b){a.message=a.message?a.message+(" [url:"+d+"]"):"[url:"+d+"]";c.push(a);h.defaults.io.errorHandler(a,b)}})}function Ba(b){var c=B.arcgisUrl+"/"+b.itemId+"/data";return a({url:c,content:{f:"json"},callbackParamName:"callback",error:function(a,d){a.message=a.message?a.message+(" [url:"+c+"]"):"[url:"+c+"]";b.errors=b.errors||[];b.errors.push(a);h.defaults.io.errorHandler(a,d)}})}function Ca(a,b,c){var d=new l;if((!c.featureCollection||!c.featureCollection.layers)&&
!c.layers)return console.log("Invalid Feature Collection item data [item id: "+a.itemId+"]: ",c),a.errors=a.errors||[],a.errors.push({message:"Invalid Feature Collection item data. [item id: "+a.itemId+"]"}),d.errback(),d;c.layers&&(c.featureCollection={layers:c.layers},delete c.layers,k.isDefined(c.showLegend)&&(c.featureCollection.showLegend=c.showLegend,delete c.showLegend));Da(a,c.featureCollection,b).then(function(b){c.featureCollection=b;a.featureCollection&&a.featureCollection.layers?n.forEach(c.featureCollection.layers,
function(b,c){var d=a.featureCollection.layers[c];if(!d.poupInfo&&!d.layerDefinition)d.popupInfo=b.popupInfo,d.layerDefinition=b.layerDefinition;else if(d.layerDefinition){if(k.isDefined(d.layerDefinition.minScale)&&k.isDefined(d.layerDefinition.maxScale)&&(d.layerDefinition.minScale!==b.layerDefinition.minScale||d.layerDefinition.maxScale!==b.layerDefinition.maxScale))delete b.layerDefinition.minscale,delete b.layerDefinition.maxScale;d.layerDefinition.drawingInfo&&m.toJson(d.layerDefinition.drawingInfo)!==
m.toJson(b.layerDefinition.drawingInfo)&&delete b.layerDefinition.drawingInfo;d.layerDefinition.showLegend!==b.layerDefinition.showLegend&&delete b.layerDefinition.showLegend;d.layerDefinition=p.mixin(d.layerDefinition,b.layerDefinition)}else d.layerDefinition=b.layerDefinition;d.featureSet=b.featureSet;d.nextObjectId=b.nextObjectId}):(a.featureCollection=a.featureCollection||{},a.featureCollection=p.mixin(a.featureCollection,c.featureCollection));d.callback(a)});return d}function Da(a,b,d){var e=
new l,f=[];n.forEach(b.layers,function(a){a.featureSet&&(a.featureSet.features&&a.featureSet.features.length&&a.featureSet.features[0].geometry&&a.featureSet.features[0].geometry.spatialReference)&&(a.deferredsPos=f.length,f.push(R.projectFeatureCollection(a,d,a.featureSet.features[0].geometry.spatialReference)))});(new c(f)).addCallback(function(){n.forEach(b.layers,function(b){k.isDefined(b.deferredsPos)&&(f[b.deferredsPos].results&&f[b.deferredsPos].results.length?b=f[b.deferredsPos].results[0]:
(console.log("Errors projecting feature collection. ["+a.title+" - "+b.layerDefinition.name+"]"),b.errors=b.errors||[],b.errors.push({message:"Errors projecting feature collection. ["+a.title+" - "+b.layerDefinition.name+"]"})),delete b.deferredsPos)});e.callback(b)});return e}function Y(a,b,d,e){var f=new l,g=new l,h=[],k;n.forEach(a.operationalLayers,function(a){a.itemId&&"Feature Collection"==a.type&&h.push(Ba(a).then(p.hitch(null,Ca,a,d)))});0===h.length?Ea(a,b,d,e,g):(k=new c(h),k.addCallback(function(c){Ea(a,
b,d,e,g)}));g.then(function(a){h=[];n.forEach(a,function(a){a=a.layerObject;if(a instanceof E&&!a.loaded&&!a.loadError){var b=new l;s.once(a,"load, error",function(){b.callback(a)});h.push(b)}});if(h.length){var b=new l;k=new c(h);k.addCallback(function(){b.callback(a)});return b.promise}return a}).then(function(a){var b=[];n.forEach(a,function(a){if(a.layerObject instanceof E){var c=a.layerObject;c.loaded&&(c.labelingInfo&&(a.showLabels||c._collection))&&b.push(c)}});b.length?q(["../layers/LabelLayer"],
function(c){var d=new c;n.forEach(b,function(a){d.addFeatureLayer(a)});a.push({layerObject:d});f.callback(a)}):f.callback(a)});return f}function Ea(a,b,d,e,f){var g=[],h=[],k=[];n.forEach(a.operationalLayers,function(a,b){a.featureCollection?n.forEach(a.featureCollection.layers,function(c,d){var e=!0;a.visibleLayers&&-1==n.indexOf(a.visibleLayers,d)&&(e=!1);c.visibility=a.visibility&&e;c.opacity=a.opacity;c.id=(a.id||"operational"+b)+"_"+d;k.push(c)},this):k.push(a)});n.forEach(a.baseMap.baseMapLayers,
function(a,b){a.baseMapLayer=!0;a.id=a.id||"base"+b;g.push(a)});n.forEach(k,function(a,b){a.id=a.id||"operational"+b;g.push(a)});n.forEach(g,function(a){a.url&&!a.type&&(a.deferredsPos=h.length,a.errors=a.errors||[],h.push(Aa(a.url,a.errors)))});0===h.length?(d=d||qa(g),g=ua(g,b,d,e),f.callback(g)):(new c(h)).addCallback(function(a){za(a,g,b,h,f,d,e)});return f}function Z(a,b,c,d){var e=a.minScale,f=a.maxScale;if(10.1>=c.version&&b)for(a=b.length-1;0<=a;a--){if(b[a].id==d)if(0==e&&0<b[a].minScale?
e=b[a].minScale:0<e&&0==b[a].minScale?e=c.minScale:0<e&&0<b[a].minScale&&(e=Math.min(e,b[a].minScale)),f=Math.max(c.maxScale||0,b[a].maxScale||0),c.setScaleRange(e,f),-1<b[a].parentLayerId)d=b[a].parentLayerId;else break}else 10.1<c.version&&(n.forEach(a.layerInfos,function(a){a.id==d&&(0==e&&0<a.minScale?e=a.minScale:0<e&&0==a.minScale||0<e&&0<a.minScale&&(e=Math.min(e,a.minScale)),f=Math.max(f||0,a.maxScale||0))}),c.setScaleRange(e,f))}function $(a,b,c,d){var e=a.url,f=a.__popupIds,g=a.__popupUrls,
h=a.__popupWhereClauses,l=a.__popupMinScales,m=a.__popupMaxScales,q=a.__resourceInfo,s=[];n.forEach(a.__popups,function(d,p){if(d){var t,va=[];n.forEach(d.fieldInfos,function(a){"shape"!==a.fieldName.toLowerCase()&&va.push(a.fieldName)});if(a.dynamicLayerInfos&&0<a.dynamicLayerInfos.length){var u=n.filter(a.dynamicLayerInfos,function(a){return f[p]==a.id})[0].source;t=new E(e+"/dynamicLayer",{id:a.id+"_"+f[p],source:u,outFields:va,mode:E.MODE_SELECTION,infoTemplate:d&&new c(d),drawMode:!1,visible:a.visible,
autoGeneralize:!0});var v=function(c,d){0<h[c].length&&d.setDefinitionExpression(h[c]);if(!k.isDefined(l[c])&&!k.isDefined(m[c]))Z(a,b||q.layers,d,f[c]);else if(k.isDefined(a.minScale)||k.isDefined(a.maxScale)){var e=a.minScale,g=a.maxScale;0==e&&0<l[c]?e=l[c]:0<e&&0==l[c]||0<e&&0<l[c]&&(e=Math.min(e,l[c]));g=Math.max(g||0,m[c]||0);d.setScaleRange(e,g)}else d.setScaleRange(l[c],m[c])};t.loaded?v(p,t):r.connect(t,"onLoad",function(a){v(p,t)})}else{var w=null,x=e+"/"+f[p];if(g[p].length)x=g[p];else if(b)for(u=
0;u<b.length;u++)if(b[u].id===f[p]){w=b[u];break}t=new E(I(x),{id:a.id+"_"+f[p],outFields:va,mode:E.MODE_SELECTION,infoTemplate:d&&new c(d),drawMode:!1,visible:a.visible,resourceInfo:w,autoGeneralize:!0});t.loaded?(0<h[p].length&&t.setDefinitionExpression(h[p]),Z(a,b||q.layers,t,f[p])):r.connect(t,"onLoad",function(c){0<h[p].length&&t.setDefinitionExpression(h[p]);Z(a,b||q.layers,c,f[p])})}s.push(t)}});0<s.length&&(r.connect(a,"onVisibilityChange",p.hitch(this,function(a,b){n.forEach(a,function(a){b?
a.show():a.hide()})},s)),r.connect(d,"onLayerRemove",p.hitch(this,function(a,b,c){a.id===c.id&&n.forEach(b,function(a){d.removeLayer(a)})},a,s)));delete a.__popups;delete a.__popupIds;delete a.__popupUrls;delete a.__popupWhereClauses;delete a.__popupMinScales;delete a.__popupMaxScales;delete a.__resourceInfo;return s}function Fa(b){return a({url:I(b.url+"/layers"),content:{f:"json"},callbackParamName:"callback",error:function(){}})}function Ga(a,b,d){var e=[];n.forEach(a,function(a){var b=a.__popups;
b&&(1<b.length&&10<=a.version)&&(a.__deferredsPos=e.length,e.push(Fa(a)))});var f=[];0<e.length?(new c(e)).addCallback(function(c){n.forEach(a,function(a){a.__popups&&0<a.__popups.length&&(a.__deferredsPos||0===a.__deferredsPos?(f=f.concat($(a,c[a.__deferredsPos][1].layers,d,b)),delete a.__deferredsPos):f=f.concat($(a,null,d,b)))});b.addLayers(f)}):(n.forEach(a,function(a){a.__popups&&0<a.__popups.length&&(f=f.concat($(a,null,d,b)))}),b.addLayers(f))}function Ha(a){n.forEach(a,function(a){var b=a.layer;
b.toJson&&(a=b.toJson(),a.featureSet&&-1<b.name.indexOf("Text")&&n.forEach(a.featureSet.features,function(a,c){if(a.attributes.TEXT){var d=b.graphics[c];d.symbol.setText(a.attributes.TEXT);a.symbol.horizontalAlignment&&(d.symbol.align=a.symbol.horizontalAlignment);d.setSymbol(d.symbol);d.setAttributes(a.attributes)}},this))})}function Ia(a){var b=6;n.forEach(a,function(a){if(a=a.renderer)"esri.renderer.SimpleRenderer"===a.declaredClass?((a=a.symbol)&&a.xoffset&&(b=Math.max(b,Math.abs(a.xoffset))),
a&&a.yoffset&&(b=Math.max(b,Math.abs(a.yoffset)))):("esri.renderer.UniqueValueRenderer"===a.declaredClass||"esri.renderer.ClassBreaksRenderer"===a.declaredClass)&&n.forEach(a.infos,function(a){(a=a.symbol)&&a.xoffset&&(b=Math.max(b,Math.abs(a.xoffset)));a&&a.yoffset&&(b=Math.max(b,Math.abs(a.yoffset)))})});return b}function wa(a){var b=this,c=b.infoWindow,d=a.graphic;if(b.loaded){c.hide();c.clearFeatures();var e=[];n.forEach(b.graphicsLayerIds,function(a){if((a=b.getLayer(a))&&-1!==a.declaredClass.indexOf("FeatureLayer")&&
a.loaded&&a.visible)a.clearSelection(),a.infoTemplate&&!a.suspended&&e.push(a)});n.forEach(b.layerIds,function(a){(a=b.getLayer(a))&&(-1!==a.declaredClass.indexOf("ArcGISImageServiceLayer")&&a.loaded&&a.visible&&a.infoTemplate)&&e.push(a)});d=d&&d.getInfoTemplate()?d:null;if(e.length||d){var f=Ia(e),g=a.screenPoint,h=b.toMap(new u(g.x-f,g.y+f)),f=b.toMap(new u(g.x+f,g.y-f)),h=new w(h.x,h.y,f.x,f.y,b.spatialReference),k=new x;k.geometry=h;k.timeExtent=b.timeExtent;var m=!0,h=n.map(e,function(b){var c;
-1!==b.declaredClass.indexOf("ArcGISImageServiceLayer")?(k.geometry=a.mapPoint,m=!1,c=b.queryVisibleRasters(k,{rasterAttributeTableFieldPrefix:"Raster.",returnDomainValues:!0}),c.addCallback(function(){return b.getVisibleRasters()})):(c=b.selectFeatures(k),c.addCallback(function(){return b.getSelectedFeatures()}));return c});d&&(f=new l,f.callback([d]),h.splice(0,0,f));if(!n.some(h,function(a){return-1===a.fired})){var p=d?1:0;n.forEach(e,function(a){p=-1!==a.declaredClass.indexOf("ArcGISImageServiceLayer")?
p+a.getVisibleRasters().length:p+a.getSelectedFeatures().length});if(!p)return}c.setFeatures(h);c.show(a.mapPoint,{closestFirst:m})}}}function Pa(a,c){var d=c.mapOptions||{},e;d.infoWindow||(e=new A({visibleWhenEmpty:!1},g.create("div")),d.infoWindow=e);!k.isDefined(d.showInfoWindowOnClick)&&!c.usePopupManager&&(d.showInfoWindowOnClick=!1);d=new b(a,d);r.connect(d,"onLayersAddResult",Ha);return d}function J(a,b,c,d,e,f){var g,h,k,l;d.map?(g=d.map,h=d.clickEventHandle,k=d.clickEventListener,l=d.errors):
(g=Pa(d,e),!e.ignorePopups&&(!e.disableClickBehavior&&!e.usePopupManager)&&(h=r.connect(g,"onClick",wa),k=wa));g.addLayers(a);!e.ignorePopups&&!e.usePopupManager&&Ga(a,g,e._clazz);var m=l||[];n.forEach(b,function(a){a.errors&&(m=m.concat(a.errors))},this);g.loaded?f.callback({map:g,itemInfo:c,errors:m,clickEventHandle:h,clickEventListener:k}):r.connect(g,"onLoad",function(){f.callback({map:g,itemInfo:c,errors:m,clickEventHandle:h,clickEventListener:k})})}function aa(a,b,c,d,e){var f=[];n.forEach(e,
function(a){p.isArray(a.layerObject)?n.forEach(a.layerObject,function(a){f.push(a)}):f.push(a.layerObject)});if("BingMapsAerial"===e[0].type||"BingMapsRoad"===e[0].type||"BingMapsHybrid"===e[0].type)var g=setInterval(function(){if(e[0].layerObject&&e[0].layerObject.loaded)clearInterval(g),Ja(a,b,c,d,e,f);else if(e[0].errors){clearInterval(g);var h="";e[0].errors&&e[0].errors.length&&(h=" ("+e[0].errors[0].message+")");d.errback(Error(P.arcgis.utils.baseLayerError+h))}},10);else if(!f[0]&&e[0].baseMapLayer){var h=
"";e[0].errors&&e[0].errors.length&&(h=" ("+e[0].errors[0].message+")");d.errback(Error(P.arcgis.utils.baseLayerError+h))}else Ja(a,b,c,d,e,f)}function Ja(a,b,c,e,f,g){try{var l=c.mapOptions||{};c.mapOptions=l;var m=a.item;g=n.filter(g,k.isDefined);if(m)if(m.extent&&m.extent.length)if(l.extent)J(g,f,a,b,c,e);else{var p=new w(m.extent[0][0],m.extent[0][1],m.extent[1][0],m.extent[1][1],new d({wkid:4326})),q=g[0].spatialReference;4326===q.wkid?(l.extent=p,J(g,f,a,b,c,e)):102100===q.wkid||102113===q.wkid||
3857===q.wkid?(p.xmin=Math.max(p.xmin,-180),p.xmax=Math.min(p.xmax,180),p.ymin=Math.max(p.ymin,-89.99),p.ymax=Math.min(p.ymax,89.99),l.extent=v.geographicToWebMercator(p),J(g,f,a,b,c,e)):c.geometryServiceURL||h.defaults.geometryService?(c.geometryServiceURL?new D(c.geometryServiceURL):h.defaults.geometryService).project([p],q,function(d){d=d[0];l.extent=l.extent||d;J(g,f,a,b,c,e)},function(){J(g,f,a,b,c,e)}):e.errback(Error(P.arcgis.utils.geometryServiceError))}else J(g,f,a,b,c,e);else J(g,f,a,b,
c,e)}catch(r){e.errback(r)}}function Ka(a){var b=[];a=a.baseMap.baseMapLayers.concat(a.operationalLayers);n.forEach(a,function(a,c){var d={};if(a.featureCollection&&"CSV"!==a.type)!0===a.featureCollection.showLegend&&n.forEach(a.featureCollection.layers,function(c){!1!==c.showLegend&&(d={layer:c.layerObject,title:a.title,defaultSymbol:c.renderer&&c.renderer.defaultSymbol&&c.renderer.defaultLabel?!0:!1},1<a.featureCollection.layers.length&&(d.title+=" - "+c.layerDefinition.name),b.push(d))});else if(a.baseMapLayer&&
!0===a.showLegend&&a.layerObject||!a.baseMapLayer&&!1!==a.showLegend&&a.layerObject){var e=a.layerObject.renderer,e=!e||e&&e.defaultSymbol&&e.defaultLabel?!0:!1;if(10.1>a.layerObject.version&&(a.layerObject instanceof T||a.layerObject instanceof S)||a.layerObject instanceof G)e=!0;d={layer:a.layerObject,title:a.title,defaultSymbol:e};a.layers&&(e=n.map(n.filter(a.layers,function(a){return!1===a.showLegend}),function(a){return a.id}),e.length&&(d.hideLayers=e));b.push(d)}});return b}function La(a,
b,c,d){Na(d,b).then(function(b){var d=b[0],e=b[1];if(!d.itemData.operationalLayers||0===d.itemData.operationalLayers.length)V(d,e).addCallback(function(b){Y(b.itemData,e).addCallback(p.hitch(null,aa,b,a,e,c))});else{var f=new l,g=d.itemData.baseMap.baseMapLayers.slice(0),h=n.filter(d.itemData.baseMap.baseMapLayers,function(a){return!a.isReference});b={item:d.item,itemData:{baseMap:{baseMapLayers:h}}};d.itemData.baseMap.baseMapLayers=n.filter(d.itemData.baseMap.baseMapLayers,function(a){return a.isReference});
V(b,e).addCallback(function(b){Y(b.itemData,e).addCallback(p.hitch(null,aa,b,a,e,f))});f.then(function(a){V(d,e).addCallback(function(b){Y(b.itemData,e,a.map.spatialReference,h).addCallback(function(d){b.itemData.baseMap.baseMapLayers=g;aa(b,a,e,c,d)})})},p.hitch(c,c.errback))}})}function Ma(b){B._arcgisUrl&&0<B._arcgisUrl.length&&(B.arcgisUrl=B._arcgisUrl);var c=B.arcgisUrl+"/"+b,d={},e=new l;a({url:c,content:{f:"json"},callbackParamName:"callback",load:function(b){d.item=b;a({url:c+"/data",content:{f:"json"},
callbackParamName:"callback",load:function(a){d.itemData=a;e.callback(d)},error:function(a){e.errback(a)}})},error:function(a){e.errback(a)}});return e}String.prototype.endsWith=function(a){return this.match(a+"$")==a};var B;B={arcgisUrl:location.protocol+"//www.arcgis.com/sharing/rest/content/items",getItem:Ma,createMap:function(a,b,c){var d=new l;c=c||{};var e=c.infoTemplateClass;c._clazz=e&&(p.isObject(e)?e:p.getObject(e))||H;p.isString(a)?Ma(a).addCallback(p.hitch(null,La,b,c,d)).addErrback(p.hitch(d,
d.errback)):La(b,c,d,a);return d},getLegendLayers:function(a){return a&&a.itemInfo&&a.itemInfo.itemData?Ka(a.itemInfo.itemData):[]},_arcgisUrl:null,_getItemProps:V,_getItemData:M,_getBingKey:Q,_portalUrlResponse:la,_portalUrlFailure:W,_processFSItemProperties:z,_getLayers:Y,_preBuildLayerObjects:za,_buildLayerObjects:ua,_preCreateMap:aa,_getMapSR:qa,_createMap:J,_addSelectionLayers:Ga,_createSelectionFeatureLayers:$,_getServiceInfo:Aa,_getFeatureCollectionItem:Ba,_mergeFeatureCollectionItem:Ca,_projectFeatureCollection:Da,
_getLayersInfo:Fa,_initLayer:ta,_loadAsCached:oa,_loadAsDynamic:ya,_processPopups:ma,_onLayersAddResult:Ha,_sameSpatialReferenceAsBasemap:ra,_sameTilingSchemeAsBasemap:sa,_showPopup:wa,_calculateClickTolerance:Ia,_getVisibleFeatureLayers:pa,_updateLayerScaleInfo:Z,_checkUrl:I,_isHostedService:na,_isAgolService:xa,_getLegendLayers:Ka};p.setObject("arcgis.utils",B,e);return B});